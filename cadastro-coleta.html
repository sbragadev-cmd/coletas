<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recicla Bonja ‚Ä¢ Cadastro de Coletas Seletivas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: { soft: "0 14px 40px rgba(13,59,102,.14)" }
        }
      }
    }
  </script>

  <style>
    .bg-mesh{
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,175,143,.25), transparent 55%),
        radial-gradient(780px 520px at 88% 12%, rgba(242,201,76,.22), transparent 56%),
        radial-gradient(900px 600px at 70% 88%, rgba(13,59,102,.14), transparent 58%),
        linear-gradient(135deg, #0D3B66 0%, #1B7F5A 55%, #4CAF8F 100%);
    }
    .glass{
      background: rgba(255,255,255,.88);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.55);
    }
    .focus-ring:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(27,127,90,.16);
      border-color: rgba(27,127,90,.45);
    }
    .req::after{ content:" *"; color:#dc2626; font-weight:800; }
    .chip{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .chip:hover{ background:rgba(0,0,0,.03); }
    .chip.selected{
      border-color: rgba(27,127,90,.35);
      box-shadow: 0 0 0 4px rgba(27,127,90,.10);
    }
    .panel{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
    }
    .hiddenX{ display:none !important; }
    .fileHint{ font-size: 12px; color: rgba(46,46,46,.65); }
    .line { border-top: 1px dashed rgba(0,0,0,.12); }
  </style>
</head>

<body class="min-h-screen bg-mesh text-graphite">
  <!-- TOP -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-white/15 border border-white/25 flex items-center justify-center text-white font-extrabold">RB</div>
        <div class="leading-tight">
          <div class="text-white/85 text-xs">vila do futuro</div>
          <div class="text-white text-xl font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-white/75 text-xs">Cadastro de Coletas Seletivas</div>
        </div>
      </div>

      <a href="index.html" class="text-white/90 text-sm font-semibold hover:underline">Voltar ao menu</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-12">
    <section class="glass rounded-3xl shadow-soft overflow-hidden">
      <div class="p-6 sm:p-8 border-b border-black/5 bg-white/60">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-deepBlue">
          Cadastro de Coletas Seletivas
        </h1>
        <p class="mt-2 text-graphite/70">
          Preencha os dados da opera√ß√£o. Campos com <b class="text-red-600">*</b> s√£o obrigat√≥rios.
        </p>
        <div class="mt-3 text-xs text-graphite/60">
          Banco: <span id="dbStatus" class="font-semibold">conectando‚Ä¶</span>
        </div>
      </div>

      <form id="form" class="p-6 sm:p-8 space-y-8">
        <div id="alert" class="hidden rounded-2xl border p-4 text-sm"></div>

        <!-- ======= BASE INFO ======= -->
        <div class="panel p-5 sm:p-6">
          <div class="flex items-start gap-3">
            <div class="mt-1 h-10 w-10 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">üßæ</div>
            <div>
              <h2 class="text-lg font-extrabold text-deepBlue">Informa√ß√µes da opera√ß√£o</h2>
              <p class="text-sm text-graphite/70">Dados base da coleta.</p>
            </div>
          </div>

          <div class="mt-5 grid lg:grid-cols-2 gap-5">
            <!-- 1) Data -->
            <div>
              <label class="text-sm font-semibold req">1) Data da opera√ß√£o</label>
              <input id="opDate" required type="date"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
              <div class="mt-1 text-xs text-graphite/60">
                Exemplo: 7 de janeiro de 2019 (no sistema fica 2019-01-07)
              </div>
            </div>

            <!-- ID / C√≥digo vinculado (para puxar dados do user/condominio) -->
            <div>
              <label class="text-sm font-semibold">C√≥digo/ID do participante ou condom√≠nio (opcional)</label>
              <input id="linkedId" placeholder="Ex.: RB-000123 ou COND-000045"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
              <div class="mt-1 text-xs text-graphite/60">
                Se voc√™ usar no projeto, o dashboard consegue contar participantes por esse ID.
              </div>
            </div>

            <!-- 2) Tipo entrega -->
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold req">2) Tipo de entrega do res√≠duo (marcar apenas uma)</label>
              <div class="mt-3 grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="chip" data-radio="deliveryType" data-value="Coleta domiciliar pelo triciclo">
                  <div class="font-extrabold">Domiciliar (triciclo)</div>
                  <div class="text-xs text-graphite/60">porta a porta</div>
                </div>
                <div class="chip" data-radio="deliveryType" data-value="Coleta condom√≠nio">
                  <div class="font-extrabold">Condom√≠nio</div>
                  <div class="text-xs text-graphite/60">coleta no condom√≠nio</div>
                </div>
                <div class="chip" data-radio="deliveryType" data-value="Entrega volunt√°ria">
                  <div class="font-extrabold">Entrega volunt√°ria</div>
                  <div class="text-xs text-graphite/60">ponto de entrega</div>
                </div>
                <div class="chip" data-radio="deliveryType" data-value="Coleta Com√©rcio">
                  <div class="font-extrabold">Com√©rcio</div>
                  <div class="text-xs text-graphite/60">coleta em com√©rcio</div>
                </div>
              </div>
            </div>

            <!-- 3) fluxo -->
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold req">3) Selecionar uma op√ß√£o</label>
              <div class="mt-3 grid sm:grid-cols-2 gap-3">
                <div class="chip" data-radio="flowType" data-value="recebimento">
                  <div class="font-extrabold">Recebimento de res√≠duo</div>
                  <div class="text-xs text-graphite/60">vai para a pergunta 4</div>
                </div>
                <div class="chip" data-radio="flowType" data-value="final_turno">
                  <div class="font-extrabold">Registro final do turno</div>
                  <div class="text-xs text-graphite/60">pula para a pergunta 12</div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 line"></div>

          <div class="mt-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
            <div class="text-xs text-graphite/60">
              Dica: selecione o tipo de fluxo para liberar os campos espec√≠ficos.
            </div>

            <div class="flex gap-3">
              <button type="button" id="btnPreview"
                class="px-5 py-3 rounded-xl bg-white border border-black/10 text-graphite font-semibold hover:bg-black/5 transition">
                Pr√©via
              </button>
              <button type="submit" id="btnSubmit"
                class="px-6 py-3 rounded-xl bg-regen text-white font-extrabold hover:brightness-95 transition shadow-soft">
                Salvar coleta
              </button>
            </div>
          </div>
        </div>

        <!-- ======= RECEBIMENTO (4-11) ======= -->
        <div id="secRecebimento" class="panel p-5 sm:p-6 hiddenX">
          <div class="flex items-start gap-3">
            <div class="mt-1 h-10 w-10 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">üì•</div>
            <div>
              <h2 class="text-lg font-extrabold text-deepBlue">RECEBIMENTO DE RES√çDUO</h2>
              <p class="text-sm text-graphite/70">Perguntas 4 a 11</p>
            </div>
          </div>

          <div class="mt-5 grid lg:grid-cols-2 gap-5">
            <!-- 4) codigo fam√≠lia/cond -->
            <div>
              <label class="text-sm font-semibold">4) C√≥digo da Fam√≠lia / Condom√≠nio</label>
              <input id="codigoFamilia" placeholder="C√≥digo gerado por outra planilha"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
              <div class="mt-1 text-xs text-graphite/60">Se n√£o tiver, pode deixar em branco.</div>
            </div>

            <!-- 5) peso res√≠duo seco -->
            <div>
              <label class="text-sm font-semibold req">5) Peso do res√≠duo seco (kg)</label>
              <input id="pesoResiduoSecoKg" type="number" step="0.01" min="0" placeholder="Ex.: 12,5"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
            </div>

            <!-- 6) qualidade -->
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold req">6) Nota para a qualidade do res√≠duo</label>
              <div class="mt-3 flex flex-col sm:flex-row sm:items-center gap-3">
                <div class="text-xs font-bold text-red-600">SUJO</div>
                <div class="flex gap-3">
                  <div class="chip px-5 py-3" data-radio="qualidadeNota" data-value="1">1</div>
                  <div class="chip px-5 py-3" data-radio="qualidadeNota" data-value="2">2</div>
                  <div class="chip px-5 py-3" data-radio="qualidadeNota" data-value="3">3</div>
                </div>
                <div class="text-xs font-bold text-regen">LIMPO</div>
              </div>
            </div>

            <!-- 7) observa√ß√£o -->
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold">7) Observa√ß√£o</label>
              <textarea id="observacao" rows="3" placeholder="Ex.: material misturado, sacaria inadequada, etc."
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"></textarea>
            </div>

            <!-- 8) rejeito -->
            <div>
              <label class="text-sm font-semibold req">8) Peso do rejeito (kg)</label>
              <input id="pesoRejeitoKg" type="number" step="0.01" min="0" value="0"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
              <div class="mt-1 text-xs text-graphite/60">Se n√£o houver rejeito, colocar ZERO.</div>
            </div>

            <!-- 9) n√£o comercializado -->
            <div>
              <label class="text-sm font-semibold req">9) Peso n√£o comercializado (kg)</label>
              <input id="pesoNaoComercializadoKg" type="number" step="0.01" min="0" value="0"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
              <div class="mt-1 text-xs text-graphite/60">Se n√£o houver, colocar ZERO.</div>
            </div>

            <!-- 10) fotos res√≠duo -->
            <div>
              <label class="text-sm font-semibold">10) Fotos do res√≠duo</label>
              <input id="fotosResiduo" type="file" accept="image/*" multiple
                class="mt-2 w-full" />
              <div class="fileHint mt-1">Arquivos enviados: <span id="fotosResiduoCount">0</span></div>
            </div>

            <!-- 11) fotos rejeito -->
            <div>
              <label class="text-sm font-semibold">11) Fotos do n√£o comercializado e rejeito</label>
              <input id="fotosRejeito" type="file" accept="image/*" multiple
                class="mt-2 w-full" />
              <div class="fileHint mt-1">Arquivos enviados: <span id="fotosRejeitoCount">0</span></div>
            </div>
          </div>
        </div>

        <!-- ======= FINAL DO TURNO (12-23) ======= -->
        <div id="secFinalTurno" class="panel p-5 sm:p-6 hiddenX">
          <div class="flex items-start gap-3">
            <div class="mt-1 h-10 w-10 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">üßÆ</div>
            <div>
              <h2 class="text-lg font-extrabold text-deepBlue">REGISTRO DE RES√çDUOS FINAL DO TURNO</h2>
              <p class="text-sm text-graphite/70">Perguntas 12 a 23</p>
            </div>
          </div>

          <div class="mt-5 grid lg:grid-cols-2 gap-5">
            <!-- 12) c√≥digo condom√≠nio -->
            <div>
              <label class="text-sm font-semibold">12) C√≥digo do condom√≠nio (se for registro condom√≠nio)</label>
              <input id="codigoCondominio" placeholder="Ex.: COND-000045"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
            </div>

            <!-- 13) rejeito geral -->
            <div>
              <label class="text-sm font-semibold req">13) 2.1 Peso do rejeito geral (kg)</label>
              <input id="pesoRejeitoGeralKg" type="number" step="0.01" min="0" placeholder="Ex.: 25"
                class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
            </div>

            <!-- 14-21 materiais -->
            <div class="lg:col-span-2">
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label class="text-sm font-semibold">14) 2.2 Pl√°stico (kg)</label>
                  <input id="plasticoKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">15) 2.3 Papel misto (kg)</label>
                  <input id="papelMistoKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">16) 2.4 Papel√£o (kg)</label>
                  <input id="papelaoKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">17) 2.5 Alum√≠nio/Metal (kg)</label>
                  <input id="aluminioMetalKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">18) 2.6 Vidro (kg)</label>
                  <input id="vidroKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">19) 2.7 Sacaria/Sacolinha (kg)</label>
                  <input id="sacariaKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">20) 2.8 Isopor (kg)</label>
                  <input id="isoporKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
                <div>
                  <label class="text-sm font-semibold">21) 2.9 √ìleo (kg)</label>
                  <input id="oleoKg" type="number" step="0.01" min="0" value="0"
                    class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white" />
                </div>
              </div>
            </div>

            <!-- 22) extras -->
            <div class="lg:col-span-2">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <label class="text-sm font-semibold">22) Materiais extras (nome + peso)</label>
                  <div class="text-xs text-graphite/60">Adicione quantos materiais precisar.</div>
                </div>
                <button type="button" id="btnAddExtra"
                  class="px-4 py-2 rounded-xl bg-white border border-black/10 font-semibold hover:bg-black/5">
                  + Adicionar
                </button>
              </div>

              <div id="extrasWrap" class="mt-3 space-y-2">
                <!-- JS adiciona linhas -->
              </div>
            </div>

            <!-- 23) fotos gerais -->
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold">23) Incluir fotos dos res√≠duos e rejeitos</label>
              <input id="fotosGerais" type="file" accept="image/*" multiple class="mt-2 w-full" />
              <div class="fileHint mt-1">Arquivos enviados: <span id="fotosGeraisCount">0</span></div>
              <div class="mt-2 text-xs text-graphite/60">
                * Nesta vers√£o, as fotos n√£o s√£o enviadas automaticamente ao Storage (salvamos apenas os nomes/metadata).
                Se voc√™ quiser, eu integro com Firebase Storage.
              </div>
            </div>
          </div>
        </div>

        <!-- preview -->
        <pre id="preview" class="hidden rounded-2xl bg-black text-white/90 p-4 text-xs overflow-auto"></pre>
      </form>
    </section>
  </main>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===========================
    // Firebase Config (SEU)
    // ===========================
    const firebaseConfig = {
      apiKey: "AIzaSyAQBmh8uwLTkyabQc_GznBBV1X2dPhActE",
      authDomain: "recicla-bonja.firebaseapp.com",
      projectId: "recicla-bonja",
      storageBucket: "recicla-bonja.firebasestorage.app",
      messagingSenderId: "557210456406",
      appId: "1:557210456406:web:4eebf082cc0d15580c86f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===========================
    // UI / STATE
    // ===========================
    const $ = (id) => document.getElementById(id);
    const alertBox = $("alert");
    const preview = $("preview");

    const state = {
      deliveryType: "",
      flowType: "",
      qualidadeNota: null
    };

    function setDbStatus(text, ok=true){
      const el = $("dbStatus");
      el.textContent = text;
      el.className = ok ? "font-semibold text-regen" : "font-semibold text-red-700";
    }

    function showAlert(type, text) {
      alertBox.classList.remove("hidden");
      alertBox.textContent = text;
      alertBox.className = "rounded-2xl border p-4 text-sm";

      if (type === "ok") alertBox.classList.add("bg-regen/10","border-regen/20","text-regen");
      if (type === "err") alertBox.classList.add("bg-red-50","border-red-200","text-red-700");
      if (type === "info") alertBox.classList.add("bg-blue-50","border-blue-200","text-blue-700");
    }
    function hideAlert(){ alertBox.classList.add("hidden"); }

    function toggleSections(){
      $("secRecebimento").classList.toggle("hiddenX", state.flowType !== "recebimento");
      $("secFinalTurno").classList.toggle("hiddenX", state.flowType !== "final_turno");
    }

    function selectChip(group, value, chipEl){
      document.querySelectorAll(`.chip[data-radio="${group}"]`).forEach(el => el.classList.remove("selected"));
      chipEl.classList.add("selected");

      if(group === "deliveryType") state.deliveryType = value;
      if(group === "flowType") state.flowType = value;
      if(group === "qualidadeNota") state.qualidadeNota = Number(value);

      toggleSections();
      hideAlert();
    }

    document.querySelectorAll(".chip[data-radio]").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        const group = chip.getAttribute("data-radio");
        const value = chip.getAttribute("data-value");
        selectChip(group, value, chip);
      });
    });

    // file counts
    function bindFileCount(inputId, labelId){
      const input = $(inputId);
      const label = $(labelId);
      input.addEventListener("change", ()=> label.textContent = input.files ? input.files.length : 0);
    }
    bindFileCount("fotosResiduo", "fotosResiduoCount");
    bindFileCount("fotosRejeito", "fotosRejeitoCount");
    bindFileCount("fotosGerais", "fotosGeraisCount");

    // ===========================
    // Extras (materiais adicionais)
    // ===========================
    function addExtraRow(name="", kg=""){
      const wrap = $("extrasWrap");
      const row = document.createElement("div");
      row.className = "grid grid-cols-12 gap-2 items-center";
      row.innerHTML = `
        <div class="col-span-7">
          <input class="extraName w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"
                 placeholder="Nome do material (ex.: Tetra Pak)" value="${escapeHtml(name)}"/>
        </div>
        <div class="col-span-4">
          <input class="extraKg w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"
                 type="number" step="0.01" min="0" placeholder="kg" value="${escapeHtml(kg)}"/>
        </div>
        <div class="col-span-1 flex justify-end">
          <button type="button" class="btnRemove px-3 py-2 rounded-xl border border-black/10 hover:bg-black/5">‚úï</button>
        </div>
      `;
      row.querySelector(".btnRemove").addEventListener("click", ()=> row.remove());
      wrap.appendChild(row);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    $("btnAddExtra").addEventListener("click", ()=> addExtraRow());

    // inicia com 1 linha opcional
    addExtraRow();

    // ===========================
    // Payload builder
    // ===========================
    function filesMeta(fileList){
      if(!fileList || !fileList.length) return [];
      return Array.from(fileList).map(f => ({
        name: f.name,
        type: f.type,
        size: f.size,
        lastModified: f.lastModified
      }));
    }

    function buildBase(){
      const opDate = $("opDate").value; // YYYY-MM-DD
      return {
        type: "coletaSeletiva",
        createdAt: serverTimestamp(),
        createdAtISO: new Date().toISOString(),

        opDate,
        deliveryType: state.deliveryType,
        flowType: state.flowType,

        linkedId: ($("linkedId").value || "").trim() || null
      };
    }

    function buildRecebimento(){
      return {
        codigoFamilia: ($("codigoFamilia").value || "").trim() || null,
        pesoResiduoSecoKg: Number($("pesoResiduoSecoKg").value || 0),
        qualidadeNota: state.qualidadeNota ?? null,
        observacao: ($("observacao").value || "").trim() || null,
        pesoRejeitoKg: Number($("pesoRejeitoKg").value || 0),
        pesoNaoComercializadoKg: Number($("pesoNaoComercializadoKg").value || 0),
        fotosResiduo: filesMeta($("fotosResiduo").files),
        fotosRejeito: filesMeta($("fotosRejeito").files),
      };
    }

    function buildFinalTurno(){
      const extras = Array.from(document.querySelectorAll("#extrasWrap > div"))
        .map(row => {
          const name = (row.querySelector(".extraName")?.value || "").trim();
          const kg = Number(row.querySelector(".extraKg")?.value || 0);
          return (name && kg >= 0) ? { name, kg } : null;
        })
        .filter(Boolean);

      return {
        codigoCondominio: ($("codigoCondominio").value || "").trim() || null,
        pesoRejeitoGeralKg: Number($("pesoRejeitoGeralKg").value || 0),

        plasticoKg: Number($("plasticoKg").value || 0),
        papelMistoKg: Number($("papelMistoKg").value || 0),
        papelaoKg: Number($("papelaoKg").value || 0),
        aluminioMetalKg: Number($("aluminioMetalKg").value || 0),
        vidroKg: Number($("vidroKg").value || 0),
        sacariaKg: Number($("sacariaKg").value || 0),
        isoporKg: Number($("isoporKg").value || 0),
        oleoKg: Number($("oleoKg").value || 0),

        materiaisExtras: extras,
        fotosGerais: filesMeta($("fotosGerais").files)
      };
    }

    function validate(){
      const problems = [];

      if(!$("opDate").value) problems.push("Informe a data da opera√ß√£o (obrigat√≥rio).");
      if(!state.deliveryType) problems.push("Selecione o tipo de entrega do res√≠duo (obrigat√≥rio).");
      if(!state.flowType) problems.push("Selecione o tipo de registro (Recebimento ou Final do turno).");

      if(state.flowType === "recebimento"){
        if(!($("pesoResiduoSecoKg").value) || Number($("pesoResiduoSecoKg").value) < 0) problems.push("Informe o peso do res√≠duo seco (kg).");
        if(!(state.qualidadeNota === 1 || state.qualidadeNota === 2 || state.qualidadeNota === 3)) problems.push("Selecione a nota de qualidade (1/2/3).");

        const rej = Number($("pesoRejeitoKg").value || 0);
        const nc = Number($("pesoNaoComercializadoKg").value || 0);
        if(rej < 0) problems.push("Peso do rejeito n√£o pode ser negativo.");
        if(nc < 0) problems.push("Peso n√£o comercializado n√£o pode ser negativo.");
      }

      if(state.flowType === "final_turno"){
        if($("pesoRejeitoGeralKg").value === "" || Number($("pesoRejeitoGeralKg").value) < 0){
          problems.push("Informe o peso do rejeito geral (kg) (obrigat√≥rio).");
        }
      }

      return problems;
    }

    function buildPayload(){
      const base = buildBase();
      const details = (state.flowType === "recebimento") ? buildRecebimento() : buildFinalTurno();
      return { ...base, ...details };
    }

    async function saveToFirestore(payload){
      const ref = await addDoc(collection(db, "coletasSeletivas"), payload);
      return ref.id;
    }

    // ===========================
    // Preview / Submit
    // ===========================
    $("btnPreview").addEventListener("click", ()=>{
      hideAlert();
      const probs = validate();
      if(probs.length){
        preview.classList.add("hidden");
        showAlert("err", "Corrija antes da pr√©via:\n- " + probs.join("\n- "));
        return;
      }
      const payload = buildPayload();
      preview.classList.remove("hidden");
      preview.textContent = JSON.stringify({ ...payload, createdAt: "(serverTimestamp)" }, null, 2);
      showAlert("info", "Pr√©via gerada (ainda n√£o foi salva).");
    });

    $("form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();
      preview.classList.add("hidden");

      const probs = validate();
      if(probs.length){
        showAlert("err", "Corrija antes de salvar:\n- " + probs.join("\n- "));
        return;
      }

      const payload = buildPayload();

      $("btnSubmit").disabled = true;
      $("btnSubmit").textContent = "Salvando‚Ä¶";
      setDbStatus("salvando no Firestore‚Ä¶", true);

      try{
        const id = await saveToFirestore(payload);
        setDbStatus("salvo ‚úÖ", true);
        showAlert("ok", `Coleta salva com sucesso! ID do registro: ${id}`);

        preview.classList.remove("hidden");
        preview.textContent = JSON.stringify({ firestoreDocId: id, ...payload, createdAt: "(serverTimestamp)" }, null, 2);

        // reset
        $("form").reset();
        state.deliveryType = "";
        state.flowType = "";
        state.qualidadeNota = null;
        document.querySelectorAll(".chip.selected").forEach(el=>el.classList.remove("selected"));
        toggleSections();
        $("extrasWrap").innerHTML = "";
        addExtraRow();
        $("fotosResiduoCount").textContent = "0";
        $("fotosRejeitoCount").textContent = "0";
        $("fotosGeraisCount").textContent = "0";

        window.scrollTo({ top: 0, behavior: "smooth" });

      }catch(err){
        console.error(err);
        setDbStatus("erro ao salvar (rules)", false);
        showAlert("err", "N√£o foi poss√≠vel salvar no Firestore. Verifique as regras/permiss√µes e tente novamente.");
      }finally{
        $("btnSubmit").disabled = false;
        $("btnSubmit").textContent = "Salvar coleta";
      }
    });

    // init
    setDbStatus("conectado ‚úÖ", true);
    toggleSections();
  </script>
</body>
</html>