<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recicla Bonja • Cadastro de Coletas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: { soft: "0 14px 40px rgba(13,59,102,.14)" }
        }
      }
    }
  </script>

  <style>
    .bg-mesh{
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,175,143,.25), transparent 55%),
        radial-gradient(780px 520px at 88% 12%, rgba(242,201,76,.22), transparent 56%),
        radial-gradient(900px 600px at 70% 88%, rgba(13,59,102,.14), transparent 58%),
        linear-gradient(135deg, #0D3B66 0%, #1B7F5A 55%, #4CAF8F 100%);
    }
    .glass{
      background: rgba(255,255,255,.86);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.55);
    }
    .focus-ring:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(27,127,90,.16);
      border-color: rgba(27,127,90,.45);
    }
    .req::after{ content:" *"; color:#dc2626; font-weight:700; }
  </style>
</head>

<body class="min-h-screen bg-mesh text-graphite">
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-white/15 border border-white/25 flex items-center justify-center text-white font-extrabold">RB</div>
        <div class="leading-tight">
          <div class="text-white/85 text-xs">vila do futuro</div>
          <div class="text-white text-xl font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-white/75 text-xs">Cadastro de Coletas</div>
        </div>
      </div>

      <a href="index.html" class="text-white/90 text-sm font-semibold hover:underline">Voltar ao menu</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-10">
    <section class="glass rounded-3xl shadow-soft overflow-hidden">
      <div class="p-6 sm:p-8 border-b border-black/5 bg-white/60">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-deepBlue">Cadastro de Coletas</h1>
        <p class="mt-2 text-graphite/70">Agora você pode vincular a coleta a um <b>Usuário (RB-...)</b> ou <b>Condomínio (COND-...)</b> e puxar os dados.</p>
      </div>

      <div class="p-6 sm:p-8 bg-white space-y-6">
        <div id="alert" class="hidden rounded-2xl border p-4 text-sm"></div>

        <!-- VINCULO -->
        <div class="rounded-2xl border border-black/10 bg-grayClean p-5">
          <div class="flex flex-col lg:flex-row lg:items-end gap-4">
            <div class="flex-1">
              <label class="text-sm font-semibold">ID do Usuário/Condomínio (opcional)</label>
              <input id="linkedId" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"
                placeholder="Ex.: RB-000123 ou COND-000045" />
              <div class="text-xs text-graphite/60 mt-1">Se preencher, clique em “Puxar dados” para preencher automaticamente.</div>
            </div>

            <button id="btnFetch" type="button"
              class="px-6 py-3 rounded-xl bg-deepBlue text-white font-extrabold hover:brightness-95 transition shadow-soft">
              Puxar dados
            </button>
          </div>

          <div id="linkedCard" class="hidden mt-4 rounded-2xl bg-white border border-black/10 p-4">
            <div class="text-sm font-extrabold text-deepBlue">Dados encontrados</div>
            <div class="mt-2 text-sm">
              Tipo: <span id="linkedType" class="font-extrabold">—</span><br/>
              Nome: <span id="linkedName" class="font-semibold">—</span><br/>
              Telefone: <span id="linkedPhone" class="font-semibold">—</span><br/>
              Endereço: <span id="linkedAddr" class="font-semibold">—</span>
            </div>
          </div>
        </div>

        <!-- FORM COLETA (modelo mínimo; você pode plugar no seu completo) -->
        <form id="formColeta" class="grid lg:grid-cols-2 gap-6">
          <div>
            <label class="text-sm font-semibold req">Data da operação</label>
            <input id="opDate" type="date" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" />
          </div>

          <div>
            <label class="text-sm font-semibold req">Tipo de entrega do resíduo</label>
            <select id="deliveryType" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white">
              <option value="">Selecione</option>
              <option>Coleta domiciliar pelo triciclo</option>
              <option>Coleta condomínio</option>
              <option>Entrega voluntária</option>
              <option>Coleta Comércio</option>
            </select>
          </div>

          <div class="lg:col-span-2">
            <label class="text-sm font-semibold req">Selecione uma opção</label>
            <div class="mt-2 flex flex-wrap gap-3">
              <label class="flex items-center gap-2 px-4 py-3 rounded-xl border border-black/10 bg-white cursor-pointer">
                <input type="radio" name="flowType" value="recebimento" required>
                <span class="text-sm font-semibold">Recebimento de resíduo</span>
              </label>
              <label class="flex items-center gap-2 px-4 py-3 rounded-xl border border-black/10 bg-white cursor-pointer">
                <input type="radio" name="flowType" value="final_turno" required>
                <span class="text-sm font-semibold">Registro final do turno</span>
              </label>
            </div>
          </div>

          <div class="lg:col-span-2 flex justify-end gap-3">
            <button id="btnSave" type="submit"
              class="px-6 py-3 rounded-xl bg-regen text-white font-extrabold hover:brightness-95 transition shadow-soft">
              Salvar coleta
            </button>
          </div>

          <pre id="preview" class="hidden lg:col-span-2 rounded-2xl bg-black text-white/90 p-4 text-xs overflow-auto"></pre>
        </form>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, addDoc, collection, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // Firebase config (PREENCHA)
    // =========================
 const firebaseConfig = {
  apiKey: "AIzaSyAQBmh8uwLTkyabQc_GznBBV1X2dPhActE",
  authDomain: "recicla-bonja.firebaseapp.com",
  projectId: "recicla-bonja",
  storageBucket: "recicla-bonja.firebasestorage.app",
  messagingSenderId: "557210456406",
  appId: "1:557210456406:web:4eebf082cc0d15580c86f7"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const alertBox = $("alert");
    const linkedCard = $("linkedCard");

    // Guardamos o snapshot encontrado para enviar junto no payload:
    let linkedSnapshot = null; // { type, id, data }

    function showAlert(type, text) {
      alertBox.classList.remove("hidden");
      alertBox.textContent = text;
      alertBox.className = "rounded-2xl border p-4 text-sm";
      if (type === "ok") alertBox.classList.add("bg-regen/10","border-regen/20","text-regen");
      if (type === "err") alertBox.classList.add("bg-red-50","border-red-200","text-red-700");
      if (type === "info") alertBox.classList.add("bg-blue-50","border-blue-200","text-blue-700");
    }

    function getRadio(name){
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : "";
    }

    function normalizeId(v){
      return (v || "").trim().toUpperCase();
    }

    function fillLinkedCard(type, data){
      linkedCard.classList.remove("hidden");
      $("linkedType").textContent = type === "user" ? "Usuário" : "Condomínio";

      if(type === "user"){
        $("linkedName").textContent = data.nomeCompleto || "—";
        $("linkedPhone").textContent = data.telefone || "—";
        $("linkedAddr").textContent = data.enderecoCompleto || (data.condominioId ? `Associado a ${data.condominioId}` : "—");
      }else{
        $("linkedName").textContent = data.nome || "—";
        $("linkedPhone").textContent = data.telefone || "—";
        $("linkedAddr").textContent = data.enderecoCompleto || "—";
      }
    }

    async function fetchLinkedById(id){
      // 1) tenta users/{id}
      const userRef = doc(db, "users", id);
      const uSnap = await getDoc(userRef);
      if(uSnap.exists()){
        return { type:"user", id, data: uSnap.data() };
      }

      // 2) tenta condominios/{id}
      const cRef = doc(db, "condominios", id);
      const cSnap = await getDoc(cRef);
      if(cSnap.exists()){
        return { type:"condominio", id, data: cSnap.data() };
      }

      return null;
    }

    $("btnFetch").addEventListener("click", async () => {
      alertBox.classList.add("hidden");
      linkedCard.classList.add("hidden");
      linkedSnapshot = null;

      const id = normalizeId($("linkedId").value);
      if(!id){
        showAlert("info", "Digite um ID (RB-... ou COND-...) para buscar.");
        return;
      }

      $("btnFetch").disabled = true;
      $("btnFetch").textContent = "Buscando…";

      try{
        const res = await fetchLinkedById(id);
        if(!res){
          showAlert("err", "ID não encontrado em Usuários nem em Condomínios.");
          return;
        }

        linkedSnapshot = res;
        fillLinkedCard(res.type, res.data);
        showAlert("ok", `Dados puxados com sucesso (${res.type === "user" ? "Usuário" : "Condomínio"}).`);
      }catch(err){
        console.error(err);
        showAlert("err", "Erro ao buscar dados. Verifique permissões (rules) e firebaseConfig.");
      }finally{
        $("btnFetch").disabled = false;
        $("btnFetch").textContent = "Puxar dados";
      }
    });

    function buildPayload(){
      const flowType = getRadio("flowType");

      // Aqui você encaixa TODA sua estrutura completa de coletas.
      // Neste exemplo mínimo, já vai o vínculo e o snapshot.
      return {
        type: "coletaSeletiva",
        createdAt: serverTimestamp(),

        opDate: $("opDate").value,              // yyyy-mm-dd
        deliveryType: $("deliveryType").value,
        flowType,

        // vínculo (para “comunicar” com cadastros)
        linkedId: linkedSnapshot?.id || null,
        linkedType: linkedSnapshot?.type || null,
        linkedSnapshot: linkedSnapshot ? {
          // snapshot “enxuto” (evita duplicar dados demais)
          nome: linkedSnapshot.type === "user" ? (linkedSnapshot.data.nomeCompleto || null) : (linkedSnapshot.data.nome || null),
          telefone: linkedSnapshot.data.telefone || null,
          endereco: linkedSnapshot.data.enderecoCompleto || null
        } : null
      };
    }

    $("formColeta").addEventListener("submit", async (e) => {
      e.preventDefault();
      alertBox.classList.add("hidden");

      const payload = buildPayload();

      if(!payload.opDate || !payload.deliveryType || !payload.flowType){
        showAlert("err", "Preencha data, tipo de entrega e selecione a opção (recebimento/final de turno).");
        return;
      }

      // Se quiser obrigar vínculo:
      // if(!payload.linkedId) { showAlert("err","Informe o ID e clique em Puxar dados."); return; }

      $("btnSave").disabled = true;
      $("btnSave").textContent = "Salvando…";

      try{
        const ref = await addDoc(collection(db, "coletasSeletivas"), payload);
        showAlert("ok", `Coleta salva com sucesso! (docId: ${ref.id})`);
        $("preview").classList.remove("hidden");
        $("preview").textContent = JSON.stringify({ docId: ref.id, ...payload, createdAt: "(serverTimestamp)" }, null, 2);

        // reset
        // $("formColeta").reset();
      }catch(err){
        console.error(err);
        showAlert("err", "Erro ao salvar coleta. Verifique permissões (rules) e firebaseConfig.");
      }finally{
        $("btnSave").disabled = false;
        $("btnSave").textContent = "Salvar coleta";
      }
    });
  </script>
</body>
</html>