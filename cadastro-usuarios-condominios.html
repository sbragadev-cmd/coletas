<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recicla Bonja • Cadastro Usuários & Condomínios</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: { soft: "0 14px 40px rgba(13,59,102,.14)" }
        }
      }
    }
  </script>

  <style>
    .bg-mesh{
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,175,143,.25), transparent 55%),
        radial-gradient(780px 520px at 88% 12%, rgba(242,201,76,.22), transparent 56%),
        radial-gradient(900px 600px at 70% 88%, rgba(13,59,102,.14), transparent 58%),
        linear-gradient(135deg, #0D3B66 0%, #1B7F5A 55%, #4CAF8F 100%);
    }
    .glass{
      background: rgba(255,255,255,.86);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.55);
    }
    .focus-ring:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(27,127,90,.16);
      border-color: rgba(27,127,90,.45);
    }
    .tabBtn.active{
      background: rgba(13,59,102,.10);
      border-color: rgba(13,59,102,.25);
      color: #0D3B66;
    }
  </style>
</head>

<body class="min-h-screen bg-mesh text-graphite">
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-white/15 border border-white/25 flex items-center justify-center text-white font-extrabold">RB</div>
        <div class="leading-tight">
          <div class="text-white/85 text-xs">vila do futuro</div>
          <div class="text-white text-xl font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-white/75 text-xs">Cadastro • Usuários & Condomínios</div>
        </div>
      </div>

      <a href="index.html" class="text-white/90 text-sm font-semibold hover:underline">Voltar ao menu</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-10">
    <section class="glass rounded-3xl shadow-soft overflow-hidden">
      <div class="p-6 sm:p-8 border-b border-black/5 bg-white/60">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-deepBlue">Cadastro</h1>
        <p class="mt-2 text-graphite/70">
          Aqui você cria <b>Usuários</b> (ID RB-000xxx) e <b>Condomínios</b> (ID COND-000xxx).
        </p>
      </div>

      <!-- Tabs -->
      <div class="px-6 sm:px-8 pt-6 bg-white/60">
        <div class="flex flex-wrap gap-2">
          <button id="tabUsersBtn" class="tabBtn active px-4 py-2 rounded-xl border border-black/10 bg-white text-sm font-extrabold">Usuários</button>
          <button id="tabCondBtn"  class="tabBtn px-4 py-2 rounded-xl border border-black/10 bg-white text-sm font-extrabold">Condomínios</button>
        </div>
      </div>

      <div class="p-6 sm:p-8 bg-white">
        <!-- Alerts -->
        <div id="alert" class="hidden rounded-2xl border p-4 text-sm mb-6"></div>

        <!-- USERS -->
        <div id="tabUsers" class="space-y-6">
          <div class="rounded-2xl bg-grayClean border border-black/10 p-4">
            <div class="text-sm font-extrabold text-deepBlue">Novo Usuário</div>
            <div class="text-xs text-graphite/60">Ao salvar, será gerado automaticamente um ID do tipo <b>RB-000123</b>.</div>
          </div>

          <form id="formUser" class="grid lg:grid-cols-2 gap-6">
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold">Nome completo</label>
              <input id="u_nome" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Nome completo" />
            </div>

            <div>
              <label class="text-sm font-semibold">Telefone/WhatsApp</label>
              <input id="u_tel" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="(51) 99999-9999" />
            </div>

            <div>
              <label class="text-sm font-semibold">Perfil</label>
              <select id="u_role" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white">
                <option value="">Selecione</option>
                <option value="participante">Participante</option>
                <option value="embaixador">Embaixador</option>
                <option value="cooperativa">Cooperativa</option>
                <option value="gestor">Gestor</option>
                <option value="governanca">Governança</option>
              </select>
            </div>

            <div class="lg:col-span-2">
              <label class="text-sm font-semibold">Condomínio (ID COND-000xxx) – opcional</label>
              <input id="u_condominioId" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Ex.: COND-000012" />
              <div class="text-xs text-graphite/60 mt-1">Se existir, você pode associar o usuário a um condomínio pelo ID.</div>
            </div>

            <div class="lg:col-span-2 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-end">
              <button id="btnUserSave" type="submit"
                class="px-6 py-3 rounded-xl bg-regen text-white font-extrabold hover:brightness-95 transition shadow-soft">
                Salvar usuário
              </button>
            </div>

            <div class="lg:col-span-2">
              <div class="rounded-2xl border border-black/10 bg-white p-4">
                <div class="text-sm font-extrabold text-deepBlue">Último usuário criado</div>
                <div class="mt-2 text-sm">
                  ID: <span id="lastUserId" class="font-extrabold text-regen">—</span>
                </div>
                <div class="text-xs text-graphite/60 mt-1">Use esse ID no cadastro de coletas para puxar os dados automaticamente.</div>
              </div>
            </div>
          </form>
        </div>

        <!-- CONDOMINIOS -->
        <div id="tabCond" class="space-y-6 hidden">
          <div class="rounded-2xl bg-grayClean border border-black/10 p-4">
            <div class="text-sm font-extrabold text-deepBlue">Novo Condomínio</div>
            <div class="text-xs text-graphite/60">Ao salvar, será gerado automaticamente um ID do tipo <b>COND-000123</b>.</div>
          </div>

          <form id="formCond" class="grid lg:grid-cols-2 gap-6">
            <div class="lg:col-span-2">
              <label class="text-sm font-semibold">Nome do condomínio</label>
              <input id="c_nome" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Nome do condomínio" />
            </div>

            <div class="lg:col-span-2">
              <label class="text-sm font-semibold">Endereço completo</label>
              <input id="c_endereco" required class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Rua, número, bairro, cidade, CEP" />
            </div>

            <div>
              <label class="text-sm font-semibold">Ponto de referência</label>
              <input id="c_ref" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Ex.: perto do mercado..." />
            </div>

            <div>
              <label class="text-sm font-semibold">Contato/WhatsApp</label>
              <input id="c_tel" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="(51) 99999-9999" />
            </div>

            <div class="lg:col-span-2 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-end">
              <button id="btnCondSave" type="submit"
                class="px-6 py-3 rounded-xl bg-deepBlue text-white font-extrabold hover:brightness-95 transition shadow-soft">
                Salvar condomínio
              </button>
            </div>

            <div class="lg:col-span-2">
              <div class="rounded-2xl border border-black/10 bg-white p-4">
                <div class="text-sm font-extrabold text-deepBlue">Último condomínio criado</div>
                <div class="mt-2 text-sm">
                  ID: <span id="lastCondId" class="font-extrabold text-deepBlue">—</span>
                </div>
                <div class="text-xs text-graphite/60 mt-1">Use esse ID no cadastro de coletas para vincular coleta ao condomínio.</div>
              </div>
            </div>
          </form>
        </div>

      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, setDoc, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // 1) Firebase config (PREENCHA)
    // =========================
   const firebaseConfig = {
  apiKey: "AIzaSyAQBmh8uwLTkyabQc_GznBBV1X2dPhActE",
  authDomain: "recicla-bonja.firebaseapp.com",
  projectId: "recicla-bonja",
  storageBucket: "recicla-bonja.firebasestorage.app",
  messagingSenderId: "557210456406",
  appId: "1:557210456406:web:4eebf082cc0d15580c86f7"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);
    const alertBox = $("alert");

    function showAlert(type, text) {
      alertBox.classList.remove("hidden");
      alertBox.textContent = text;
      alertBox.className = "rounded-2xl border p-4 text-sm mb-6";
      if (type === "ok") alertBox.classList.add("bg-regen/10","border-regen/20","text-regen");
      if (type === "err") alertBox.classList.add("bg-red-50","border-red-200","text-red-700");
      if (type === "info") alertBox.classList.add("bg-blue-50","border-blue-200","text-blue-700");
    }

    function cleanPhone(v){ return (v || "").replace(/[^\d]/g, ""); }

    function formatCode(prefix, n){
      return `${prefix}-${String(n).padStart(6,"0")}`;
    }

    async function createWithCounter({ counterKey, prefix, collectionName, data }) {
      const counterRef = doc(db, "counters", counterKey);

      const result = await runTransaction(db, async (tx) => {
        const snap = await tx.get(counterRef);
        const current = snap.exists() ? (snap.data().seq || 0) : 0;
        const next = current + 1;

        const code = formatCode(prefix, next);
        const ref = doc(db, collectionName, code);

        tx.set(counterRef, { seq: next, updatedAt: serverTimestamp() }, { merge: true });
        tx.set(ref, {
          ...data,
          code,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });

        return { code, docId: ref.id };
      });

      return result;
    }

    // =========================
    // Tabs
    // =========================
    const tabUsersBtn = $("tabUsersBtn");
    const tabCondBtn  = $("tabCondBtn");
    const tabUsers    = $("tabUsers");
    const tabCond     = $("tabCond");

    function setTab(which){
      const isUsers = which === "users";
      tabUsersBtn.classList.toggle("active", isUsers);
      tabCondBtn.classList.toggle("active", !isUsers);
      tabUsers.classList.toggle("hidden", !isUsers);
      tabCond.classList.toggle("hidden", isUsers);
      alertBox.classList.add("hidden");
    }
    tabUsersBtn.addEventListener("click", () => setTab("users"));
    tabCondBtn.addEventListener("click", () => setTab("cond"));

    // =========================
    // Save User (RB-000xxx) -> users/{code}
    // =========================
    $("formUser").addEventListener("submit", async (e) => {
      e.preventDefault();
      alertBox.classList.add("hidden");

      const nome = $("u_nome").value.trim();
      const tel  = cleanPhone($("u_tel").value);
      const role = $("u_role").value;
      const cond = $("u_condominioId").value.trim() || null;

      if(!nome || !tel || tel.length < 10 || !role){
        showAlert("err", "Preencha nome, telefone (com DDD) e perfil.");
        return;
      }

      $("btnUserSave").disabled = true;
      $("btnUserSave").textContent = "Salvando…";

      try{
        const { code } = await createWithCounter({
          counterKey: "users",
          prefix: "RB",
          collectionName: "users",
          data: {
            type: "user",
            nomeCompleto: nome,
            telefone: tel,
            role,
            condominioId: cond,
            status: "active"
          }
        });

        $("lastUserId").textContent = code;
        showAlert("ok", `Usuário cadastrado com sucesso! ID gerado: ${code}`);
        $("formUser").reset();
      }catch(err){
        console.error(err);
        showAlert("err", "Erro ao salvar usuário. Verifique firebaseConfig e permissões (rules).");
      }finally{
        $("btnUserSave").disabled = false;
        $("btnUserSave").textContent = "Salvar usuário";
      }
    });

    // =========================
    // Save Condomínio (COND-000xxx) -> condominios/{code}
    // =========================
    $("formCond").addEventListener("submit", async (e) => {
      e.preventDefault();
      alertBox.classList.add("hidden");

      const nome = $("c_nome").value.trim();
      const end  = $("c_endereco").value.trim();
      const ref  = $("c_ref").value.trim() || null;
      const tel  = cleanPhone($("c_tel").value) || null;

      if(!nome || !end){
        showAlert("err", "Preencha nome e endereço do condomínio.");
        return;
      }

      $("btnCondSave").disabled = true;
      $("btnCondSave").textContent = "Salvando…";

      try{
        const { code } = await createWithCounter({
          counterKey: "condominios",
          prefix: "COND",
          collectionName: "condominios",
          data: {
            type: "condominio",
            nome,
            enderecoCompleto: end,
            pontoReferencia: ref,
            telefone: tel,
            status: "active"
          }
        });

        $("lastCondId").textContent = code;
        showAlert("ok", `Condomínio cadastrado com sucesso! ID gerado: ${code}`);
        $("formCond").reset();
      }catch(err){
        console.error(err);
        showAlert("err", "Erro ao salvar condomínio. Verifique firebaseConfig e permissões (rules).");
      }finally{
        $("btnCondSave").disabled = false;
        $("btnCondSave").textContent = "Salvar condomínio";
      }
    });
  </script>
</body>
</html>