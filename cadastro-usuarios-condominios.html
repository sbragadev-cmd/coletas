<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recicla Bonja ‚Ä¢ Cadastro de Participantes (Passo a passo)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: { soft: "0 14px 40px rgba(13,59,102,.14)" }
        }
      }
    }
  </script>

  <style>
    .bg-mesh{
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,175,143,.25), transparent 55%),
        radial-gradient(780px 520px at 88% 12%, rgba(242,201,76,.22), transparent 56%),
        radial-gradient(900px 600px at 70% 88%, rgba(13,59,102,.14), transparent 58%),
        linear-gradient(135deg, #0D3B66 0%, #1B7F5A 55%, #4CAF8F 100%);
    }
    .glass{
      background: rgba(255,255,255,.88);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.55);
    }
    .focus-ring:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(27,127,90,.16);
      border-color: rgba(27,127,90,.45);
    }
    .step{ display:none; }
    .step.active{ display:block; }
    .chip{
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .chip:hover{ background:rgba(0,0,0,.03); }
    .chip.selected{
      border-color: rgba(27,127,90,.35);
      box-shadow: 0 0 0 4px rgba(27,127,90,.10);
    }
    .reqDot::after{ content:" *"; color:#dc2626; font-weight:800; }
  </style>
</head>

<body class="min-h-screen bg-mesh text-graphite">
  <header class="max-w-5xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-white/15 border border-white/25 flex items-center justify-center text-white font-extrabold">RB</div>
        <div class="leading-tight">
          <div class="text-white/85 text-xs">vila do futuro</div>
          <div class="text-white text-xl font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-white/75 text-xs">Cadastro de Participantes ‚Ä¢ Passo a passo</div>
        </div>
      </div>
      <a href="index.html" class="text-white/90 text-sm font-semibold hover:underline">Voltar ao menu</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-10">
    <section class="glass rounded-3xl shadow-soft overflow-hidden">
      <div class="p-6 sm:p-8 border-b border-black/5 bg-white/60">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-deepBlue">Cadastro de Participantes</h1>
            <p class="mt-2 text-graphite/70">Responda uma pergunta por vez. Voc√™ s√≥ avan√ßa ap√≥s preencher.</p>
          </div>
          <div class="text-xs text-graphite/70">
            <span class="font-bold">Progresso:</span>
            <span id="progressText">1/9</span>
          </div>
        </div>

        <div class="mt-4 w-full h-2 bg-black/10 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full bg-regen rounded-full" style="width: 11%;"></div>
        </div>

        <div class="mt-3 text-xs text-graphite/60">
          Banco: <span id="dbStatus" class="font-semibold">conectando‚Ä¶</span>
        </div>
      </div>

      <div class="p-6 sm:p-8 bg-white">
        <div id="alert" class="hidden rounded-2xl border p-4 text-sm mb-4"></div>

        <div id="steps">
          <div class="step active" data-step="1">
            <div class="flex items-start gap-3">
              <div class="mt-1 h-10 w-10 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">‚úÖ</div>
              <div>
                <h2 class="text-lg font-extrabold text-deepBlue">Dados Pessoais ‚Ä¢ Declaro estar ciente e autorizo</h2>
                <p class="mt-1 text-sm text-graphite/70">Selecione todos os itens para avan√ßar.</p>
              </div>
            </div>

            <div class="mt-5 space-y-3 text-sm text-graphite/85">
              <label class="flex gap-3"><input id="c1" type="checkbox" class="mt-1">
                <span><b>1.</b> Uso dos meus dados pessoais para fins de organiza√ß√£o e gest√£o do projeto (LGPD).</span>
              </label>
              <label class="flex gap-3"><input id="c2" type="checkbox" class="mt-1">
                <span><b>2.</b> Envio de comunica√ß√µes via WhatsApp (avisos e atividades).</span>
              </label>
              <label class="flex gap-3"><input id="c3" type="checkbox" class="mt-1">
                <span><b>3.</b> Utiliza√ß√£o da minha imagem para divulga√ß√£o e promo√ß√£o do projeto.</span>
              </label>
            </div>
          </div>

          <div class="step" data-step="2">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">1) Nome completo</h2>
            <input id="nome" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Digite seu nome completo"/>
          </div>

          <div class="step" data-step="3">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">2) Voc√™ j√° destina seu res√≠duo recicl√°vel para algum local/catador?</h2>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div class="chip" data-radio="destina" data-value="Sim"><div class="font-extrabold">Sim</div></div>
              <div class="chip" data-radio="destina" data-value="N√£o"><div class="font-extrabold">N√£o</div></div>
            </div>
          </div>

          <div class="step" data-step="4">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">3) Voc√™ tem interesse em participar do projeto com coleta no local?</h2>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div class="chip" data-radio="interesse" data-value="Sim"><div class="font-extrabold">Sim</div></div>
              <div class="chip" data-radio="interesse" data-value="N√£o"><div class="font-extrabold">N√£o</div></div>
            </div>
          </div>

          <div class="step" data-step="5">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">4) Quais limita√ß√µes voc√™ encontra?</h2>
            <textarea id="dificuldades" rows="5" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="Ex.: espa√ßo, tempo, d√∫vidas, sacaria, etc."></textarea>
          </div>

          <div class="step" data-step="6">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">5) Telefone/WhatsApp com DDD</h2>
            <input id="telefone" inputmode="tel" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="(51) 99999-9999"/>
          </div>

          <div class="step" data-step="7">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">6) Local para coleta</h2>
            <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="chip" data-radio="local" data-value="Casa"><div class="font-extrabold">Casa</div></div>
              <div class="chip" data-radio="local" data-value="Condom√≠nio"><div class="font-extrabold">Condom√≠nio</div></div>
              <div class="chip" data-radio="local" data-value="Com√©rcio"><div class="font-extrabold">Com√©rcio</div></div>
              <div class="chip" data-radio="local" data-value="Outro"><div class="font-extrabold">Outro</div></div>
            </div>

            <div id="localOutroWrap" class="mt-4 hidden">
              <label class="text-sm font-semibold reqDot">Descreva (Outro)</label>
              <input id="localOutro" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                placeholder="Ex.: escola, associa√ß√£o, igreja..." />
            </div>
          </div>

          <div class="step" data-step="8">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">7) Endere√ßo completo</h2>
            <input id="endereco" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="Rua, n√∫mero, bairro, cidade/UF e CEP" />
          </div>

          <div class="step" data-step="9">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">8) Ponto de refer√™ncia</h2>
            <input id="referencia" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="Ex.: perto do mercado, em frente √† pra√ßa..." />

            <div class="mt-6 rounded-2xl border border-black/10 bg-grayClean p-4">
              <div class="text-sm font-extrabold text-deepBlue">Mensagem final</div>
              <p class="mt-2 text-sm text-graphite/80">
                Agradecemos por se cadastrar no projeto!<br/>
                Nosso time ir√° analisar as informa√ß√µes e entrar em contato.<br/>
                Obrigada por contribuir! üíö‚ôªÔ∏è
              </p>
            </div>

            <div class="mt-4 text-xs text-graphite/60">
              Ao clicar em <b>Enviar</b>, seu cadastro ser√° salvo no banco e voc√™ receber√° um <b>ID</b>.
            </div>
          </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <button id="btnBack" type="button"
            class="px-5 py-3 rounded-xl bg-white border border-black/10 text-graphite font-semibold hover:bg-black/5 transition">
            Voltar
          </button>

          <div class="flex gap-3">
            <button id="btnPreview" type="button"
              class="px-5 py-3 rounded-xl bg-white border border-black/10 text-graphite font-semibold hover:bg-black/5 transition">
              Pr√©via
            </button>

            <button id="btnNext" type="button"
              class="px-6 py-3 rounded-xl bg-regen text-white font-extrabold hover:brightness-95 transition shadow-soft">
              Next
            </button>
          </div>
        </div>

        <pre id="preview" class="hidden mt-4 rounded-2xl bg-black text-white/90 p-4 text-xs overflow-auto"></pre>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    
const firebaseConfig = {
  apiKey: "AIzaSyAe5E7M8Jednj1xGRjNrV0oD4wQwv6b-WM",
  authDomain: "reciclabonja-3dee7.firebaseapp.com",
  projectId: "reciclabonja-3dee7",
  storageBucket: "reciclabonja-3dee7.firebasestorage.app",
  messagingSenderId: "590941010829",
  appId: "1:590941010829:web:9b8e4703df54cc8b0a9bc4"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TOTAL_STEPS = 9;
    let step = 1;
    let isSubmitting = false;

    const state = {
      consent: { c1:false, c2:false, c3:false },
      nomeCompleto: "",
      jaDestinaReciclavel: "",
      temInteresseProjeto: "",
      dificuldades: "",
      whatsappDDD: "",
      localColeta: "",
      localColetaOutro: "",
      enderecoCompleto: "",
      pontoReferencia: ""
    };

    const $ = (id) => document.getElementById(id);
    const alertBox = $("alert");

    function setDbStatus(text, ok=true){
      const el = $("dbStatus");
      el.textContent = text;
      el.className = ok ? "font-semibold text-regen" : "font-semibold text-red-700";
    }

    function showAlert(type, text) {
      alertBox.classList.remove("hidden");
      alertBox.textContent = text;
      alertBox.className = "rounded-2xl border p-4 text-sm mb-4";
      if (type === "ok") alertBox.classList.add("bg-regen/10","border-regen/20","text-regen");
      if (type === "err") alertBox.classList.add("bg-red-50","border-red-200","text-red-700");
      if (type === "info") alertBox.classList.add("bg-blue-50","border-blue-200","text-blue-700");
    }
    function hideAlert(){ alertBox.classList.add("hidden"); }

    function cleanPhone(v){ return (v || "").replace(/[^\d]/g, ""); }

    function setProgress() {
      $("progressText").textContent = `${step}/${TOTAL_STEPS}`;
      $("progressBar").style.width = `${Math.round((step / TOTAL_STEPS) * 100)}%`;

      const backDisabled = (step === 1 || isSubmitting);
      $("btnBack").disabled = backDisabled;
      $("btnBack").classList.toggle("opacity-60", backDisabled);
      $("btnBack").classList.toggle("cursor-not-allowed", backDisabled);

      $("btnPreview").disabled = isSubmitting;

      $("btnNext").disabled = isSubmitting;
      $("btnNext").classList.toggle("opacity-60", isSubmitting);
      $("btnNext").classList.toggle("cursor-not-allowed", isSubmitting);
      $("btnNext").textContent = (step === TOTAL_STEPS) ? (isSubmitting ? "Enviando‚Ä¶" : "Enviar") : "Next";
    }

    function showStep(n) {
      document.querySelectorAll(".step").forEach(el => el.classList.remove("active"));
      document.querySelector(`.step[data-step="${n}"]`).classList.add("active");
      step = n;
      setProgress();
      hideAlert();
      $("preview").classList.add("hidden");
      setTimeout(() => {
        const active = document.querySelector(".step.active input, .step.active textarea");
        if(active) active.focus();
      }, 30);
    }

    function selectChip(group, value, chipEl) {
      document.querySelectorAll(`.chip[data-radio="${group}"]`).forEach(el => el.classList.remove("selected"));
      chipEl.classList.add("selected");

      if(group === "destina") state.jaDestinaReciclavel = value;
      if(group === "interesse") state.temInteresseProjeto = value;
      if(group === "local") {
        state.localColeta = value;
        $("localOutroWrap").classList.toggle("hidden", value !== "Outro");
        if(value !== "Outro") {
          state.localColetaOutro = "";
          $("localOutro").value = "";
        }
      }
      hideAlert();
    }

    document.querySelectorAll(".chip[data-radio]").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        selectChip(chip.getAttribute("data-radio"), chip.getAttribute("data-value"), chip);
      });
    });

    function readStepIntoState() {
      if(step === 1){
        state.consent.c1 = $("c1").checked;
        state.consent.c2 = $("c2").checked;
        state.consent.c3 = $("c3").checked;
      }
      if(step === 2) state.nomeCompleto = ($("nome").value || "").trim();
      if(step === 5) state.dificuldades = ($("dificuldades").value || "").trim();
      if(step === 6) state.whatsappDDD = cleanPhone($("telefone").value);
      if(step === 7) state.localColetaOutro = ($("localOutro").value || "").trim();
      if(step === 8) state.enderecoCompleto = ($("endereco").value || "").trim();
      if(step === 9) state.pontoReferencia = ($("referencia").value || "").trim();
    }

    function validateCurrentStep() {
      readStepIntoState();
      if(step === 1 && !(state.consent.c1 && state.consent.c2 && state.consent.c3)) return "Marque as 3 autoriza√ß√µes para avan√ßar.";
      if(step === 2 && (!state.nomeCompleto || state.nomeCompleto.length < 3)) return "Informe seu nome completo.";
      if(step === 3 && !state.jaDestinaReciclavel) return "Selecione Sim ou N√£o.";
      if(step === 4 && !state.temInteresseProjeto) return "Selecione Sim ou N√£o.";
      if(step === 5 && (!state.dificuldades || state.dificuldades.length < 3)) return "Descreva suas limita√ß√µes.";
      if(step === 6 && (!state.whatsappDDD || state.whatsappDDD.length < 10)) return "Informe WhatsApp v√°lido com DDD.";
      if(step === 7){
        if(!state.localColeta) return "Selecione o local.";
        if(state.localColeta === "Outro" && (!state.localColetaOutro || state.localColetaOutro.length < 2)) return "Descreva o local (Outro).";
      }
      if(step === 8 && (!state.enderecoCompleto || state.enderecoCompleto.length < 6)) return "Informe o endere√ßo completo.";
      if(step === 9 && (!state.pontoReferencia || state.pontoReferencia.length < 3)) return "Informe o ponto de refer√™ncia.";
      return null;
    }

    function buildPayloadFinal(participantCode){
      return {
        type: "participant_registration",
        createdAtISO: new Date().toISOString(),
        createdAt: serverTimestamp(),
        participantCode, // ID p√∫blico (RB-XXXXXX)
        consent: { dados: state.consent.c1, whatsapp: state.consent.c2, imagem: state.consent.c3 },
        nomeCompleto: state.nomeCompleto,
        jaDestinaReciclavel: state.jaDestinaReciclavel,
        temInteresseProjeto: state.temInteresseProjeto,
        dificuldades: state.dificuldades,
        whatsappDDD: state.whatsappDDD,
        localColeta: state.localColeta,
        localColetaOutro: state.localColeta === "Outro" ? state.localColetaOutro : null,
        enderecoCompleto: state.enderecoCompleto,
        pontoReferencia: state.pontoReferencia,
        status: "pending"
      };
    }

    async function saveParticipant(){
      // 1) cria doc "vazio" para gerar ID
      const tmp = await addDoc(collection(db, "participants"), {
        type: "participant_registration",
        createdAtISO: new Date().toISOString(),
        createdAt: serverTimestamp(),
        participantCode: "RB-TMP",
        consent: { dados:true, whatsapp:true, imagem:true },
        nomeCompleto: "TMP",
        jaDestinaReciclavel: "Sim",
        temInteresseProjeto: "Sim",
        dificuldades: "TMP",
        whatsappDDD: "0000000000",
        localColeta: "Casa",
        localColetaOutro: null,
        enderecoCompleto: "TMP",
        pontoReferencia: "TMP",
        status: "pending"
      });

      // 2) gera c√≥digo p√∫blico baseado no docId
      const code = "RB-" + tmp.id.slice(-6).toUpperCase();

      // 3) regrava doc completo: como n√£o liberamos update nas rules, precisamos criar o doc completo direto.
      // => ent√£o a solu√ß√£o correta √©: n√£o criar "tmp".
      // Para manter 100% compat√≠vel com rules (sem update), vamos:
      // - apagar a ideia de tmp e usar code baseado em random local.
      // (sem backend, √© o melhor caminho com rules travadas)

      // --------
      // Vers√£o FINAL: c√≥digo aleat√≥rio local (n√£o precisa update)
      // --------
      const rand = crypto.getRandomValues(new Uint32Array(1))[0].toString(16).slice(0,6).toUpperCase().padStart(6,"0");
      const participantCode = "RB-" + rand;

      const payload = buildPayloadFinal(participantCode);
      const ref = await addDoc(collection(db, "participants"), payload);
      return { docId: ref.id, participantCode, payload };
    }

    $("btnBack").addEventListener("click", ()=>{
      if(isSubmitting) return;
      if(step > 1) showStep(step - 1);
    });

    $("btnPreview").addEventListener("click", ()=>{
      readStepIntoState();
      const payload = buildPayloadFinal("RB-XXXXXX");
      $("preview").classList.remove("hidden");
      $("preview").textContent = JSON.stringify({ ...payload, createdAt: "(serverTimestamp)" }, null, 2);
      showAlert("info", "Pr√©via gerada (ainda n√£o foi salva).");
    });

    $("btnNext").addEventListener("click", async ()=>{
      if(isSubmitting) return;

      const err = validateCurrentStep();
      if(err){ showAlert("err", err); return; }

      if(step < TOTAL_STEPS){
        showStep(step + 1);
        return;
      }

      isSubmitting = true;
      setProgress();
      hideAlert();

      try{
        setDbStatus("salvando no Firestore‚Ä¶", true);
        const { docId, participantCode, payload } = await saveParticipant();
        setDbStatus("salvo ‚úÖ", true);

        showAlert("ok", `Cadastro enviado! Seu ID do participante √©: ${participantCode}`);
        $("preview").classList.remove("hidden");
        $("preview").textContent = JSON.stringify({ firestoreDocId: docId, ...payload, createdAt: "(serverTimestamp)" }, null, 2);

      }catch(e){
        console.error(e);
        setDbStatus("erro ao salvar (rules)", false);
        showAlert("err", "N√£o foi poss√≠vel salvar. Verifique Firestore Rules e tente novamente.");
      }finally{
        isSubmitting = false;
        setProgress();
      }
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      if(tag === "textarea") return;
      e.preventDefault();
      $("btnNext").click();
    });

    setDbStatus("conectado ‚úÖ", true);
    setProgress();
  </script>
</body>
</html>