<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recicla Bonja ‚Ä¢ Cadastro de Participantes (Passo a passo)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: { soft: "0 14px 40px rgba(13,59,102,.14)" }
        }
      }
    }
  </script>

  <style>
    .bg-mesh{
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,175,143,.25), transparent 55%),
        radial-gradient(780px 520px at 88% 12%, rgba(242,201,76,.22), transparent 56%),
        radial-gradient(900px 600px at 70% 88%, rgba(13,59,102,.14), transparent 58%),
        linear-gradient(135deg, #0D3B66 0%, #1B7F5A 55%, #4CAF8F 100%);
    }
    .glass{
      background: rgba(255,255,255,.88);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.55);
    }
    .focus-ring:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(27,127,90,.16);
      border-color: rgba(27,127,90,.45);
    }
    .step{ display:none; }
    .step.active{ display:block; }
    .chip{
      border:1px solid rgba(0,0,0,.1);
      background:#fff;
      border-radius:14px;
      padding:12px 14px;
      cursor:pointer;
      transition:.15s;
      user-select:none;
    }
    .chip:hover{ background:rgba(0,0,0,.03); }
    .chip.selected{
      border-color: rgba(27,127,90,.35);
      box-shadow: 0 0 0 4px rgba(27,127,90,.10);
    }
    .reqDot::after{ content:" *"; color:#dc2626; font-weight:800; }
  </style>
</head>

<body class="min-h-screen bg-mesh text-graphite">
  <header class="max-w-5xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-white/15 border border-white/25 flex items-center justify-center text-white font-extrabold">RB</div>
        <div class="leading-tight">
          <div class="text-white/85 text-xs">vila do futuro</div>
          <div class="text-white text-xl font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-white/75 text-xs">Cadastro de Participantes ‚Ä¢ Passo a passo</div>
        </div>
      </div>
      <a href="index.html" class="text-white/90 text-sm font-semibold hover:underline">Voltar ao menu</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-10">
    <section class="glass rounded-3xl shadow-soft overflow-hidden">
      <div class="p-6 sm:p-8 border-b border-black/5 bg-white/60">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-deepBlue">Cadastro de Participantes</h1>
            <p class="mt-2 text-graphite/70">Responda uma pergunta por vez. Voc√™ s√≥ avan√ßa ap√≥s preencher.</p>
          </div>
          <div class="text-xs text-graphite/70">
            <span class="font-bold">Progresso:</span>
            <span id="progressText">1/9</span>
          </div>
        </div>

        <div class="mt-4 w-full h-2 bg-black/10 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full bg-regen rounded-full" style="width: 11%;"></div>
        </div>

        <div class="mt-3 text-xs text-graphite/60">
          Banco: <span id="dbStatus" class="font-semibold">conectando‚Ä¶</span>
        </div>
      </div>

      <div class="p-6 sm:p-8 bg-white">
        <div id="alert" class="hidden rounded-2xl border p-4 text-sm mb-4"></div>

        <div id="steps">
          <!-- STEP 1 -->
          <div class="step active" data-step="1">
            <div class="flex items-start gap-3">
              <div class="mt-1 h-10 w-10 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">‚úÖ</div>
              <div>
                <h2 class="text-lg font-extrabold text-deepBlue">Dados Pessoais ‚Ä¢ Declaro estar ciente e autorizo</h2>
                <p class="mt-1 text-sm text-graphite/70">Selecione todos os itens para avan√ßar.</p>
              </div>
            </div>

            <div class="mt-5 space-y-3 text-sm text-graphite/85">
              <label class="flex gap-3"><input id="c1" type="checkbox" class="mt-1">
                <span><b>1.</b> Uso dos meus dados pessoais para fins de organiza√ß√£o e gest√£o do projeto (LGPD).</span>
              </label>
              <label class="flex gap-3"><input id="c2" type="checkbox" class="mt-1">
                <span><b>2.</b> Envio de comunica√ß√µes via WhatsApp (avisos e atividades).</span>
              </label>
              <label class="flex gap-3"><input id="c3" type="checkbox" class="mt-1">
                <span><b>3.</b> Utiliza√ß√£o da minha imagem para divulga√ß√£o e promo√ß√£o do projeto.</span>
              </label>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step" data-step="2">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">1) Nome completo</h2>
            <input id="nome" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Digite seu nome completo"/>
          </div>

          <!-- STEP 3 -->
          <div class="step" data-step="3">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">2) Voc√™ j√° destina seu res√≠duo recicl√°vel para algum local/catador?</h2>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div class="chip" data-radio="destina" data-value="Sim"><div class="font-extrabold">Sim</div></div>
              <div class="chip" data-radio="destina" data-value="N√£o"><div class="font-extrabold">N√£o</div></div>
            </div>
          </div>

          <!-- STEP 4 -->
          <div class="step" data-step="4">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">3) Voc√™ tem interesse em participar do projeto com coleta no local?</h2>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div class="chip" data-radio="interesse" data-value="Sim"><div class="font-extrabold">Sim</div></div>
              <div class="chip" data-radio="interesse" data-value="N√£o"><div class="font-extrabold">N√£o</div></div>
            </div>
          </div>

          <!-- STEP 5 -->
          <div class="step" data-step="5">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">4) Quais limita√ß√µes voc√™ encontra?</h2>
            <textarea id="dificuldades" rows="5" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="Ex.: espa√ßo, tempo, d√∫vidas, sacaria, etc."></textarea>
          </div>

          <!-- STEP 6 -->
          <div class="step" data-step="6">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">5) Telefone/WhatsApp com DDD</h2>
            <input id="telefone" inputmode="tel" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="(51) 99999-9999"/>
            <div class="mt-2 text-xs text-graphite/60">Dica: pode digitar com espa√ßo/tra√ßo que eu limpo automaticamente.</div>
          </div>

          <!-- STEP 7 -->
          <div class="step" data-step="7">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">6) Local para coleta</h2>
            <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="chip" data-radio="local" data-value="Casa"><div class="font-extrabold">Casa</div></div>
              <div class="chip" data-radio="local" data-value="Condom√≠nio"><div class="font-extrabold">Condom√≠nio</div></div>
              <div class="chip" data-radio="local" data-value="Com√©rcio"><div class="font-extrabold">Com√©rcio</div></div>
              <div class="chip" data-radio="local" data-value="Outro"><div class="font-extrabold">Outro</div></div>
            </div>

            <div id="localOutroWrap" class="mt-4 hidden">
              <label class="text-sm font-semibold reqDot">Descreva (Outro)</label>
              <input id="localOutro" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                placeholder="Ex.: escola, associa√ß√£o, igreja..." />
            </div>

            <!-- NOVO: tipo de cadastro (mantendo ficha/est√©tica) -->
            <div class="mt-6 rounded-2xl border border-black/10 bg-grayClean p-4">
              <div class="text-sm font-extrabold text-deepBlue">Tipo de cadastro</div>
              <div class="mt-2 text-sm text-graphite/70">
                Se for <b>Condom√≠nio</b>, o sistema vai gerar um c√≥digo <b>COND-XXXXXX</b>.  
                Caso contr√°rio, gera <b>RB-XXXXXX</b>.
              </div>

              <div class="mt-3 grid sm:grid-cols-2 gap-3">
                <div class="chip" data-radio="tipoCadastro" data-value="participante">
                  <div class="font-extrabold">Participante</div>
                  <div class="text-xs text-graphite/60">RB-XXXXXX</div>
                </div>
                <div class="chip" data-radio="tipoCadastro" data-value="condominio">
                  <div class="font-extrabold">Condom√≠nio</div>
                  <div class="text-xs text-graphite/60">COND-XXXXXX</div>
                </div>
              </div>

              <div id="condWrap" class="mt-4 hidden">
                <label class="text-sm font-semibold reqDot">Nome do condom√≠nio</label>
                <input id="condNome" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                  placeholder="Ex.: Condom√≠nio Jardim Bonja" />
                <div class="mt-2 grid sm:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-semibold">Bloco (opcional)</label>
                    <input id="condBloco" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Ex.: A" />
                  </div>
                  <div>
                    <label class="text-sm font-semibold">Unidade/Apto (opcional)</label>
                    <input id="condUnidade" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring" placeholder="Ex.: 302" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 8 (ENDERE√áO COM CEP) -->
          <div class="step" data-step="8">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">7) Endere√ßo (com CEP)</h2>

            <div class="mt-4 grid sm:grid-cols-3 gap-3">
              <div class="sm:col-span-2">
                <label class="text-sm font-semibold reqDot">CEP</label>
                <div class="mt-1 flex gap-2">
                  <input id="cep" inputmode="numeric" class="flex-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                    placeholder="Ex.: 90010-000" />
                  <button id="btnCep" type="button"
                    class="px-4 py-3 rounded-xl bg-regen text-white font-extrabold hover:brightness-95 transition">
                    Buscar
                  </button>
                </div>
                <div id="cepMsg" class="mt-1 text-xs text-graphite/60"></div>
              </div>

              <div>
                <label class="text-sm font-semibold reqDot">N√∫mero</label>
                <input id="numero" inputmode="numeric" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                  placeholder="Ex.: 123" />
                <div class="mt-1 text-xs text-graphite/60">Usado para achar a localiza√ß√£o no mapa.</div>
              </div>
            </div>

            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm font-semibold reqDot">Rua</label>
                <input id="rua" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                  placeholder="Preenchido pelo CEP" />
              </div>
              <div>
                <label class="text-sm font-semibold reqDot">Bairro</label>
                <input id="bairro" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                  placeholder="Preenchido pelo CEP" />
              </div>
            </div>

            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm font-semibold reqDot">Cidade</label>
                <input id="cidade" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                  placeholder="Preenchido pelo CEP" />
              </div>
              <div>
                <label class="text-sm font-semibold reqDot">UF</label>
                <input id="uf" maxlength="2" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
                  placeholder="Ex.: RS" />
              </div>
            </div>

            <div class="mt-4 rounded-2xl border border-black/10 bg-grayClean p-4">
              <div class="text-sm font-extrabold text-deepBlue">Localiza√ß√£o para o Dashboard</div>
              <div class="mt-1 text-sm text-graphite/70">
                Quando voc√™ busca o CEP e informa o n√∫mero, eu tento gerar a <b>latitude/longitude</b> automaticamente
                para aparecer como ponto no mapa.
              </div>
              <div class="mt-2 text-xs">
                <span class="font-bold">Geo:</span>
                <span id="geoStatus" class="text-graphite/70">ainda n√£o calculado</span>
              </div>
            </div>
          </div>

          <!-- STEP 9 -->
          <div class="step" data-step="9">
            <h2 class="text-lg font-extrabold text-deepBlue reqDot">8) Ponto de refer√™ncia</h2>
            <input id="referencia" class="mt-4 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring"
              placeholder="Ex.: perto do mercado, em frente √† pra√ßa..." />

            <div class="mt-6 rounded-2xl border border-black/10 bg-grayClean p-4">
              <div class="text-sm font-extrabold text-deepBlue">Mensagem final</div>
              <p class="mt-2 text-sm text-graphite/80">
                Agradecemos por se cadastrar no projeto!<br/>
                Nosso time ir√° analisar as informa√ß√µes e entrar em contato.<br/>
                Obrigada por contribuir! üíö‚ôªÔ∏è
              </p>
            </div>

            <div class="mt-4 text-xs text-graphite/60">
              Ao clicar em <b>Enviar</b>, seu cadastro ser√° salvo no banco e voc√™ receber√° um <b>ID</b>.
            </div>
          </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <button id="btnBack" type="button"
            class="px-5 py-3 rounded-xl bg-white border border-black/10 text-graphite font-semibold hover:bg-black/5 transition">
            Voltar
          </button>

          <div class="flex gap-3">
            <button id="btnPreview" type="button"
              class="px-5 py-3 rounded-xl bg-white border border-black/10 text-graphite font-semibold hover:bg-black/5 transition">
              Pr√©via
            </button>

            <button id="btnNext" type="button"
              class="px-6 py-3 rounded-xl bg-regen text-white font-extrabold hover:brightness-95 transition shadow-soft">
              Next
            </button>
          </div>
        </div>

        <pre id="preview" class="hidden mt-4 rounded-2xl bg-black text-white/90 p-4 text-xs overflow-auto"></pre>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAe5E7M8Jednj1xGRjNrV0oD4wQwv6b-WM",
      authDomain: "reciclabonja-3dee7.firebaseapp.com",
      projectId: "reciclabonja-3dee7",
      storageBucket: "reciclabonja-3dee7.firebasestorage.app",
      messagingSenderId: "590941010829",
      appId: "1:590941010829:web:9b8e4703df54cc8b0a9bc4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TOTAL_STEPS = 9;
    let step = 1;
    let isSubmitting = false;

    const state = {
      consent: { c1:false, c2:false, c3:false },
      nomeCompleto: "",
      jaDestinaReciclavel: "",
      temInteresseProjeto: "",
      dificuldades: "",
      whatsappDDD: "",
      localColeta: "",
      localColetaOutro: "",
      tipoCadastro: "",          // "participante" | "condominio"
      condNome: "",
      condBloco: "",
      condUnidade: "",
      endereco: { cep:"", rua:"", numero:"", bairro:"", cidade:"", uf:"" },
      geo: { lat:null, lng:null, provider:"" },
      pontoReferencia: ""
    };

    const $ = (id) => document.getElementById(id);
    const alertBox = $("alert");

    function setDbStatus(text, ok=true){
      const el = $("dbStatus");
      el.textContent = text;
      el.className = ok ? "font-semibold text-regen" : "font-semibold text-red-700";
    }

    function showAlert(type, text) {
      alertBox.classList.remove("hidden");
      alertBox.textContent = text;
      alertBox.className = "rounded-2xl border p-4 text-sm mb-4";
      if (type === "ok") alertBox.classList.add("bg-regen/10","border-regen/20","text-regen");
      if (type === "err") alertBox.classList.add("bg-red-50","border-red-200","text-red-700");
      if (type === "info") alertBox.classList.add("bg-blue-50","border-blue-200","text-blue-700");
    }
    function hideAlert(){ alertBox.classList.add("hidden"); }

    function cleanPhone(v){ return (v || "").replace(/[^\d]/g, ""); }
    function cleanCep(v){ return (v || "").replace(/[^\d]/g, "").slice(0,8); }

    function setGeoStatus(){
      const el = $("geoStatus");
      if(state.geo.lat && state.geo.lng){
        el.textContent = `${state.geo.lat.toFixed(6)}, ${state.geo.lng.toFixed(6)} (${state.geo.provider}) ‚úÖ`;
        el.className = "text-regen font-semibold";
      } else {
        el.textContent = "ainda n√£o calculado";
        el.className = "text-graphite/70";
      }
    }

    function setProgress() {
      $("progressText").textContent = `${step}/${TOTAL_STEPS}`;
      $("progressBar").style.width = `${Math.round((step / TOTAL_STEPS) * 100)}%`;

      const backDisabled = (step === 1 || isSubmitting);
      $("btnBack").disabled = backDisabled;
      $("btnBack").classList.toggle("opacity-60", backDisabled);
      $("btnBack").classList.toggle("cursor-not-allowed", backDisabled);

      $("btnPreview").disabled = isSubmitting;

      $("btnNext").disabled = isSubmitting;
      $("btnNext").classList.toggle("opacity-60", isSubmitting);
      $("btnNext").classList.toggle("cursor-not-allowed", isSubmitting);
      $("btnNext").textContent = (step === TOTAL_STEPS) ? (isSubmitting ? "Enviando‚Ä¶" : "Enviar") : "Next";
    }

    function showStep(n) {
      document.querySelectorAll(".step").forEach(el => el.classList.remove("active"));
      document.querySelector(`.step[data-step="${n}"]`).classList.add("active");
      step = n;
      setProgress();
      hideAlert();
      $("preview").classList.add("hidden");
      setTimeout(() => {
        const active = document.querySelector(".step.active input, .step.active textarea, .step.active button");
        if(active) active.focus();
      }, 30);
    }

    function selectChip(group, value, chipEl) {
      document.querySelectorAll(`.chip[data-radio="${group}"]`).forEach(el => el.classList.remove("selected"));
      chipEl.classList.add("selected");

      if(group === "destina") state.jaDestinaReciclavel = value;
      if(group === "interesse") state.temInteresseProjeto = value;

      if(group === "local") {
        state.localColeta = value;
        $("localOutroWrap").classList.toggle("hidden", value !== "Outro");
        if(value !== "Outro") {
          state.localColetaOutro = "";
          $("localOutro").value = "";
        }
        // Se a pessoa marcar "Condom√≠nio", pr√©-seleciona tipoCadastro = condominio (sem for√ßar, mas ajuda)
        if(value === "Condom√≠nio" && !state.tipoCadastro){
          // marca chip visual
          const chipCond = document.querySelector(`.chip[data-radio="tipoCadastro"][data-value="condominio"]`);
          if(chipCond) chipCond.click();
        }
      }

      if(group === "tipoCadastro"){
        state.tipoCadastro = value; // participante|condominio
        $("condWrap").classList.toggle("hidden", value !== "condominio");
        if(value !== "condominio"){
          state.condNome = ""; state.condBloco = ""; state.condUnidade = "";
          $("condNome").value = "";
          $("condBloco").value = "";
          $("condUnidade").value = "";
        }
      }

      hideAlert();
    }

    document.querySelectorAll(".chip[data-radio]").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        selectChip(chip.getAttribute("data-radio"), chip.getAttribute("data-value"), chip);
      });
    });

    // ===== CEP lookup (ViaCEP + fallback BrasilAPI) =====
    async function lookupCEP(cep8){
      // 1) ViaCEP
      try{
        const r = await fetch(`https://viacep.com.br/ws/${cep8}/json/`, { cache:"no-store" });
        const j = await r.json();
        if(j && !j.erro){
          return {
            provider: "viacep",
            rua: j.logradouro || "",
            bairro: j.bairro || "",
            cidade: j.localidade || "",
            uf: j.uf || ""
          };
        }
      }catch(e){}

      // 2) BrasilAPI fallback
      try{
        const r = await fetch(`https://brasilapi.com.br/api/cep/v1/${cep8}`, { cache:"no-store" });
        if(!r.ok) throw new Error("brasilapi not ok");
        const j = await r.json();
        return {
          provider: "brasilapi",
          rua: j.street || "",
          bairro: j.neighborhood || "",
          cidade: j.city || "",
          uf: j.state || ""
        };
      }catch(e){}

      return null;
    }

    // ===== Geocode (Nominatim) =====
    async function geocodeAddress(){
      const rua = ($("rua").value || "").trim();
      const numero = ($("numero").value || "").trim();
      const bairro = ($("bairro").value || "").trim();
      const cidade = ($("cidade").value || "").trim();
      const uf = ($("uf").value || "").trim();
      const cep = cleanCep($("cep").value || "");

      if(!rua || !numero || !cidade || !uf) {
        state.geo = { lat:null, lng:null, provider:"" };
        setGeoStatus();
        return null;
      }

      const q = `${rua}, ${numero}, ${bairro}, ${cidade} - ${uf}, Brasil, ${cep}`;
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;

      try{
        const res = await fetch(url, { cache:"no-store" });
        const arr = await res.json();
        if(Array.isArray(arr) && arr.length){
          state.geo = { lat: Number(arr[0].lat), lng: Number(arr[0].lon), provider:"nominatim" };
          setGeoStatus();
          return state.geo;
        }
      }catch(e){}

      state.geo = { lat:null, lng:null, provider:"" };
      setGeoStatus();
      return null;
    }

    async function handleBuscarCep(){
      const cep8 = cleanCep($("cep").value);
      $("cepMsg").textContent = "";
      $("cepMsg").className = "mt-1 text-xs text-graphite/60";

      if(cep8.length !== 8){
        $("cepMsg").textContent = "CEP inv√°lido. Digite 8 n√∫meros.";
        $("cepMsg").className = "mt-1 text-xs text-red-600 font-semibold";
        return;
      }

      $("btnCep").disabled = true;
      $("btnCep").textContent = "Buscando‚Ä¶";

      try{
        const data = await lookupCEP(cep8);
        if(!data){
          $("cepMsg").textContent = "CEP n√£o encontrado. Confira e tente novamente.";
          $("cepMsg").className = "mt-1 text-xs text-red-600 font-semibold";
          return;
        }

        $("rua").value = data.rua;
        $("bairro").value = data.bairro;
        $("cidade").value = data.cidade;
        $("uf").value = data.uf;

        state.endereco.cep = cep8;
        state.endereco.rua = data.rua;
        state.endereco.bairro = data.bairro;
        state.endereco.cidade = data.cidade;
        state.endereco.uf = data.uf;

        $("cepMsg").textContent = `CEP encontrado ‚úÖ (${data.provider})`;
        $("cepMsg").className = "mt-1 text-xs text-regen font-semibold";

        // se j√° tiver n√∫mero, tenta geocode j√°
        if(($("numero").value || "").trim()){
          await geocodeAddress();
        }else{
          setGeoStatus();
        }
      } finally {
        $("btnCep").disabled = false;
        $("btnCep").textContent = "Buscar";
      }
    }

    $("btnCep").addEventListener("click", handleBuscarCep);
    $("numero").addEventListener("blur", ()=> geocodeAddress());

    function readStepIntoState() {
      if(step === 1){
        state.consent.c1 = $("c1").checked;
        state.consent.c2 = $("c2").checked;
        state.consent.c3 = $("c3").checked;
      }
      if(step === 2) state.nomeCompleto = ($("nome").value || "").trim();
      if(step === 5) state.dificuldades = ($("dificuldades").value || "").trim();
      if(step === 6) state.whatsappDDD = cleanPhone($("telefone").value);

      if(step === 7){
        state.localColetaOutro = ($("localOutro").value || "").trim();
        state.condNome = ($("condNome").value || "").trim();
        state.condBloco = ($("condBloco").value || "").trim();
        state.condUnidade = ($("condUnidade").value || "").trim();
      }

      if(step === 8){
        state.endereco.cep = cleanCep($("cep").value || "");
        state.endereco.numero = ($("numero").value || "").trim();
        state.endereco.rua = ($("rua").value || "").trim();
        state.endereco.bairro = ($("bairro").value || "").trim();
        state.endereco.cidade = ($("cidade").value || "").trim();
        state.endereco.uf = ($("uf").value || "").trim().toUpperCase();
      }

      if(step === 9) state.pontoReferencia = ($("referencia").value || "").trim();
    }

    function validateCurrentStep() {
      readStepIntoState();

      if(step === 1 && !(state.consent.c1 && state.consent.c2 && state.consent.c3)) return "Marque as 3 autoriza√ß√µes para avan√ßar.";
      if(step === 2 && (!state.nomeCompleto || state.nomeCompleto.length < 3)) return "Informe seu nome completo.";
      if(step === 3 && !state.jaDestinaReciclavel) return "Selecione Sim ou N√£o.";
      if(step === 4 && !state.temInteresseProjeto) return "Selecione Sim ou N√£o.";
      if(step === 5 && (!state.dificuldades || state.dificuldades.length < 3)) return "Descreva suas limita√ß√µes.";
      if(step === 6 && (!state.whatsappDDD || state.whatsappDDD.length < 10)) return "Informe WhatsApp v√°lido com DDD.";

      if(step === 7){
        if(!state.localColeta) return "Selecione o local.";
        if(state.localColeta === "Outro" && (!state.localColetaOutro || state.localColetaOutro.length < 2)) return "Descreva o local (Outro).";

        if(!state.tipoCadastro) return "Selecione o tipo de cadastro (Participante ou Condom√≠nio).";
        if(state.tipoCadastro === "condominio" && (!state.condNome || state.condNome.length < 3)) return "Informe o nome do condom√≠nio.";
      }

      if(step === 8){
        if(!state.endereco.cep || state.endereco.cep.length !== 8) return "Informe um CEP v√°lido e clique em Buscar.";
        if(!state.endereco.numero) return "Informe o n√∫mero do endere√ßo.";
        if(!state.endereco.rua || state.endereco.rua.length < 2) return "Rua inv√°lida (use Buscar CEP).";
        if(!state.endereco.bairro || state.endereco.bairro.length < 2) return "Bairro inv√°lido (use Buscar CEP).";
        if(!state.endereco.cidade || state.endereco.cidade.length < 2) return "Cidade inv√°lida (use Buscar CEP).";
        if(!state.endereco.uf || state.endereco.uf.length !== 2) return "UF inv√°lida (ex.: RS).";
      }

      if(step === 9 && (!state.pontoReferencia || state.pontoReferencia.length < 3)) return "Informe o ponto de refer√™ncia.";

      return null;
    }

    function genPublicCode(prefix){
      const rand = crypto.getRandomValues(new Uint32Array(1))[0].toString(16).slice(0,6).toUpperCase().padStart(6,"0");
      return `${prefix}-${rand}`;
    }

    function buildPayloadFinal(publicCode){
      const enderecoCompleto = `${state.endereco.rua}, ${state.endereco.numero} - ${state.endereco.bairro}, ${state.endereco.cidade}/${state.endereco.uf} ‚Ä¢ CEP ${state.endereco.cep}`;

      return {
        type: "participant_registration",
        createdAtISO: new Date().toISOString(),
        createdAt: serverTimestamp(),

        // tipo (participante/condominio) + c√≥digo p√∫blico
        tipoCadastro: state.tipoCadastro,
        participantCode: publicCode,

        // dados
        consent: { dados: state.consent.c1, whatsapp: state.consent.c2, imagem: state.consent.c3 },
        nomeCompleto: state.nomeCompleto,
        jaDestinaReciclavel: state.jaDestinaReciclavel,
        temInteresseProjeto: state.temInteresseProjeto,
        dificuldades: state.dificuldades,
        whatsappDDD: state.whatsappDDD,

        // local
        localColeta: state.localColeta,
        localColetaOutro: state.localColeta === "Outro" ? state.localColetaOutro : null,

        // condom√≠nio
        condominio: (state.tipoCadastro === "condominio")
          ? { nome: state.condNome, bloco: state.condBloco || null, unidade: state.condUnidade || null }
          : null,

        // endere√ßo (estruturado + string)
        endereco: {
          cep: state.endereco.cep,
          rua: state.endereco.rua,
          numero: state.endereco.numero,
          bairro: state.endereco.bairro,
          cidade: state.endereco.cidade,
          uf: state.endereco.uf,
          completo: enderecoCompleto
        },
        enderecoCompleto: enderecoCompleto, // compatibilidade com seu modelo antigo

        // geo para o dashboard (ponto no mapa)
        geo: (state.geo.lat && state.geo.lng) ? { lat: state.geo.lat, lng: state.geo.lng, provider: state.geo.provider } : null,

        pontoReferencia: state.pontoReferencia,
        status: "pending"
      };
    }

    async function saveParticipant(){
      // garante geocode (se tiver como)
      await geocodeAddress();

      const prefix = (state.tipoCadastro === "condominio") ? "COND" : "RB";
      const publicCode = genPublicCode(prefix);

      const payload = buildPayloadFinal(publicCode);
      const ref = await addDoc(collection(db, "participants"), payload);
      return { docId: ref.id, publicCode, payload };
    }

    $("btnBack").addEventListener("click", ()=>{
      if(isSubmitting) return;
      if(step > 1) showStep(step - 1);
    });

    $("btnPreview").addEventListener("click", async ()=>{
      readStepIntoState();
      await geocodeAddress();
      const prefix = (state.tipoCadastro === "condominio") ? "COND" : "RB";
      const payload = buildPayloadFinal(`${prefix}-XXXXXX`);
      $("preview").classList.remove("hidden");
      $("preview").textContent = JSON.stringify({ ...payload, createdAt: "(serverTimestamp)" }, null, 2);
      showAlert("info", "Pr√©via gerada (ainda n√£o foi salva).");
    });

    $("btnNext").addEventListener("click", async ()=>{
      if(isSubmitting) return;

      const err = validateCurrentStep();
      if(err){ showAlert("err", err); return; }

      // passo 8: se usu√°rio preencheu tudo mas ainda n√£o tem geo, tenta calcular antes de avan√ßar
      if(step === 8){
        await geocodeAddress();
      }

      if(step < TOTAL_STEPS){
        showStep(step + 1);
        return;
      }

      isSubmitting = true;
      setProgress();
      hideAlert();

      try{
        setDbStatus("salvando no Firestore‚Ä¶", true);
        const { docId, publicCode, payload } = await saveParticipant();
        setDbStatus("salvo ‚úÖ", true);

        const label = (payload.tipoCadastro === "condominio") ? "ID do condom√≠nio" : "ID do participante";
        showAlert("ok", `Cadastro enviado! ${label}: ${publicCode}`);

        $("preview").classList.remove("hidden");
        $("preview").textContent = JSON.stringify({ firestoreDocId: docId, ...payload, createdAt: "(serverTimestamp)" }, null, 2);

      }catch(e){
        console.error(e);
        setDbStatus("erro ao salvar (rules)", false);
        showAlert("err", "N√£o foi poss√≠vel salvar. Verifique Firestore Rules e tente novamente.");
      }finally{
        isSubmitting = false;
        setProgress();
      }
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      if(tag === "textarea") return;
      e.preventDefault();
      $("btnNext").click();
    });

    setDbStatus("conectado ‚úÖ", true);
    setGeoStatus();
    setProgress();
  </script>
</body>
</html>