<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recicla Bonja • Dashboard Coletas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: {
            soft: "0 14px 40px rgba(13,59,102,.14)",
            card: "0 10px 26px rgba(46,46,46,.10)"
          }
        }
      }
    }
  </script>

  <style>
    .bg-mesh{
      background:
        radial-gradient(900px 500px at 12% 10%, rgba(76,175,143,.25), transparent 55%),
        radial-gradient(780px 520px at 88% 12%, rgba(242,201,76,.22), transparent 56%),
        radial-gradient(900px 600px at 70% 88%, rgba(13,59,102,.14), transparent 58%),
        linear-gradient(135deg, #0D3B66 0%, #1B7F5A 55%, #4CAF8F 100%);
    }
    .glass{
      background: rgba(255,255,255,.86);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.55);
    }
    .panel { background:#fff; border:1px solid rgba(0,0,0,.06); box-shadow:0 10px 26px rgba(0,0,0,.06); }
    .dashed { border:1px dashed rgba(0,0,0,.18); }
    .focus-ring:focus{
      outline:none;
      box-shadow: 0 0 0 4px rgba(27,127,90,.14);
      border-color: rgba(27,127,90,.45);
    }
  </style>
</head>

<body class="min-h-screen bg-mesh text-graphite">
  <!-- TOP -->
  <header class="max-w-[1200px] mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-white/15 border border-white/25 flex items-center justify-center text-white font-extrabold">RB</div>
        <div class="leading-tight">
          <div class="text-white/85 text-xs">vila do futuro</div>
          <div class="text-white text-xl font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-white/75 text-xs">Dashboard • Coletas</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a href="cadastro-coleta.html"
          class="px-4 py-2 rounded-xl bg-white/15 text-white border border-white/20 hover:bg-white/20 transition text-sm font-semibold">
          + Nova coleta
        </a>
        <a href="index.html" class="text-white/90 text-sm font-semibold hover:underline">Menu</a>
      </div>
    </div>
  </header>

  <main class="max-w-[1200px] mx-auto px-4 pb-10">
    <section class="glass rounded-3xl shadow-soft overflow-hidden">
      <!-- Header -->
      <div class="p-6 sm:p-8 border-b border-black/5 bg-white/60">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-deepBlue">Dashboard de Coletas</h1>
            <p class="mt-2 text-graphite/70">
              Dados carregados direto do Firestore (<b>coletasSeletivas</b>). Atualiza automaticamente conforme novos registros entram.
            </p>
          </div>

          <div class="text-xs text-graphite/60">
            Status: <span id="status" class="font-bold">conectando…</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="p-6 sm:p-8 bg-white/60 border-b border-black/5">
        <div class="grid lg:grid-cols-12 gap-3">
          <div class="lg:col-span-3">
            <label class="text-xs font-extrabold">Data inicial</label>
            <input id="fStart" type="date" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"/>
          </div>

          <div class="lg:col-span-3">
            <label class="text-xs font-extrabold">Data final</label>
            <input id="fEnd" type="date" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"/>
          </div>

          <div class="lg:col-span-3">
            <label class="text-xs font-extrabold">Tipo de entrega</label>
            <select id="fDelivery" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white">
              <option value="all">Todos</option>
            </select>
          </div>

          <div class="lg:col-span-3">
            <label class="text-xs font-extrabold">Fluxo</label>
            <select id="fFlow" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white">
              <option value="all">Todos</option>
              <option value="recebimento">Recebimento</option>
              <option value="final_turno">Final do turno</option>
            </select>
          </div>

          <div class="lg:col-span-9">
            <label class="text-xs font-extrabold">Buscar por ID vinculado</label>
            <input id="fLinkedId" class="mt-1 w-full px-4 py-3 rounded-xl border border-black/10 focus-ring bg-white"
              placeholder="Ex.: RB-000123 ou COND-000045 (opcional)"/>
          </div>

          <div class="lg:col-span-3 flex items-end gap-2">
            <button id="btnApply" class="w-full px-4 py-3 rounded-xl bg-deepBlue text-white font-extrabold hover:brightness-95 transition shadow-soft">
              Aplicar
            </button>
            <button id="btnReset" class="px-4 py-3 rounded-xl bg-white border border-black/10 font-extrabold hover:bg-black/5 transition">
              Limpar
            </button>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="p-6 sm:p-8 bg-white">
        <div class="grid md:grid-cols-4 gap-4">
          <div class="panel dashed rounded-2xl p-4">
            <div class="text-xs text-graphite/60 font-bold">Total de coletas</div>
            <div id="kTotal" class="text-3xl font-extrabold text-deepBlue">0</div>
          </div>

          <div class="panel dashed rounded-2xl p-4">
            <div class="text-xs text-graphite/60 font-bold">Total resíduo seco (kg)</div>
            <div id="kSeco" class="text-3xl font-extrabold text-regen">0</div>
          </div>

          <div class="panel dashed rounded-2xl p-4">
            <div class="text-xs text-graphite/60 font-bold">Total rejeito (kg)</div>
            <div id="kRejeito" class="text-3xl font-extrabold text-red-700">0</div>
          </div>

          <div class="panel dashed rounded-2xl p-4">
            <div class="text-xs text-graphite/60 font-bold">Total não comercializado (kg)</div>
            <div id="kNaoCom" class="text-3xl font-extrabold text-graphite">0</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="mt-6 grid lg:grid-cols-2 gap-4">
          <div class="panel dashed rounded-2xl p-4">
            <div class="flex items-end justify-between gap-3">
              <div>
                <div class="text-sm font-extrabold text-deepBlue">Coletas por dia</div>
                <div class="text-xs text-graphite/60">Quantidade de registros por data (opDate)</div>
              </div>
              <div class="text-xs text-graphite/60" id="rangeLabel">—</div>
            </div>
            <canvas id="chartDaily" height="180" class="mt-2"></canvas>
          </div>

          <div class="panel dashed rounded-2xl p-4">
            <div class="text-sm font-extrabold text-deepBlue">Distribuição por tipo de entrega</div>
            <div class="text-xs text-graphite/60">Quantidade por deliveryType</div>
            <canvas id="chartDelivery" height="180" class="mt-2"></canvas>
          </div>
        </div>

        <div class="mt-4 panel dashed rounded-2xl p-4">
          <div class="text-sm font-extrabold text-deepBlue">Últimas coletas</div>
          <div class="text-xs text-graphite/60">Tabela (mais recentes primeiro)</div>

          <div class="mt-3 overflow-x-auto">
            <table class="w-full text-xs border border-black/10 rounded-xl overflow-hidden">
              <thead class="bg-black/5">
                <tr>
                  <th class="p-2 text-left">Data</th>
                  <th class="p-2 text-left">Tipo entrega</th>
                  <th class="p-2 text-left">Fluxo</th>
                  <th class="p-2 text-left">ID vinculado</th>
                  <th class="p-2 text-right">Seco (kg)</th>
                  <th class="p-2 text-right">Rejeito (kg)</th>
                  <th class="p-2 text-right">Não com. (kg)</th>
                </tr>
              </thead>
              <tbody id="tbl"></tbody>
            </table>
          </div>

          <div class="mt-3 text-[11px] text-graphite/60 text-right">
            Dica: quer detalhar por material? Eu adiciono um gráfico de materiais do “final do turno” (plástico, papelão, vidro…).
          </div>
        </div>

      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, where, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // Firebase config (PREENCHA)
    // =========================
      const firebaseConfig = {
  apiKey: "AIzaSyAQBmh8uwLTkyabQc_GznBBV1X2dPhActE",
  authDomain: "recicla-bonja.firebaseapp.com",
  projectId: "recicla-bonja",
  storageBucket: "recicla-bonja.firebasestorage.app",
  messagingSenderId: "557210456406",
  appId: "1:557210456406:web:4eebf082cc0d15580c86f7"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================
    // UI
    // =========================
    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    const fStart = $("fStart");
    const fEnd = $("fEnd");
    const fDelivery = $("fDelivery");
    const fFlow = $("fFlow");
    const fLinkedId = $("fLinkedId");
    const btnApply = $("btnApply");
    const btnReset = $("btnReset");

    const kTotal = $("kTotal");
    const kSeco = $("kSeco");
    const kRejeito = $("kRejeito");
    const kNaoCom = $("kNaoCom");
    const tbl = $("tbl");
    const rangeLabel = $("rangeLabel");

    // charts
    let dailyChart = null;
    let deliveryChart = null;

    Chart.defaults.font.family = "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
    Chart.defaults.color = "#2E2E2E";

    // =========================
    // Helpers
    // =========================
    function toNum(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function normId(v){
      return (v || "").trim().toUpperCase();
    }

    function setStatus(text, ok=true){
      statusEl.textContent = text;
      statusEl.className = ok ? "font-bold text-regen" : "font-bold text-red-700";
    }

    function todayISO(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    function daysAgoISO(n){
      const d = new Date();
      d.setDate(d.getDate() - n);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    // default filter (últimos 30 dias)
    fEnd.value = todayISO();
    fStart.value = daysAgoISO(30);

    // =========================
    // Firestore subscription (realtime)
    // =========================
    let unsub = null;
    let allRows = []; // snapshot em memória (filtrado por query base)

    function buildBaseQuery(){
      // Como opDate é string YYYY-MM-DD, dá pra filtrar com where range
      const col = collection(db, "coletasSeletivas");
      const clauses = [];

      const start = fStart.value || null;
      const end = fEnd.value || null;

      if(start) clauses.push(where("opDate", ">=", start));
      if(end) clauses.push(where("opDate", "<=", end));

      // Atenção: para usar orderBy com where range no mesmo campo, ok
      // Ordenando por opDate desc e limitando
      return query(col, ...clauses, orderBy("opDate", "desc"), limit(1000));
    }

    function applyClientFilters(rows){
      const del = fDelivery.value;
      const flow = fFlow.value;
      const lid = normId(fLinkedId.value);

      return rows.filter(r=>{
        if(del !== "all" && (r.deliveryType || "") !== del) return false;
        if(flow !== "all" && (r.flowType || "") !== flow) return false;
        if(lid && normId(r.linkedId || "") !== lid) return false;
        return true;
      });
    }

    function computeAndRender(rows){
      // KPIs (adaptável: se no seu cadastro de coletas o nome dos campos for diferente, eu ajusto)
      let total = rows.length;
      let sumSeco = 0;
      let sumRejeito = 0;
      let sumNaoCom = 0;

      // agregações para gráficos
      const byDay = {};      // opDate -> count
      const byDelivery = {}; // deliveryType -> count
      const deliverySet = new Set();

      rows.forEach(r=>{
        const d = r.opDate || "—";
        byDay[d] = (byDay[d] || 0) + 1;

        const del = r.deliveryType || "Não informado";
        byDelivery[del] = (byDelivery[del] || 0) + 1;
        deliverySet.add(del);

        // pesos: tentamos vários nomes (para não quebrar)
        // Recebimento (ex.: 5,8,9)
        sumSeco += toNum(r.pesoResiduoSecoKg ?? r.pesoResiduoSeco ?? r.pesoSecoKg ?? r.secoKg);
        sumRejeito += toNum(r.pesoRejeitoKg ?? r.pesoRejeito ?? r.rejeitoKg);
        sumNaoCom += toNum(r.pesoNaoComercializadoKg ?? r.pesoNaoComercializado ?? r.naoComercializadoKg);
        // Final do turno: você tem 2.1 rejeito geral e materiais — (se quiser somar aqui também, me diga)
        sumRejeito += toNum(r.pesoRejeitoGeralKg ?? r.rejeitoGeralKg);
      });

      kTotal.textContent = String(total);
      kSeco.textContent = String(sumSeco.toFixed(1)).replace(".",",");
      kRejeito.textContent = String(sumRejeito.toFixed(1)).replace(".",",");
      kNaoCom.textContent = String(sumNaoCom.toFixed(1)).replace(".",",");

      // range label
      const ds = rows.map(r=>r.opDate).filter(Boolean);
      const max = ds[0] || "—";
      const min = ds[ds.length-1] || "—";
      rangeLabel.textContent = `${min} → ${max}`;

      // Chart daily
      const dayKeys = Object.keys(byDay).sort(); // asc
      const dayVals = dayKeys.map(k=>byDay[k]);

      if(dailyChart) dailyChart.destroy();
      dailyChart = new Chart($("chartDaily"), {
        type: "bar",
        data: {
          labels: dayKeys,
          datasets: [{
            label: "Coletas",
            data: dayVals,
            borderWidth: 0,
            borderRadius: 6
          }]
        },
        options: {
          plugins: { legend: { display:false } },
          scales: {
            x: { grid:{ display:false }, ticks:{ font:{ size:10 } } },
            y: { grid:{ color:"rgba(0,0,0,.07)" }, ticks:{ font:{ size:10 } } }
          }
        }
      });

      // Chart delivery
      const delKeys = Object.keys(byDelivery);
      const delVals = delKeys.map(k=>byDelivery[k]);

      if(deliveryChart) deliveryChart.destroy();
      deliveryChart = new Chart($("chartDelivery"), {
        type: "doughnut",
        data: {
          labels: delKeys,
          datasets: [{ data: delVals, borderWidth: 0 }]
        },
        options: {
          cutout: "70%",
          plugins: { legend: { position:"bottom", labels:{ boxWidth:10, usePointStyle:true, pointStyle:"circle" } } }
        }
      });

      // Preencher dropdown delivery dinamicamente (sem duplicar)
      const existing = new Set([...fDelivery.options].map(o=>o.value));
      Array.from(deliverySet).sort().forEach(v=>{
        if(!existing.has(v)){
          const op = document.createElement("option");
          op.value = v;
          op.textContent = v;
          fDelivery.appendChild(op);
        }
      });

      // Table
      tbl.innerHTML = "";
      rows.slice(0, 40).forEach(r=>{
        const tr = document.createElement("tr");
        tr.className = "border-t border-black/10";
        tr.innerHTML = `
          <td class="p-2 font-semibold">${r.opDate || "—"}</td>
          <td class="p-2">${r.deliveryType || "—"}</td>
          <td class="p-2">${r.flowType || "—"}</td>
          <td class="p-2">${r.linkedId || "—"}</td>
          <td class="p-2 text-right font-semibold">${toNum(r.pesoResiduoSecoKg ?? r.pesoResiduoSeco ?? r.pesoSecoKg ?? r.secoKg).toFixed(1).replace(".",",")}</td>
          <td class="p-2 text-right font-semibold">${toNum(r.pesoRejeitoKg ?? r.pesoRejeito ?? r.rejeitoKg ?? r.pesoRejeitoGeralKg ?? r.rejeitoGeralKg).toFixed(1).replace(".",",")}</td>
          <td class="p-2 text-right font-semibold">${toNum(r.pesoNaoComercializadoKg ?? r.pesoNaoComercializado ?? r.naoComercializadoKg).toFixed(1).replace(".",",")}</td>
        `;
        tbl.appendChild(tr);
      });
    }

    function subscribe(){
      if(unsub) unsub();

      setStatus("conectando…", true);
      const q = buildBaseQuery();

      unsub = onSnapshot(q, (snap)=>{
        const rows = [];
        snap.forEach(doc=>{
          rows.push({ id: doc.id, ...doc.data() });
        });
        allRows = rows;

        const filtered = applyClientFilters(allRows);
        computeAndRender(filtered);

        setStatus(`ok • ${filtered.length} registros`, true);
      }, (err)=>{
        console.error(err);
        setStatus("erro ao carregar (rules/config)", false);
      });
    }

    btnApply.addEventListener("click", ()=> subscribe());
    btnReset.addEventListener("click", ()=>{
      fEnd.value = todayISO();
      fStart.value = daysAgoISO(30);
      fDelivery.value = "all";
      fFlow.value = "all";
      fLinkedId.value = "";
      subscribe();
    });

    // init
    subscribe();
  </script>
</body>
</html>