<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Coletas Seletivas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: {
            soft: "0 14px 40px rgba(46,46,46,.10)",
            card: "0 10px 26px rgba(13,59,102,.10)"
          }
        }
      }
    }
  </script>

  <style>
    .panel { background: #fff; border: 1px solid rgba(0,0,0,.06); box-shadow: 0 10px 26px rgba(13,59,102,.06); }
    .pill { background: #2ea86d; }
    .pill:hover{ filter: brightness(.97); }
    .dash-grid { grid-template-columns: 320px 1fr; }
    .dashed { border: 2px dashed rgba(0,0,0,.12); }
    .bubble {
      background: #edf6ef;
      border: 1px solid rgba(27,127,90,.12);
      box-shadow: 0 10px 18px rgba(27,127,90,.06);
    }
    .legend-dot { width: 18px; height: 10px; border-radius: 3px; }
    .leaflet-container { border-radius: 14px; }
    .soft-divider { border-top: 1px dashed rgba(0,0,0,.10); }
  </style>
</head>

<body class="bg-grayClean text-graphite">
  <!-- TOP BAR -->
  <header class="bg-white border-b border-black/5">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center gap-3">
      <!-- Brand -->
      <div class="flex items-center gap-3 min-w-[260px]">
        <div class="h-10 w-10 rounded-xl bg-regen/10 flex items-center justify-center border border-regen/15">
          <span class="text-regen font-extrabold">RB</span>
        </div>
        <div class="leading-tight">
          <div class="text-xs text-graphite/70">vila do futuro</div>
          <div class="font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-[11px] text-graphite/55">Sustentabilidade na Quebrada</div>
        </div>
      </div>

      <!-- Pills (placeholders) -->
      <div class="flex-1 flex items-center justify-center gap-3 flex-wrap">
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          DATA <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          M√äS <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          CICLO <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          TIPO DE COLETA <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          C√ìDIGO <span class="text-white/90">‚ñæ</span>
        </button>
      </div>

      <div class="min-w-[260px] flex justify-end items-center gap-3">
        <span class="text-xs text-graphite/55">Dashboard ‚Ä¢ Coletas</span>
        <a href="cadastro-coletas.html" class="text-xs font-bold text-regen hover:underline">Cadastrar coleta</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-[1400px] mx-auto px-4 py-4">
    <div class="grid dash-grid gap-4">
      <!-- LEFT SIDEBAR -->
      <aside class="space-y-4">
        <!-- KPIs -->
        <div class="panel rounded-2xl overflow-hidden">
          <div class="grid grid-cols-2">
            <div class="p-4 bg-regen/15 border-r border-black/5">
              <div class="text-3xl font-extrabold text-graphite" id="kpiDias">‚Äî</div>
              <div class="text-xs text-graphite/70">total de dias do projeto</div>
              <div class="text-[11px] text-graphite/60">In√≠cio: <span class="font-semibold" id="kpiInicio">‚Äî</span></div>
            </div>
            <div class="p-4 bg-regen/10">
              <div class="text-3xl font-extrabold text-graphite" id="kpiOps">0</div>
              <div class="text-xs text-graphite/70">opera√ß√µes realizadas</div>
            </div>
          </div>
        </div>

        <!-- Families / Condo (placeholders simples) -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="font-extrabold text-center">FAM√çLIAS</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">cadastradas</span>
                  <span class="font-bold" id="famCadastradas">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes</span>
                  <span class="font-bold" id="famParticipantes">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="famColetas">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="border-l border-black/10 pl-3">
              <div class="font-extrabold text-center">CONDOM√çNIO</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">cadastrados</span>
                  <span class="font-bold" id="condCadastrados">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes</span>
                  <span class="font-bold" id="condParticipantes">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="condColetas">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3 text-[11px] text-graphite/55">
            * Esses blocos podem ser refinados depois quando voc√™ cadastrar ‚Äúfam√≠lias/condom√≠nios‚Äù em cole√ß√µes pr√≥prias.
          </div>
        </div>

        <!-- Map -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">LOCALIZA√á√ÉO</div>
          <div class="mt-3">
            <div id="map" class="w-full h-[360px]"></div>
          </div>
          <div class="mt-2 text-[11px] text-graphite/55">
            * Para mapa real por endere√ßo, voc√™ pode salvar latitude/longitude na coleta ou geocodificar.
          </div>
        </div>

        <!-- Quality donut -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">QUALIDADE DO RES√çDUO</div>
          <div class="mt-4">
            <canvas id="chartQualidade" height="220"></canvas>
            <div class="mt-3 flex items-center justify-center gap-5 text-xs">
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#1B7F5A"></span> LIMPO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#F2C94C"></span> M√âDIO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#EF4444"></span> RUIM
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT CONTENT -->
      <section class="space-y-4">
        <!-- Summary row -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-4 items-stretch">
            <div class="col-span-12 md:col-span-2 flex items-center justify-center font-extrabold text-lg">
              GERAL
            </div>

            <div class="col-span-12 md:col-span-7 border-l border-black/10 pl-4">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">
                    ‚ôªÔ∏è
                  </div>
                  <div>
                    <div class="text-xl font-extrabold">
                      <span id="sumRecKg">0,0</span> kg <span class="ml-2">RECICL√ÅVEL</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-regen font-extrabold" id="sumRecPct">0,0%</span> do total
                    </div>
                    <div class="text-sm text-graphite/70">
                      Receita total = <span class="font-extrabold">R$</span> <span class="font-extrabold" id="sumReceita">0,0</span>
                    </div>
                  </div>
                </div>

                <div class="hidden md:block w-px bg-black/10"></div>

                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-red-50 border border-red-100 flex items-center justify-center">
                    üóëÔ∏è
                  </div>
                  <div class="text-right">
                    <div class="text-xl font-extrabold">
                      <span id="sumRejKg">0,0</span> kg <span class="ml-2 text-red-600">REJEITO</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-red-600 font-extrabold" id="sumRejPct">0,0%</span> do total
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-span-12 md:col-span-3">
              <div class="rounded-2xl bg-grayClean border border-black/10 p-4 h-full">
                <div class="text-xs font-extrabold text-graphite/70">RESUMO</div>
                <div class="mt-2 space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Total (kg)</span>
                    <span class="font-extrabold" id="sumTotalKg">0,0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Opera√ß√µes</span>
                    <span class="font-extrabold" id="sumOps">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Dias (no filtro)</span>
                    <span class="font-extrabold" id="sumDiasFiltro">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3 text-[11px] text-graphite/60">
            Firestore: <span id="dbStatus" class="font-semibold">conectando‚Ä¶</span>
          </div>
        </div>

        <!-- Middle: bubbles + right reject breakdown -->
        <div class="grid grid-cols-12 gap-4">
          <!-- Bubbles materials -->
          <div class="col-span-12 lg:col-span-8 panel rounded-2xl p-4">
            <div class="text-center font-extrabold text-lg">TIPO DE MATERIAL RECICL√ÅVEL</div>
            <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total de recicl√°veis)</div>

            <div id="bubblesGrid" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>

            <div class="mt-3 text-[11px] text-graphite/55 text-center">
              * Aqui agregamos principalmente pelo ‚Äúfinal_turno‚Äù. O ‚Äúrecebimento‚Äù entra como ‚ÄúRecicl√°vel total‚Äù, mas n√£o tem breakdown por material.
            </div>
          </div>

          <!-- Right reject types -->
          <div class="col-span-12 lg:col-span-4 space-y-4">
            <div class="panel rounded-2xl p-4">
              <div class="text-center font-extrabold text-lg">TIPO DE REJEITO</div>
              <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total do rejeito)</div>

              <div class="mt-4 space-y-4">
                <div class="rounded-2xl bg-red-50 border border-red-100 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üêÄ</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoRecPct">0,0%</div>
                  <div class="text-sm font-extrabold">N√ÉO RECICL√ÅVEL</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoRecKg">0,0</span> kg</div>
                </div>

                <div class="rounded-2xl bg-white border border-black/10 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üö´üí∞</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoComPct">0,0%</div>
                  <div class="text-sm font-extrabold">N√ÉO COMERCIALIZADO</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoComKg">0,0</span> kg</div>
                </div>
              </div>
            </div>

            <div class="panel rounded-2xl p-4 dashed">
              <div class="text-center font-extrabold">OUTRO</div>
              <div class="mt-3 flex items-center justify-center text-5xl">üß¥</div>
              <div class="mt-2 text-center">
                <div class="text-3xl font-extrabold" id="outroKg">0,0</div>
                <div class="text-xs text-graphite/70">kg</div>
                <div class="mt-2 text-sm font-extrabold">√ìLEO DE COZINHA</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom chart -->
        <div class="panel rounded-2xl p-4">
          <div class="flex items-center gap-6 text-sm justify-center">
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#EF4444"></span> Peso do rejeito
            </div>
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#22C55E"></span> Peso do Recicl√°vel
            </div>
          </div>

          <div class="mt-3">
            <canvas id="chartBar" height="120"></canvas>
          </div>
          <div class="soft-divider mt-3 pt-2 text-xs text-center text-graphite/60">
            Total de fam√≠lias/condom√≠nios participantes (no per√≠odo)
          </div>
        </div>

        <!-- Table (PLANILHA) -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-3 text-xs font-extrabold text-graphite/70 pb-2 border-b border-black/10">
            <div class="col-span-2">C√≥digo/ID</div>
            <div class="col-span-2">Fluxo</div>
            <div class="col-span-2">Data de coleta</div>
            <div class="col-span-2">Rejeito (kg)</div>
            <div class="col-span-2">N√£o com. (kg)</div>
            <div class="col-span-2">Tipo</div>
          </div>

          <div id="rows" class="divide-y divide-black/5 text-sm">
            <!-- Firestore preenche -->
          </div>

          <div class="mt-3 text-[11px] text-right text-graphite/50">
            Desenvolvido por voc√™ ‚Ä¢ Recicla Bonja
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- DASHBOARD SCRIPT (Firestore + Render) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===========================
    // FIREBASE
    // ===========================
       const firebaseConfig = {
  apiKey: "AIzaSyAe5E7M8Jednj1xGRjNrV0oD4wQwv6b-WM",
  authDomain: "reciclabonja-3dee7.firebaseapp.com",
  projectId: "reciclabonja-3dee7",
  storageBucket: "reciclabonja-3dee7.firebasestorage.app",
  messagingSenderId: "590941010829",
  appId: "1:590941010829:web:9b8e4703df54cc8b0a9bc4"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===========================
    // UI helpers
    // ===========================
    const fmt = (n, dec=1) => Number(n || 0).toLocaleString("pt-BR", {
      minimumFractionDigits: dec,
      maximumFractionDigits: dec
    });

    const setText = (id, value) => {
      const el = document.getElementById(id);
      if(el) el.textContent = value;
    };

    const toNumber = (x) => {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    };

    function setDbStatus(text, ok=true){
      const el = document.getElementById("dbStatus");
      el.textContent = text;
      el.className = ok ? "font-semibold text-regen" : "font-semibold text-red-700";
    }

    // ===========================
    // Charts
    // ===========================
    let chartQualidade, chartBar;

    function drawQualidade(limpo, medio, ruim){
      if(chartQualidade) chartQualidade.destroy();
      const ctx = document.getElementById("chartQualidade");
      chartQualidade = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["LIMPO", "M√âDIO", "RUIM"],
          datasets: [{
            data: [limpo, medio, ruim],
            backgroundColor: ["#1B7F5A", "#F2C94C", "#EF4444"],
            borderWidth: 0
          }]
        },
        options: {
          cutout: "70%",
          plugins: { legend: { display:false }, tooltip: { enabled:true } }
        }
      });
    }

    function drawBar(labels, rejeito, reciclavel){
      if(chartBar) chartBar.destroy();
      const ctx = document.getElementById("chartBar");
      chartBar = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label:"Peso do rejeito", data: rejeito, backgroundColor:"#EF4444", stack:"stack1", borderWidth:0 },
            { label:"Peso do recicl√°vel", data: reciclavel, backgroundColor:"#22C55E", stack:"stack1", borderWidth:0 },
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: {
            x: { stacked:true, grid: { display:false }, ticks: { maxRotation:0, autoSkip:true, maxTicksLimit:18, font:{size:10} } },
            y: { stacked:true, grid: { color: "rgba(0,0,0,.06)" }, ticks: { font:{size:10} } }
          }
        }
      });
    }

    // ===========================
    // Map (placeholder)
    // ===========================
    let map;
    function initMap(){
      map = L.map('map', { zoomControl: true }).setView([-30.0346, -51.2177], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }

    // ===========================
    // Render table (planilha)
    // ===========================
    function renderTabela(items){
      const container = document.getElementById("rows");
      container.innerHTML = "";

      // ordena por data (opDate) desc, sem depender de index Firestore
      items.sort((a,b)=>{
        const ad = String(a.opDate || "");
        const bd = String(b.opDate || "");
        return bd.localeCompare(ad);
      });

      items.forEach(item=>{
        const row = document.createElement("div");
        row.className = "grid grid-cols-12 gap-3 py-2 text-xs";

        const codigo = item.linkedId || item.codigoFamilia || item.codigoCondominio || "-";
        const fluxo = item.flowType === "recebimento" ? "Recebimento" : "Final turno";
        const data = item.opDate || "-";

        const rejeitoKg = item.flowType === "recebimento"
          ? toNumber(item.pesoRejeitoKg)
          : toNumber(item.pesoRejeitoGeralKg);

        const naoComKg = item.flowType === "recebimento"
          ? toNumber(item.pesoNaoComercializadoKg)
          : 0;

        row.innerHTML = `
          <div class="col-span-2 font-semibold">${codigo}</div>
          <div class="col-span-2">${fluxo}</div>
          <div class="col-span-2">${data}</div>
          <div class="col-span-2 text-right">${fmt(rejeitoKg)}</div>
          <div class="col-span-2 text-right">${item.flowType === "recebimento" ? fmt(naoComKg) : "-"}</div>
          <div class="col-span-2">${item.deliveryType || "-"}</div>
        `;

        container.appendChild(row);
      });

      if(!items.length){
        container.innerHTML = `<div class="py-4 text-sm text-graphite/60">Nenhuma coleta encontrada ainda.</div>`;
      }
    }

    // ===========================
    // Aggregate + UI update
    // ===========================
    function renderAll(items){
      // KPIs
      setText("kpiOps", items.length);
      setText("sumOps", items.length);

      // totals
      let totalRec = 0;
      let totalRej = 0;

      // qualidade contagem (s√≥ recebimento tem qualidadeNota)
      let q1 = 0, q2 = 0, q3 = 0;

      // rejeito breakdown: aqui vamos assumir
      // - "n√£o recicl√°vel" = rejeito geral (final_turno) + rejeito (recebimento)
      // - "n√£o comercializado" = pesoNaoComercializadoKg (recebimento)
      let naoRecKg = 0;
      let naoComKg = 0;

      // materiais (somente final_turno)
      const mats = {
        "PL√ÅSTICO": { kg:0, icon:"üß¥" },
        "PAPEL MISTO": { kg:0, icon:"üìÑ" },
        "PAPEL√ÉO": { kg:0, icon:"üì¶" },
        "ALUM√çNIO/METAL": { kg:0, icon:"ü•´" },
        "VIDRO": { kg:0, icon:"üçæ" },
        "SACARIA/SACOLINHA": { kg:0, icon:"üõçÔ∏è" },
        "ISOPOR": { kg:0, icon:"üç±" },
        "√ìLEO": { kg:0, icon:"üß¥" },
      };

      // s√©rie por data opDate (YYYY-MM-DD)
      const seriesMap = new Map(); // date -> {rec, rej}

      items.forEach(d=>{
        const date = d.opDate || "sem-data";

        if(!seriesMap.has(date)) seriesMap.set(date, { rec:0, rej:0 });

        if(d.flowType === "recebimento"){
          const rec = toNumber(d.pesoResiduoSecoKg);
          const rej = toNumber(d.pesoRejeitoKg);
          totalRec += rec;
          totalRej += rej;

          naoRecKg += rej;
          naoComKg += toNumber(d.pesoNaoComercializadoKg);

          seriesMap.get(date).rec += rec;
          seriesMap.get(date).rej += rej;

          if(d.qualidadeNota === 1) q1++;
          if(d.qualidadeNota === 2) q2++;
          if(d.qualidadeNota === 3) q3++;
        }

        if(d.flowType === "final_turno"){
          const rej = toNumber(d.pesoRejeitoGeralKg);
          totalRej += rej;
          naoRecKg += rej;

          // recicl√°veis por materiais
          const rec =
            toNumber(d.plasticoKg) +
            toNumber(d.papelMistoKg) +
            toNumber(d.papelaoKg) +
            toNumber(d.aluminioMetalKg) +
            toNumber(d.vidroKg) +
            toNumber(d.sacariaKg) +
            toNumber(d.isoporKg) +
            toNumber(d.oleoKg);

          totalRec += rec;

          mats["PL√ÅSTICO"].kg += toNumber(d.plasticoKg);
          mats["PAPEL MISTO"].kg += toNumber(d.papelMistoKg);
          mats["PAPEL√ÉO"].kg += toNumber(d.papelaoKg);
          mats["ALUM√çNIO/METAL"].kg += toNumber(d.aluminioMetalKg);
          mats["VIDRO"].kg += toNumber(d.vidroKg);
          mats["SACARIA/SACOLINHA"].kg += toNumber(d.sacariaKg);
          mats["ISOPOR"].kg += toNumber(d.isoporKg);
          mats["√ìLEO"].kg += toNumber(d.oleoKg);

          // extras
          if(Array.isArray(d.materiaisExtras)){
            d.materiaisExtras.forEach(x=>{
              const name = String(x?.name || "").trim();
              const kg = toNumber(x?.kg);
              if(!name) return;
              if(!mats[name]) mats[name] = { kg:0, icon:"‚ôªÔ∏è" };
              mats[name].kg += kg;
            });
          }

          seriesMap.get(date).rec += rec;
          seriesMap.get(date).rej += rej;
        }
      });

      const total = totalRec + totalRej;
      const recPct = total ? (totalRec/total)*100 : 0;
      const rejPct = total ? (totalRej/total)*100 : 0;

      setText("sumRecKg", fmt(totalRec));
      setText("sumRejKg", fmt(totalRej));
      setText("sumTotalKg", fmt(total));
      setText("sumDiasFiltro", seriesMap.size);

      setText("sumRecPct", recPct.toFixed(1).replace(".", ",") + "%");
      setText("sumRejPct", rejPct.toFixed(1).replace(".", ",") + "%");

      // receita (placeholder)
      setText("sumReceita", fmt(0));

      // rejeito breakdown
      const rejTotal = naoRecKg + naoComKg;
      const naoRecPct = rejTotal ? (naoRecKg/rejTotal)*100 : 0;
      const naoComPct = rejTotal ? (naoComKg/rejTotal)*100 : 0;

      setText("rejNaoRecKg", fmt(naoRecKg));
      setText("rejNaoComKg", fmt(naoComKg));
      setText("rejNaoRecPct", naoRecPct.toFixed(1).replace(".", ",") + "%");
      setText("rejNaoComPct", naoComPct.toFixed(1).replace(".", ",") + "%");
      setText("outroKg", fmt(mats["√ìLEO"]?.kg || 0));

      // qualidade donut (map: 1=ruim,2=medio,3=limpo)
      drawQualidade(q3, q2, q1);

      // materiais bubbles (% sobre recicl√°vel)
      const bubbles = document.getElementById("bubblesGrid");
      bubbles.innerHTML = "";
      const matsArr = Object.entries(mats)
        .map(([k,v]) => ({ key:k, kg:v.kg, icon:v.icon }))
        .filter(x => x.kg > 0.0001)
        .sort((a,b)=> b.kg - a.kg)
        .slice(0, 9);

      matsArr.forEach(m=>{
        const pct = totalRec ? (m.kg/totalRec)*100 : 0;
        const el = document.createElement("div");
        el.className = "bubble rounded-full p-4 md:p-5 flex flex-col items-center justify-center text-center min-h-[150px]";
        el.innerHTML = `
          <div class="text-3xl">${m.icon}</div>
          <div class="mt-1 text-2xl font-extrabold">${pct.toFixed(1).replace(".", ",")}%</div>
          <div class="text-sm text-graphite/70">${fmt(m.kg)} kg</div>
          <div class="mt-2 text-xs font-extrabold">${m.key}</div>
        `;
        bubbles.appendChild(el);
      });

      if(!matsArr.length){
        bubbles.innerHTML = `<div class="col-span-full text-center text-sm text-graphite/60 py-6">
          Sem dados de materiais ainda (fa√ßa um ‚ÄúFinal do turno‚Äù para aparecer o breakdown).
        </div>`;
      }

      // series chart (ordena datas)
      const labels = Array.from(seriesMap.keys()).sort((a,b)=> a.localeCompare(b));
      const recSeries = labels.map(d => seriesMap.get(d).rec);
      const rejSeries = labels.map(d => seriesMap.get(d).rej);
      drawBar(labels, rejSeries, recSeries);

      // planilha
      renderTabela(items);
    }

    // ===========================
    // Firestore Listener
    // ===========================
    initMap();
    setDbStatus("conectando‚Ä¶", true);

    const colRef = collection(db, "coletasSeletivas");

    onSnapshot(colRef, (snapshot)=>{
      const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log("üî• Coletas carregadas:", items);
      setDbStatus(`conectado ‚úÖ (${items.length} registros)`, true);
      renderAll(items);
    }, (err)=>{
      console.error("Firestore error:", err);
      setDbStatus("erro (rules/bloqueio)", false);
      alert("Erro ao ler Firestore. Verifique suas regras de leitura (read).");
    });

    // ===========================
    // Pequeno apoio: se veio do cadastro
    // ===========================
    try{
      const last = localStorage.getItem("rb_last_coleta");
      if(last){
        const obj = JSON.parse(last);
        console.log("üü¢ √öltima coleta (cache):", obj);
      }
    }catch{}
  </script>
</body>
</html>