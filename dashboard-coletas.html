<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Coletas Seletivas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: {
            soft: "0 14px 40px rgba(46,46,46,.10)",
            card: "0 10px 26px rgba(13,59,102,.10)"
          }
        }
      }
    }
  </script>

  <style>
    .panel { background: #fff; border: 1px solid rgba(0,0,0,.06); box-shadow: 0 10px 26px rgba(13,59,102,.06); }
    .pill { background: #2ea86d; }
    .pill:hover{ filter: brightness(.97); }
    .dash-grid { grid-template-columns: 320px 1fr; }
    .dashed { border: 2px dashed rgba(0,0,0,.12); }
    .bubble {
      background: #edf6ef;
      border: 1px solid rgba(27,127,90,.12);
      box-shadow: 0 10px 18px rgba(27,127,90,.06);
    }
    .legend-dot { width: 18px; height: 10px; border-radius: 3px; }
    .leaflet-container { border-radius: 14px; }
    .soft-divider { border-top: 1px dashed rgba(0,0,0,.10); }

    /* dropdown */
    .dd { position: relative; }
    .dd-menu {
      position:absolute; top: 46px; left:0;
      background:#fff; border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 14px 40px rgba(13,59,102,.12);
      border-radius: 14px; padding: 10px;
      min-width: 230px;
      z-index: 50;
      display:none;
    }
    .dd.open .dd-menu { display:block; }
    .dd-item { padding:10px 10px; border-radius: 12px; cursor:pointer; font-size: 13px; }
    .dd-item:hover { background: rgba(0,0,0,.04); }
    .dd-label { font-size: 11px; color: rgba(46,46,46,.65); margin-bottom: 6px; }
    .input {
      width: 100%;
      border:1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
    }
    .input:focus{ box-shadow: 0 0 0 4px rgba(27,127,90,.12); border-color: rgba(27,127,90,.35); }
    .btn-clear{
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
    }
    .btn-clear:hover{ background: rgba(0,0,0,.03); }
  </style>
</head>

<body class="bg-grayClean text-graphite">
  <!-- TOP BAR -->
  <header class="bg-white border-b border-black/5">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center gap-3">
      <!-- Brand -->
      <div class="flex items-center gap-3 min-w-[260px]">
        <div class="h-10 w-10 rounded-xl bg-regen/10 flex items-center justify-center border border-regen/15">
          <span class="text-regen font-extrabold">RB</span>
        </div>
        <div class="leading-tight">
          <div class="text-xs text-graphite/70">vila do futuro</div>
          <div class="font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-[11px] text-graphite/55">Sustentabilidade na Quebrada</div>
        </div>
      </div>

      <!-- Pills (Filtros) -->
      <div class="flex-1 flex items-center justify-center gap-3 flex-wrap">
        <!-- DATA -->
        <div class="dd" id="ddData">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            DATA <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">Per√≠odo (opDate)</div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="text-[11px] text-graphite/60 mb-1">De</div>
                <input id="fStart" class="input" type="date">
              </div>
              <div>
                <div class="text-[11px] text-graphite/60 mb-1">At√©</div>
                <input id="fEnd" class="input" type="date">
              </div>
            </div>
            <div class="mt-2 flex gap-2">
              <button class="btn-clear w-full" id="btnApplyDate">Aplicar</button>
              <button class="btn-clear w-full" id="btnClearDate">Limpar</button>
            </div>
          </div>
        </div>

        <!-- M√äS -->
        <div class="dd" id="ddMes">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            M√äS <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">Selecione um m√™s</div>
            <div class="grid grid-cols-2 gap-2">
              <input id="fMonth" class="input" type="month">
              <button class="btn-clear" id="btnApplyMonth">Aplicar</button>
            </div>
            <button class="btn-clear w-full mt-2" id="btnClearMonth">Limpar</button>
          </div>
        </div>

        <!-- CICLO -->
        <div class="dd" id="ddCiclo">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            CICLO <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">Campo: cycle (se existir)</div>
            <input id="fCycle" class="input" placeholder="Ex.: C1, C2, 2026-01...">
            <button class="btn-clear w-full mt-2" id="btnApplyCycle">Aplicar</button>
            <button class="btn-clear w-full mt-2" id="btnClearCycle">Limpar</button>
          </div>
        </div>

        <!-- TIPO -->
        <div class="dd" id="ddTipo">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            TIPO DE COLETA <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">deliveryType</div>
            <div class="dd-item" data-type="">Todos</div>
            <div class="dd-item" data-type="Coleta domiciliar pelo triciclo">Coleta domiciliar pelo triciclo</div>
            <div class="dd-item" data-type="Coleta condom√≠nio">Coleta condom√≠nio</div>
            <div class="dd-item" data-type="Entrega volunt√°ria">Entrega volunt√°ria</div>
            <div class="dd-item" data-type="Coleta Com√©rcio">Coleta Com√©rcio</div>
          </div>
        </div>

        <!-- C√ìDIGO -->
        <div class="dd" id="ddCodigo">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            C√ìDIGO <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">linkedId (RB-xxxxxx / COND-xxxxxx)</div>
            <input id="fCodigo" class="input" placeholder="Ex.: RB-000123">
            <button class="btn-clear w-full mt-2" id="btnApplyCodigo">Aplicar</button>
            <button class="btn-clear w-full mt-2" id="btnClearCodigo">Limpar</button>
          </div>
        </div>

        <!-- limpar tudo -->
        <button class="btn-clear" id="btnClearAll">Limpar filtros</button>
      </div>

      <!-- Right -->
      <div class="min-w-[260px] flex justify-end">
        <div class="text-right">
          <div class="text-xs text-graphite/55">Dashboard ‚Ä¢ Coletas</div>
          <div class="text-[11px] text-graphite/50">Banco: <span id="dbStatus">conectando‚Ä¶</span></div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-[1400px] mx-auto px-4 py-4">
    <div class="grid dash-grid gap-4">
      <!-- LEFT SIDEBAR -->
      <aside class="space-y-4">
        <!-- KPIs -->
        <div class="panel rounded-2xl overflow-hidden">
          <div class="grid grid-cols-2">
            <div class="p-4 bg-regen/15 border-r border-black/5">
              <div class="text-3xl font-extrabold text-graphite" id="kpiDias">‚Äî</div>
              <div class="text-xs text-graphite/70">total de dias do projeto</div>
              <div class="text-[11px] text-graphite/60">In√≠cio: <span class="font-semibold" id="kpiInicio">‚Äî</span></div>
            </div>
            <div class="p-4 bg-regen/10">
              <div class="text-3xl font-extrabold text-graphite" id="kpiOps">‚Äî</div>
              <div class="text-xs text-graphite/70">opera√ß√µes realizadas</div>
              <div class="text-[11px] text-graphite/60">No filtro: <span class="font-semibold" id="kpiOpsFiltro">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Families / Condo -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="font-extrabold text-center">FAM√çLIAS</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">cadastradas</span>
                  <span class="font-bold" id="famCadastradas">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes</span>
                  <span class="font-bold" id="famParticipantes">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="famColetas">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="border-l border-black/10 pl-3">
              <div class="font-extrabold text-center">CONDOM√çNIO</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">cadastrados</span>
                  <span class="font-bold" id="condCadastrados">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes</span>
                  <span class="font-bold" id="condParticipantes">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="condColetas">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3 text-[11px] text-graphite/55">
            * Fam√≠lias/Condom√≠nios = baseado no prefixo do linkedId (RB-/COND-) nas coletas.
          </div>
        </div>

        <!-- Map -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">LOCALIZA√á√ÉO</div>
          <div class="mt-3">
            <div id="map" class="w-full h-[360px]"></div>
          </div>
          <div class="mt-2 text-[11px] text-center text-graphite/55">
            * Marcadores = coletas com latitude/longitude (se existirem no doc)
          </div>
        </div>

        <!-- Quality donut -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">QUALIDADE DO RES√çDUO</div>
          <div class="mt-4">
            <canvas id="chartQualidade" height="220"></canvas>
            <div class="mt-3 flex items-center justify-center gap-5 text-xs">
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#1B7F5A"></span> LIMPO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#F2C94C"></span> M√âDIO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#EF4444"></span> RUIM
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT CONTENT -->
      <section class="space-y-4">
        <!-- Summary row -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-4 items-stretch">
            <div class="col-span-12 md:col-span-2 flex items-center justify-center font-extrabold text-lg">
              GERAL
            </div>

            <div class="col-span-12 md:col-span-7 border-l border-black/10 pl-4">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">
                    ‚ôªÔ∏è
                  </div>
                  <div>
                    <div class="text-xl font-extrabold">
                      <span id="sumRecKg">‚Äî</span> kg <span class="ml-2">RECICL√ÅVEL</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-regen font-extrabold" id="sumRecPct">‚Äî</span> do total
                    </div>
                    <div class="text-sm text-graphite/70">
                      Receita total = <span class="font-extrabold">R$</span> <span class="font-extrabold" id="sumReceita">‚Äî</span>
                    </div>
                  </div>
                </div>

                <div class="hidden md:block w-px bg-black/10"></div>

                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-red-50 border border-red-100 flex items-center justify-center">
                    üóëÔ∏è
                  </div>
                  <div class="text-right">
                    <div class="text-xl font-extrabold">
                      <span id="sumRejKg">‚Äî</span> kg <span class="ml-2 text-red-600">REJEITO</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-red-600 font-extrabold" id="sumRejPct">‚Äî</span> do total
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-span-12 md:col-span-3">
              <div class="rounded-2xl bg-grayClean border border-black/10 p-4 h-full">
                <div class="text-xs font-extrabold text-graphite/70">RESUMO</div>
                <div class="mt-2 space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Total (kg)</span>
                    <span class="font-extrabold" id="sumTotalKg">‚Äî</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Opera√ß√µes</span>
                    <span class="font-extrabold" id="sumOps">‚Äî</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Dias (no filtro)</span>
                    <span class="font-extrabold" id="sumDiasFiltro">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-3 text-[11px] text-center text-graphite/55">
            Dica: preencha filtros acima para ver recortes. Sem filtros, mostra os √∫ltimos 500 registros.
          </div>
        </div>

        <!-- Middle -->
        <div class="grid grid-cols-12 gap-4">
          <!-- Bubbles materials -->
          <div class="col-span-12 lg:col-span-8 panel rounded-2xl p-4">
            <div class="text-center font-extrabold text-lg">TIPO DE MATERIAL RECICL√ÅVEL</div>
            <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total de recicl√°veis)</div>

            <div id="bubblesGrid" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
              <!-- JS preenche bolhas -->
            </div>
          </div>

          <!-- Right reject types -->
          <div class="col-span-12 lg:col-span-4 space-y-4">
            <div class="panel rounded-2xl p-4">
              <div class="text-center font-extrabold text-lg">TIPO DE REJEITO</div>
              <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total do rejeito)</div>

              <div class="mt-4 space-y-4">
                <div class="rounded-2xl bg-red-50 border border-red-100 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üêÄ</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoRecPct">‚Äî</div>
                  <div class="text-sm font-extrabold">N√ÉO RECICL√ÅVEL</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoRecKg">‚Äî</span> kg</div>
                </div>

                <div class="rounded-2xl bg-white border border-black/10 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üö´üí∞</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoComPct">‚Äî</div>
                  <div class="text-sm font-extrabold">N√ÉO COMERCIALIZADO</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoComKg">‚Äî</span> kg</div>
                </div>
              </div>
            </div>

            <div class="panel rounded-2xl p-4 dashed">
              <div class="text-center font-extrabold">OUTRO</div>
              <div class="mt-3 flex items-center justify-center text-5xl">üß¥</div>
              <div class="mt-2 text-center">
                <div class="text-3xl font-extrabold" id="outroKg">‚Äî</div>
                <div class="text-xs text-graphite/70">kg</div>
                <div class="mt-2 text-sm font-extrabold" id="outroLabel">√ìLEO DE COZINHA</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom chart -->
        <div class="panel rounded-2xl p-4">
          <div class="flex items-center gap-6 text-sm justify-center">
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#EF4444"></span> Peso do rejeito
            </div>
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#22C55E"></span> Peso do Recicl√°vel
            </div>
          </div>

          <div class="mt-3">
            <canvas id="chartBar" height="120"></canvas>
          </div>
          <div class="soft-divider mt-3 pt-2 text-xs text-center text-graphite/60">
            Participantes √∫nicos (no per√≠odo): <span id="uniqParticipants">‚Äî</span>
          </div>
        </div>

        <!-- Table -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-3 text-xs font-extrabold text-graphite/70 pb-2 border-b border-black/10">
            <div class="col-span-1">C√≥digo</div>
            <div class="col-span-2">Tipo de material recicl√°vel</div>
            <div class="col-span-2">Data de coleta</div>
            <div class="col-span-2">Qualidade</div>
            <div class="col-span-3">Observa√ß√£o</div>
            <div class="col-span-1 text-right">N√£o recicl√°vel (kg)</div>
            <div class="col-span-1 text-right">N√£o comercializado (kg)</div>
          </div>

          <div id="rows" class="divide-y divide-black/5 text-sm">
            <!-- JS preenche -->
          </div>

          <div class="mt-3 text-[11px] text-right text-graphite/50">
            Desenvolvido por voc√™ ‚Ä¢ Hub Resili√™ncia Clim√°tica
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===========================
       FIREBASE + DASHBOARD LOGIC
       =========================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  collection,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ===========================
   FIREBASE
=========================== */
      const firebaseConfig = {
  apiKey: "AIzaSyAe5E7M8Jednj1xGRjNrV0oD4wQwv6b-WM",
  authDomain: "reciclabonja-3dee7.firebaseapp.com",
  projectId: "reciclabonja-3dee7",
  storageBucket: "reciclabonja-3dee7.firebasestorage.app",
  messagingSenderId: "590941010829",
  appId: "1:590941010829:web:9b8e4703df54cc8b0a9bc4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===========================
   HELPERS
=========================== */

const fmt = (n) => Number(n || 0).toLocaleString("pt-BR", {
  minimumFractionDigits: 1,
  maximumFractionDigits: 1
});

function setText(id, value){
  const el = document.getElementById(id);
  if(el) el.textContent = value;
}

function toNumber(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}

/* ===========================
   RENDER TABELA (PLANILHA)
=========================== */

function renderTabela(items){

  const container = document.getElementById("rows");
  container.innerHTML = "";

  items.forEach(item => {

    const row = document.createElement("div");
    row.className = "grid grid-cols-12 gap-3 py-2 text-xs border-b border-black/5";

    const codigo = item.linkedId || item.codigoFamilia || item.codigoCondominio || "-";
    const tipo = item.flowType === "recebimento" ? "Recebimento" : "Final turno";
    const data = item.opDate || "-";

    const rejeito = item.flowType === "recebimento"
      ? fmt(item.pesoRejeitoKg)
      : fmt(item.pesoRejeitoGeralKg);

    const naoCom = item.pesoNaoComercializadoKg
      ? fmt(item.pesoNaoComercializadoKg)
      : "-";

    row.innerHTML = `
      <div class="col-span-2 font-semibold">${codigo}</div>
      <div class="col-span-2">${tipo}</div>
      <div class="col-span-2">${data}</div>
      <div class="col-span-2">${rejeito}</div>
      <div class="col-span-2">${naoCom}</div>
      <div class="col-span-2">${item.deliveryType || "-"}</div>
    `;

    container.appendChild(row);
  });
}

/* ===========================
   RENDER KPI
=========================== */

function renderKPIs(items){

  let totalRec = 0;
  let totalRej = 0;

  items.forEach(d => {

    if(d.flowType === "recebimento"){
      totalRec += toNumber(d.pesoResiduoSecoKg);
      totalRej += toNumber(d.pesoRejeitoKg);
    }

    if(d.flowType === "final_turno"){
      totalRej += toNumber(d.pesoRejeitoGeralKg);

      totalRec +=
        toNumber(d.plasticoKg) +
        toNumber(d.papelMistoKg) +
        toNumber(d.papelaoKg) +
        toNumber(d.aluminioMetalKg) +
        toNumber(d.vidroKg) +
        toNumber(d.sacariaKg) +
        toNumber(d.isoporKg) +
        toNumber(d.oleoKg);
    }

  });

  setText("kpiOps", items.length);
  setText("sumRecKg", fmt(totalRec));
  setText("sumRejKg", fmt(totalRej));
  setText("sumTotalKg", fmt(totalRec + totalRej));
}

/* ===========================
   FIRESTORE LISTENER
=========================== */

const colRef = collection(db, "coletasSeletivas");

onSnapshot(colRef, (snapshot) => {

  const items = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  console.log("üî• Dados carregados:", items);

  renderKPIs(items);
  renderTabela(items);

}, (error) => {
  console.error("Erro ao carregar Firestore:", error);
  alert("Erro ao carregar dados do Firestore.\nVerifique regras ou conex√£o.");
});

</script>
</body>
</html>