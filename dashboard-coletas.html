<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Coletas Seletivas</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: {
            soft: "0 14px 40px rgba(46,46,46,.10)",
            card: "0 10px 26px rgba(13,59,102,.10)"
          }
        }
      }
    }
  </script>

  <style>
    .panel { background: #fff; border: 1px solid rgba(0,0,0,.06); box-shadow: 0 10px 26px rgba(13,59,102,.06); }
    .pill { background: #2ea86d; }
    .pill:hover{ filter: brightness(.97); }
    .dash-grid { grid-template-columns: 320px 1fr; }
    .legend-dot { width: 18px; height: 10px; border-radius: 3px; }
    .leaflet-container { border-radius: 14px; }
    .soft-divider { border-top: 1px dashed rgba(0,0,0,.10); }
  </style>
</head>

<body class="bg-grayClean text-graphite">
  <header class="bg-white border-b border-black/5">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3 min-w-[260px]">
        <div class="h-10 w-10 rounded-xl bg-regen/10 flex items-center justify-center border border-regen/15">
          <span class="text-regen font-extrabold">RB</span>
        </div>
        <div class="leading-tight">
          <div class="text-xs text-graphite/70">vila do futuro</div>
          <div class="font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-[11px] text-graphite/55">Dashboard ‚Ä¢ Coletas</div>
        </div>
      </div>

      <div class="flex-1 flex items-center justify-center gap-3 flex-wrap">
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          DATA <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          M√äS <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          TIPO <span class="text-white/90">‚ñæ</span>
        </button>
      </div>

      <div class="min-w-[260px] flex justify-end items-center gap-3">
        <span class="text-xs text-graphite/55">Firestore: <span id="dbStatus" class="font-semibold">conectando‚Ä¶</span></span>
        <a href="cadastro-coletas.html" class="text-xs font-bold text-regen hover:underline">Cadastrar coleta</a>
      </div>
    </div>
  </header>

  <main class="max-w-[1400px] mx-auto px-4 py-4">
    <div class="grid dash-grid gap-4">
      <!-- LEFT -->
      <aside class="space-y-4">
        <div class="panel rounded-2xl overflow-hidden">
          <div class="grid grid-cols-2">
            <div class="p-4 bg-regen/15 border-r border-black/5">
              <div class="text-3xl font-extrabold text-graphite" id="kpiDias">‚Äî</div>
              <div class="text-xs text-graphite/70">dias com registros</div>
            </div>
            <div class="p-4 bg-regen/10">
              <div class="text-3xl font-extrabold text-graphite" id="kpiOps">0</div>
              <div class="text-xs text-graphite/70">opera√ß√µes</div>
            </div>
          </div>
        </div>

        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">LOCALIZA√á√ÉO</div>
          <div class="mt-3">
            <div id="map" class="w-full h-[360px]"></div>
          </div>
          <div class="mt-2 text-[11px] text-graphite/55">
            * Mapa est√° ‚Äúbase‚Äù (sem lat/lng nas coletas).
          </div>
        </div>

        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">QUALIDADE DO RES√çDUO</div>
          <div class="mt-4">
            <canvas id="chartQualidade" height="220"></canvas>
          </div>
        </div>
      </aside>

      <!-- RIGHT -->
      <section class="space-y-4">
        <!-- Summary -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-4 items-stretch">
            <div class="col-span-12 md:col-span-7">
              <div class="flex items-center justify-between gap-4">
                <div>
                  <div class="text-xl font-extrabold"><span id="sumRecKg">0,0</span> kg RECICL√ÅVEL</div>
                  <div class="text-sm text-graphite/70"><span class="text-regen font-extrabold" id="sumRecPct">0,0%</span> do total</div>
                </div>
                <div class="w-px bg-black/10 hidden md:block"></div>
                <div class="text-right">
                  <div class="text-xl font-extrabold"><span id="sumRejKg">0,0</span> kg <span class="text-red-600">REJEITO</span></div>
                  <div class="text-sm text-graphite/70"><span class="text-red-600 font-extrabold" id="sumRejPct">0,0%</span> do total</div>
                </div>
              </div>
            </div>

            <div class="col-span-12 md:col-span-5">
              <div class="rounded-2xl bg-grayClean border border-black/10 p-4 h-full">
                <div class="text-xs font-extrabold text-graphite/70">RESUMO</div>
                <div class="mt-2 space-y-2 text-sm">
                  <div class="flex items-center justify-between"><span class="text-graphite/70">Total (kg)</span><span class="font-extrabold" id="sumTotalKg">0,0</span></div>
                  <div class="flex items-center justify-between"><span class="text-graphite/70">Opera√ß√µes</span><span class="font-extrabold" id="sumOps">0</span></div>
                  <div class="flex items-center justify-between"><span class="text-graphite/70">Dias</span><span class="font-extrabold" id="sumDiasFiltro">‚Äî</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bar chart -->
        <div class="panel rounded-2xl p-4">
          <div class="flex items-center gap-6 text-sm justify-center">
            <div class="flex items-center gap-2"><span class="legend-dot" style="background:#EF4444"></span> Rejeito</div>
            <div class="flex items-center gap-2"><span class="legend-dot" style="background:#22C55E"></span> Recicl√°vel</div>
          </div>
          <div class="mt-3"><canvas id="chartBar" height="120"></canvas></div>
        </div>

        <!-- PLANILHA -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-3 text-xs font-extrabold text-graphite/70 pb-2 border-b border-black/10">
            <div class="col-span-2">C√≥digo/ID</div>
            <div class="col-span-2">Fluxo</div>
            <div class="col-span-2">Data</div>
            <div class="col-span-2 text-right">Recicl√°vel (kg)</div>
            <div class="col-span-2 text-right">Rejeito (kg)</div>
            <div class="col-span-2 text-right">N√£o com. (kg)</div>
          </div>

          <div id="rows" class="divide-y divide-black/5 text-sm"></div>

          <div class="mt-3 text-[11px] text-right text-graphite/50">Recicla Bonja</div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
      apiKey: "AIzaSyAQBmh8uwLTkyabQc_GznBBV1X2dPhActE",
      authDomain: "recicla-bonja.firebaseapp.com",
      projectId: "recicla-bonja",
      storageBucket: "recicla-bonja.firebasestorage.app",
      messagingSenderId: "557210456406",
      appId: "1:557210456406:web:4eebf082cc0d15580c86f7"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fmt = (n, dec=1) => Number(n || 0).toLocaleString("pt-BR", { minimumFractionDigits: dec, maximumFractionDigits: dec });
    const toNum = (x) => { const n = Number(x); return Number.isFinite(n) ? n : 0; };
    const setText = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };

    function setDbStatus(text, ok=true){
      const el = document.getElementById("dbStatus");
      el.textContent = text;
      el.className = ok ? "font-semibold text-regen" : "font-semibold text-red-700";
    }

    // map base
    const map = L.map('map', { zoomControl: true }).setView([-30.0346, -51.2177], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    // charts
    let chartQualidade, chartBar;

    function drawQualidade(limpo, medio, ruim){
      if(chartQualidade) chartQualidade.destroy();
      chartQualidade = new Chart(document.getElementById("chartQualidade"), {
        type: "doughnut",
        data: { labels:["LIMPO","M√âDIO","RUIM"], datasets:[{ data:[limpo, medio, ruim], backgroundColor:["#1B7F5A","#F2C94C","#EF4444"], borderWidth:0 }] },
        options: { cutout:"70%", plugins:{ legend:{display:false} } }
      });
    }

    function drawBar(labels, rejeito, reciclavel){
      if(chartBar) chartBar.destroy();
      chartBar = new Chart(document.getElementById("chartBar"), {
        type:"bar",
        data:{
          labels,
          datasets:[
            { label:"Rejeito", data: rejeito, backgroundColor:"#EF4444", stack:"s1", borderWidth:0 },
            { label:"Recicl√°vel", data: reciclavel, backgroundColor:"#22C55E", stack:"s1", borderWidth:0 }
          ]
        },
        options:{
          responsive:true,
          plugins:{ legend:{display:false} },
          scales:{
            x:{ stacked:true, grid:{display:false}, ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:18, font:{size:10} } },
            y:{ stacked:true, grid:{ color:"rgba(0,0,0,.06)" }, ticks:{ font:{size:10} } }
          }
        }
      });
    }

    function calcRecFinal(d){
      // soma materiais + extras
      let rec =
        toNum(d.plasticoKg)+toNum(d.papelMistoKg)+toNum(d.papelaoKg)+toNum(d.aluminioMetalKg)+
        toNum(d.vidroKg)+toNum(d.sacariaKg)+toNum(d.isoporKg)+toNum(d.oleoKg);

      if(Array.isArray(d.materiaisExtras)){
        rec += d.materiaisExtras.reduce((acc, it)=> acc + toNum(it?.kg), 0);
      }
      return rec;
    }

    function renderTable(items){
      const rows = document.getElementById("rows");
      rows.innerHTML = "";

      // ordena por data desc
      items.sort((a,b)=> String(b.opDate||"").localeCompare(String(a.opDate||"")));

      if(!items.length){
        rows.innerHTML = `<div class="py-4 text-sm text-graphite/60">Nenhuma coleta encontrada.</div>`;
        return;
      }

      items.slice(0, 200).forEach(d=>{
        const codigo = d.linkedId || d.codigoFamilia || d.codigoCondominio || "-";
        const fluxo = d.flowType === "recebimento" ? "Recebimento" : "Final turno";
        const data = d.opDate || "-";

        let recKg = 0, rejKg = 0, naoComKg = 0;

        if(d.flowType === "recebimento"){
          recKg = toNum(d.pesoResiduoSecoKg);
          rejKg = toNum(d.pesoRejeitoKg);
          naoComKg = toNum(d.pesoNaoComercializadoKg);
        } else {
          recKg = calcRecFinal(d);
          rejKg = toNum(d.pesoRejeitoGeralKg);
          naoComKg = 0;
        }

        const row = document.createElement("div");
        row.className = "grid grid-cols-12 gap-3 py-2 text-xs";
        row.innerHTML = `
          <div class="col-span-2 font-semibold">${codigo}</div>
          <div class="col-span-2">${fluxo}</div>
          <div class="col-span-2">${data}</div>
          <div class="col-span-2 text-right">${fmt(recKg)}</div>
          <div class="col-span-2 text-right">${fmt(rejKg)}</div>
          <div class="col-span-2 text-right">${d.flowType === "recebimento" ? fmt(naoComKg) : "-"}</div>
        `;
        rows.appendChild(row);
      });
    }

    function renderAll(items){
      setText("kpiOps", items.length);
      setText("sumOps", items.length);

      // agrega√ß√µes
      let totalRec = 0, totalRej = 0;
      let q1=0, q2=0, q3=0;
      const perDay = new Map(); // date => {rec, rej}

      items.forEach(d=>{
        const date = d.opDate || "sem-data";
        if(!perDay.has(date)) perDay.set(date, {rec:0, rej:0});

        if(d.flowType === "recebimento"){
          const rec = toNum(d.pesoResiduoSecoKg);
          const rej = toNum(d.pesoRejeitoKg);

          totalRec += rec;
          totalRej += rej;

          perDay.get(date).rec += rec;
          perDay.get(date).rej += rej;

          if(d.qualidadeNota === 1) q1++;
          if(d.qualidadeNota === 2) q2++;
          if(d.qualidadeNota === 3) q3++;
        } else {
          const rec = calcRecFinal(d);
          const rej = toNum(d.pesoRejeitoGeralKg);

          totalRec += rec;
          totalRej += rej;

          perDay.get(date).rec += rec;
          perDay.get(date).rej += rej;
        }
      });

      const total = totalRec + totalRej;
      const recPct = total ? (totalRec/total)*100 : 0;
      const rejPct = total ? (totalRej/total)*100 : 0;

      setText("sumRecKg", fmt(totalRec));
      setText("sumRejKg", fmt(totalRej));
      setText("sumTotalKg", fmt(total));
      setText("sumRecPct", recPct.toFixed(1).replace(".", ",") + "%");
      setText("sumRejPct", rejPct.toFixed(1).replace(".", ",") + "%");

      const dates = Array.from(perDay.keys()).filter(x=>x!=="sem-data");
      setText("kpiDias", dates.length);
      setText("sumDiasFiltro", dates.length);

      drawQualidade(q3, q2, q1);

      const labels = dates.sort((a,b)=> a.localeCompare(b));
      const recArr = labels.map(d=> perDay.get(d).rec);
      const rejArr = labels.map(d=> perDay.get(d).rej);
      drawBar(labels, rejArr, recArr);

      renderTable(items);
    }

    setDbStatus("conectando‚Ä¶", true);

    onSnapshot(collection(db, "coletasSeletivas"), (snap)=>{
      const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log("üî• Coletas carregadas:", items);
      setDbStatus(`conectado ‚úÖ (${items.length})`, true);
      renderAll(items);
    }, (err)=>{
      console.error(err);
      setDbStatus("erro (rules)", false);
      alert("Erro ao ler Firestore. Verifique as regras e publique.");
    });

    // toast simples ao voltar do cadastro
    try{
      const url = new URL(window.location.href);
      const newId = url.searchParams.get("new");
      if(newId){
        console.log("‚úÖ Nova coleta:", newId);
        url.searchParams.delete("new");
        window.history.replaceState({}, "", url.toString());
      }
    }catch{}
  </script>
</body>
</html>