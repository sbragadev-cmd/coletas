<!doctype html> 
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Coletas Seletivas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: {
            soft: "0 14px 40px rgba(46,46,46,.10)",
            card: "0 10px 26px rgba(13,59,102,.10)"
          }
        }
      }
    }
  </script>

  <style>
    .panel { background: #fff; border: 1px solid rgba(0,0,0,.06); box-shadow: 0 10px 26px rgba(13,59,102,.06); }
    .pill { background: #2ea86d; } /* verde bot√£o do print */
    .pill:hover{ filter: brightness(.97); }
    .dash-grid { grid-template-columns: 320px 1fr; }
    .dashed { border: 2px dashed rgba(0,0,0,.12); }

    .bubble {
      background: #edf6ef;
      border: 1px solid rgba(27,127,90,.12);
      box-shadow: 0 10px 18px rgba(27,127,90,.06);
    }

    .legend-dot { width: 18px; height: 10px; border-radius: 3px; }
    .leaflet-container { border-radius: 14px; }
    .soft-divider { border-top: 1px dashed rgba(0,0,0,.10); }
  </style>
</head>

<body class="bg-grayClean text-graphite">
  <!-- TOP BAR -->
  <header class="bg-white border-b border-black/5">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center gap-3">
      <!-- Brand -->
      <div class="flex items-center gap-3 min-w-[260px]">
        <div class="h-10 w-10 rounded-xl bg-regen/10 flex items-center justify-center border border-regen/15">
          <span class="text-regen font-extrabold">RB</span>
        </div>
        <div class="leading-tight">
          <div class="text-xs text-graphite/70">vila do futuro</div>
          <div class="font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-[11px] text-graphite/55">Sustentabilidade na Quebrada</div>
        </div>
      </div>

      <!-- Pills (Filtros) -->
      <div class="flex-1 flex items-center justify-center gap-3 flex-wrap">
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          DATA <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          M√äS <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          CICLO <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          TIPO DE COLETA <span class="text-white/90">‚ñæ</span>
        </button>
        <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2">
          C√ìDIGO <span class="text-white/90">‚ñæ</span>
        </button>
      </div>

      <!-- Right slot -->
      <div class="min-w-[260px] flex justify-end items-center gap-3">
        <a href="index.html" class="text-xs font-bold text-graphite/70 hover:underline">Menu</a>
        <a href="cadastro-coleta.html" class="text-xs font-bold text-regen hover:underline">Cadastrar coleta</a>
        <span class="text-xs text-graphite/55">Firestore: <span id="dbStatus" class="font-semibold">conectando‚Ä¶</span></span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-[1400px] mx-auto px-4 py-4">
    <div class="grid dash-grid gap-4">
      <!-- LEFT SIDEBAR -->
      <aside class="space-y-4">
        <!-- KPIs -->
        <div class="panel rounded-2xl overflow-hidden">
          <div class="grid grid-cols-2">
            <div class="p-4 bg-regen/15 border-r border-black/5">
              <div class="text-3xl font-extrabold text-graphite" id="kpiDias">‚Äî</div>
              <div class="text-xs text-graphite/70">total de dias com registros</div>
              <div class="text-[11px] text-graphite/60">Primeiro registro: <span class="font-semibold" id="kpiInicio">‚Äî</span></div>
            </div>
            <div class="p-4 bg-regen/10">
              <div class="text-3xl font-extrabold text-graphite" id="kpiOps">0</div>
              <div class="text-xs text-graphite/70">opera√ß√µes realizadas</div>
            </div>
          </div>
        </div>

        <!-- Families / Condo -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="font-extrabold text-center">FAM√çLIAS</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">c√≥digos √∫nicos</span>
                  <span class="font-bold" id="famCadastradas">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes (est.)</span>
                  <span class="font-bold" id="famParticipantes">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="famColetas">0</span>
                </div>
              </div>
            </div>

            <div class="border-l border-black/10 pl-3">
              <div class="font-extrabold text-center">CONDOM√çNIO</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">c√≥digos √∫nicos</span>
                  <span class="font-bold" id="condCadastrados">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes (est.)</span>
                  <span class="font-bold" id="condParticipantes">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="condColetas">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Map -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">LOCALIZA√á√ÉO</div>
          <div class="mt-3">
            <div id="map" class="w-full h-[360px]"></div>
          </div>
          <div class="mt-2 text-[11px] text-graphite/55">
            * Sem lat/lng nas coletas ‚Üí mapa base (Porto Alegre).
          </div>
        </div>

        <!-- Quality donut -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">QUALIDADE DO RES√çDUO</div>
          <div class="mt-4">
            <canvas id="chartQualidade" height="220"></canvas>
            <div class="mt-3 flex items-center justify-center gap-5 text-xs">
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#1B7F5A"></span> LIMPO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#F2C94C"></span> M√âDIO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#EF4444"></span> RUIM
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT CONTENT -->
      <section class="space-y-4">
        <!-- Summary row -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-4 items-stretch">
            <div class="col-span-12 md:col-span-2 flex items-center justify-center font-extrabold text-lg">
              GERAL
            </div>

            <div class="col-span-12 md:col-span-7 border-l border-black/10 pl-4">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">
                    ‚ôªÔ∏è
                  </div>
                  <div>
                    <div class="text-xl font-extrabold">
                      <span id="sumRecKg">0,0</span> kg <span class="ml-2">RECICL√ÅVEL</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-regen font-extrabold" id="sumRecPct">0,0%</span> do total
                    </div>
                    <div class="text-sm text-graphite/70">
                      Receita total = <span class="font-extrabold">R$</span> <span class="font-extrabold" id="sumReceita">0,0</span>
                    </div>
                  </div>
                </div>

                <div class="hidden md:block w-px bg-black/10"></div>

                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-red-50 border border-red-100 flex items-center justify-center">
                    üóëÔ∏è
                  </div>
                  <div class="text-right">
                    <div class="text-xl font-extrabold">
                      <span id="sumRejKg">0,0</span> kg <span class="ml-2 text-red-600">REJEITO</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-red-600 font-extrabold" id="sumRejPct">0,0%</span> do total
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-span-12 md:col-span-3">
              <div class="rounded-2xl bg-grayClean border border-black/10 p-4 h-full">
                <div class="text-xs font-extrabold text-graphite/70">RESUMO</div>
                <div class="mt-2 space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Total (kg)</span>
                    <span class="font-extrabold" id="sumTotalKg">0,0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Opera√ß√µes</span>
                    <span class="font-extrabold" id="sumOps">0</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Dias (no filtro)</span>
                    <span class="font-extrabold" id="sumDiasFiltro">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Middle: bubbles + right reject breakdown -->
        <div class="grid grid-cols-12 gap-4">
          <!-- Bubbles materials -->
          <div class="col-span-12 lg:col-span-8 panel rounded-2xl p-4">
            <div class="text-center font-extrabold text-lg">TIPO DE MATERIAL RECICL√ÅVEL</div>
            <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total de recicl√°veis)</div>

            <div id="bubblesGrid" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
          </div>

          <!-- Right reject types -->
          <div class="col-span-12 lg:col-span-4 space-y-4">
            <div class="panel rounded-2xl p-4">
              <div class="text-center font-extrabold text-lg">TIPO DE REJEITO</div>
              <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total do rejeito)</div>

              <div class="mt-4 space-y-4">
                <div class="rounded-2xl bg-red-50 border border-red-100 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üêÄ</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoRecPct">0,0%</div>
                  <div class="text-sm font-extrabold">N√ÉO RECICL√ÅVEL</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoRecKg">0,0</span> kg</div>
                </div>

                <div class="rounded-2xl bg-white border border-black/10 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üö´üí∞</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoComPct">0,0%</div>
                  <div class="text-sm font-extrabold">N√ÉO COMERCIALIZADO</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoComKg">0,0</span> kg</div>
                </div>
              </div>
            </div>

            <div class="panel rounded-2xl p-4 dashed">
              <div class="text-center font-extrabold">OUTRO</div>
              <div class="mt-3 flex items-center justify-center text-5xl">üß¥</div>
              <div class="mt-2 text-center">
                <div class="text-3xl font-extrabold" id="outroKg">0,0</div>
                <div class="text-xs text-graphite/70">kg</div>
                <div class="mt-2 text-sm font-extrabold">√ìLEO DE COZINHA</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom chart -->
        <div class="panel rounded-2xl p-4">
          <div class="flex items-center gap-6 text-sm justify-center">
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#EF4444"></span> Peso do rejeito
            </div>
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#22C55E"></span> Peso do Recicl√°vel
            </div>
          </div>

          <div class="mt-3">
            <canvas id="chartBar" height="120"></canvas>
          </div>
          <div class="soft-divider mt-3 pt-2 text-xs text-center text-graphite/60">
            Total de fam√≠lias/condom√≠nios participantes (no per√≠odo)
          </div>
        </div>

        <!-- Table (planilha) -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-3 text-xs font-extrabold text-graphite/70 pb-2 border-b border-black/10">
            <div class="col-span-1">C√≥digo</div>
            <div class="col-span-2">Tipo de material recicl√°vel</div>
            <div class="col-span-2">Data de coleta</div>
            <div class="col-span-2">Qualidade</div>
            <div class="col-span-3">Observa√ß√£o</div>
            <div class="col-span-1 text-right">N√£o recicl√°vel (kg)</div>
            <div class="col-span-1 text-right">N√£o comercializado (kg)</div>
          </div>

          <div id="rows" class="divide-y divide-black/5 text-sm"></div>

          <div class="mt-3 text-[11px] text-right text-graphite/50">
            Desenvolvido por voc√™ ‚Ä¢ Hub Resili√™ncia Clim√°tica
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- FIREBASE / DASHBOARD LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

 const firebaseConfig = {
  apiKey: "AIzaSyAe5E7M8Jednj1xGRjNrV0oD4wQwv6b-WM",
  authDomain: "reciclabonja-3dee7.firebaseapp.com",
  projectId: "reciclabonja-3dee7",
  storageBucket: "reciclabonja-3dee7.firebasestorage.app",
  messagingSenderId: "590941010829",
  appId: "1:590941010829:web:9b8e4703df54cc8b0a9bc4"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== helpers
    const fmtPt = (n, dec=1) => Number(n || 0).toLocaleString("pt-BR", {minimumFractionDigits: dec, maximumFractionDigits: dec});
    const setText = (id, v) => { const el=document.getElementById(id); if(el) el.textContent = v; };
    const toNum = (x) => { const n = Number(x); return Number.isFinite(n) ? n : 0; };

    function setDbStatus(text, ok=true){
      const el = document.getElementById("dbStatus");
      el.textContent = text;
      el.className = ok ? "font-semibold text-regen" : "font-semibold text-red-700";
    }

    // ===== map base (sem lat/lng nas coletas)
    const map = L.map('map', { zoomControl: true }).setView([-30.0346, -51.2177], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    // marcadores ‚Äúplaceholder‚Äù
    [[-30.0346, -51.2177],[-30.0401,-51.2102],[-30.0282,-51.2303]].forEach((p,i)=>{
      L.circleMarker(p, { radius:7, color:"#1B7F5A", fillColor:"#4CAF8F", fillOpacity:.9, weight:2 })
        .addTo(map).bindPopup("Ponto "+(i+1));
    });

    // ===== charts
    let chartQualidade, chartBar;

    function drawQualidade(limpo, medio, ruim){
      if(chartQualidade) chartQualidade.destroy();
      chartQualidade = new Chart(document.getElementById("chartQualidade"), {
        type: "doughnut",
        data: {
          labels: ["LIMPO", "M√âDIO", "RUIM"],
          datasets: [{
            data: [limpo, medio, ruim],
            backgroundColor: ["#1B7F5A", "#F2C94C", "#EF4444"],
            borderWidth: 0
          }]
        },
        options: { cutout: "70%", plugins: { legend: { display:false } } }
      });
    }

    function drawBar(labels, rejeito, reciclavel){
      if(chartBar) chartBar.destroy();
      chartBar = new Chart(document.getElementById("chartBar"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Peso do rejeito", data: rejeito, backgroundColor: "#EF4444", stack:"stack1", borderWidth:0 },
            { label: "Peso do Recicl√°vel", data: reciclavel, backgroundColor: "#22C55E", stack:"stack1", borderWidth:0 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: {
            x: { stacked:true, grid: { display:false }, ticks: { maxRotation:0, autoSkip:true, maxTicksLimit:18, font:{size:10} } },
            y: { stacked:true, grid: { color: "rgba(0,0,0,.06)" }, ticks: { font:{size:10} } }
          }
        }
      });
    }

    // ===== c√°lculos (compat√≠vel com cadastro-coletas)
    const MATERIALS = [
      { key:"PL√ÅSTICO", field:"plasticoKg", icon:"üß¥" },
      { key:"VIDRO", field:"vidroKg", icon:"üçæ" },
      { key:"METAL", field:"aluminioMetalKg", icon:"ü•´" },
      { key:"SACARIA", field:"sacariaKg", icon:"üõçÔ∏è" },
      { key:"PAPEL MISTO", field:"papelMistoKg", icon:"üìÑ" },
      { key:"PAPEL√ÉO", field:"papelaoKg", icon:"üì¶" },
      { key:"ISOPOR", field:"isoporKg", icon:"üç±" },
      { key:"√ìLEO", field:"oleoKg", icon:"üß¥" },
    ];

    function calcFinalRecKg(d){
      let sum = 0;
      MATERIALS.forEach(m => sum += toNum(d[m.field]));
      if(Array.isArray(d.materiaisExtras)){
        sum += d.materiaisExtras.reduce((acc, it)=> acc + toNum(it?.kg), 0);
      }
      return sum;
    }

    function normalizeRowForTable(d){
      // tabela do layout √© ‚Äútipo de material recicl√°vel‚Äù, mas o recebimento n√£o tem tipo.
      // ent√£o:
      // - recebimento: mostra "Res√≠duo seco (geral)"
      // - final_turno: mostra "Final do turno (agregado)"
      const codigo = d.linkedId || d.codigoFamilia || d.codigoCondominio || "‚Äî";
      const tipo = (d.flowType === "recebimento") ? "Res√≠duo seco (geral)" : "Final do turno (agregado)";
      const data = d.opDate ? new Date(d.opDate + "T00:00:00").toLocaleDateString("pt-BR") : "‚Äî";

      const qualidade = (d.flowType === "recebimento")
        ? (d.qualidadeNota === 1 ? "RUIM" : d.qualidadeNota === 2 ? "M√âDIO" : d.qualidadeNota === 3 ? "BOM" : "‚Äî")
        : "‚Äî";

      const obs = d.observacao || "‚Äî";
      const naoRecKg = (d.flowType === "recebimento") ? toNum(d.pesoRejeitoKg) : toNum(d.pesoRejeitoGeralKg);
      const naoComKg = (d.flowType === "recebimento") ? toNum(d.pesoNaoComercializadoKg) : 0;

      return { codigo, tipo, data, qualidade, obs, naoRecKg, naoComKg };
    }

    function renderTable(items){
      const wrap = document.getElementById("rows");
      wrap.innerHTML = "";

      if(!items.length){
        wrap.innerHTML = `<div class="py-4 text-sm text-graphite/60">Nenhuma coleta encontrada no Firestore.</div>`;
        return;
      }

      // ordem por data desc
      items.sort((a,b)=> String(b.opDate||"").localeCompare(String(a.opDate||"")));

      items.slice(0, 200).forEach(d=>{
        const r = normalizeRowForTable(d);
        const row = document.createElement("div");
        row.className = "grid grid-cols-12 gap-3 py-2 text-xs";
        row.innerHTML = `
          <div class="col-span-1 font-semibold">${r.codigo}</div>
          <div class="col-span-2">${r.tipo}</div>
          <div class="col-span-2">${r.data}</div>
          <div class="col-span-2 font-semibold">${r.qualidade}</div>
          <div class="col-span-3 text-graphite/70">${r.obs}</div>
          <div class="col-span-1 text-right">${fmtPt(r.naoRecKg,1)}</div>
          <div class="col-span-1 text-right">${fmtPt(r.naoComKg,1)}</div>
        `;
        wrap.appendChild(row);
      });
    }

    function renderBubbles(materialTotals, recTotalKg){
      const grid = document.getElementById("bubblesGrid");
      grid.innerHTML = "";

      // monta as bolhas do layout (usa os materiais do final_turno; recebimento entra em "PAPEL MISTO" por fallback? aqui n√£o entra)
      const list = MATERIALS.map(m=>{
        const kg = toNum(materialTotals[m.field]);
        const pct = recTotalKg ? (kg/recTotalKg)*100 : 0;
        return { key:m.key, kg, pct, receita: 0, icon:m.icon };
      }).filter(x=> x.kg > 0 || x.key); // sempre mostra, mesmo 0 (pra manter grade)

      list.slice(0,7).forEach(m=>{
        const el = document.createElement("div");
        el.className = "bubble rounded-full p-4 md:p-5 flex flex-col items-center justify-center text-center min-h-[150px]";
        el.innerHTML = `
          <div class="text-3xl">${m.icon}</div>
          <div class="mt-1 text-2xl font-extrabold">${m.pct.toFixed(1).replace(".", ",")}%</div>
          <div class="text-sm text-graphite/70">${fmtPt(m.kg,1)} kg</div>
          <div class="text-[11px] text-graphite/60 mt-1">Receita = <span class="font-bold">R$ ${fmtPt(m.receita,1)}</span></div>
          <div class="mt-2 text-xs font-extrabold">${m.key}</div>
        `;
        grid.appendChild(el);
      });
    }

    function renderAll(items){
      setText("kpiOps", items.length);
      setText("sumOps", items.length);

      // dias
      const uniqueDays = new Set(items.map(d=>d.opDate).filter(Boolean));
      setText("kpiDias", uniqueDays.size);
      setText("sumDiasFiltro", uniqueDays.size);

      // in√≠cio
      const datesSorted = Array.from(uniqueDays).sort((a,b)=> a.localeCompare(b));
      setText("kpiInicio", datesSorted.length ? new Date(datesSorted[0]+"T00:00:00").toLocaleDateString("pt-BR") : "‚Äî");

      // fam√≠lias vs condom√≠nio (simples)
      let famColetas = 0, condColetas = 0;
      const famCodes = new Set();
      const condCodes = new Set();

      // qualidade
      let q1=0, q2=0, q3=0;

      // total
      let totalRec = 0;
      let totalRej = 0;
      let totalNaoCom = 0;

      // materiais (final_turno)
      const materialTotals = {
        plasticoKg:0, vidroKg:0, aluminioMetalKg:0, sacariaKg:0,
        papelMistoKg:0, papelaoKg:0, isoporKg:0, oleoKg:0
      };

      // s√©ries por dia
      const perDay = new Map(); // date -> {rec, rej}
      items.forEach(d=>{
        const date = d.opDate || "sem-data";
        if(!perDay.has(date)) perDay.set(date, {rec:0, rej:0});

        // contagem fam/cond
        const isCond = (d.deliveryType === "Coleta condom√≠nio") || !!d.codigoCondominio;
        if(isCond){
          condColetas++;
          if(d.linkedId) condCodes.add(d.linkedId);
          if(d.codigoCondominio) condCodes.add(d.codigoCondominio);
        }else{
          famColetas++;
          if(d.linkedId) famCodes.add(d.linkedId);
          if(d.codigoFamilia) famCodes.add(d.codigoFamilia);
        }

        if(d.flowType === "recebimento"){
          const rec = toNum(d.pesoResiduoSecoKg);
          const rej = toNum(d.pesoRejeitoKg);
          const naoCom = toNum(d.pesoNaoComercializadoKg);

          totalRec += rec;
          totalRej += rej;
          totalNaoCom += naoCom;

          perDay.get(date).rec += rec;
          perDay.get(date).rej += rej;

          if(d.qualidadeNota === 1) q1++;
          if(d.qualidadeNota === 2) q2++;
          if(d.qualidadeNota === 3) q3++;

        } else {
          const rec = calcFinalRecKg(d);
          const rej = toNum(d.pesoRejeitoGeralKg);

          totalRec += rec;
          totalRej += rej;

          perDay.get(date).rec += rec;
          perDay.get(date).rej += rej;

          // soma materiais por categoria
          Object.keys(materialTotals).forEach(k => materialTotals[k] += toNum(d[k]));
        }
      });

      // fam√≠lias/cond cards
      setText("famCadastradas", famCodes.size);
      setText("famParticipantes", famCodes.size); // estimativa
      setText("famColetas", famColetas);

      setText("condCadastrados", condCodes.size);
      setText("condParticipantes", condCodes.size); // estimativa
      setText("condColetas", condColetas);

      // resumo geral
      const totalKg = totalRec + totalRej;
      const recPct = totalKg ? (totalRec/totalKg)*100 : 0;
      const rejPct = totalKg ? (totalRej/totalKg)*100 : 0;

      setText("sumRecKg", fmtPt(totalRec,1));
      setText("sumRejKg", fmtPt(totalRej,1));
      setText("sumTotalKg", fmtPt(totalKg,1));
      setText("sumRecPct", recPct.toFixed(1).replace(".", ",")+"%");
      setText("sumRejPct", rejPct.toFixed(1).replace(".", ",")+"%");

      // receita (ainda n√£o coletamos pre√ßo, ent√£o fica 0)
      setText("sumReceita", fmtPt(0,1));

      // rejeito breakdown (usando: n√£o recicl√°vel = rejeito, n√£o comercializado = totalNaoCom)
      const rejeitoTotal = totalRej + totalNaoCom;
      const pctNaoRec = rejeitoTotal ? (totalRej/rejeitoTotal)*100 : 0;
      const pctNaoCom = rejeitoTotal ? (totalNaoCom/rejeitoTotal)*100 : 0;

      setText("rejNaoRecKg", fmtPt(totalRej,1));
      setText("rejNaoComKg", fmtPt(totalNaoCom,1));
      setText("rejNaoRecPct", pctNaoRec.toFixed(1).replace(".", ",")+"%");
      setText("rejNaoComPct", pctNaoCom.toFixed(1).replace(".", ",")+"%");

      // √≥leo (do final_turno)
      setText("outroKg", fmtPt(materialTotals.oleoKg,1));

      // bolhas
      renderBubbles(materialTotals, totalRec);

      // charts
      drawQualidade(q3, q2, q1);

      // bar series
      const labels = Array.from(perDay.keys()).filter(x=>x!=="sem-data").sort((a,b)=> a.localeCompare(b));
      const recArr = labels.map(d=> perDay.get(d).rec);
      const rejArr = labels.map(d=> perDay.get(d).rej);
      drawBar(labels.map(d=> d.slice(8,10)), rejArr, recArr); // mostra dia do m√™s no eixo

      // planilha
      renderTable(items);
    }

    setDbStatus("conectando‚Ä¶", true);

    onSnapshot(collection(db, "coletasSeletivas"), (snap)=>{
      const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log("üî• coletasSeletivas:", items);

      setDbStatus(`conectado ‚úÖ (${items.length})`, true);
      renderAll(items);
    }, (err)=>{
      console.error(err);
      setDbStatus("erro (rules)", false);
      alert("Erro ao ler Firestore. Publique as regras e verifique permiss√µes.");
    });
  </script>
</body>
</html>