<!doctype html>
<html lang="pt-BR" translate="no">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="pt-BR">
  <meta name="google" content="notranslate">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Ä¢ Coletas Seletivas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            regen: "#1B7F5A",
            regenLight: "#4CAF8F",
            deepBlue: "#0D3B66",
            energy: "#F2C94C",
            graphite: "#2E2E2E",
            grayClean: "#F5F7F6",
          },
          boxShadow: {
            soft: "0 14px 40px rgba(46,46,46,.10)",
            card: "0 10px 26px rgba(13,59,102,.10)"
          }
        }
      }
    }
  </script>

  <style>
    .panel { background: #fff; border: 1px solid rgba(0,0,0,.06); box-shadow: 0 10px 26px rgba(13,59,102,.06); }
    .pill { background: #2ea86d; }
    .pill:hover{ filter: brightness(.97); }
    .dash-grid { grid-template-columns: 320px 1fr; }
    .dashed { border: 2px dashed rgba(0,0,0,.12); }
    .bubble {
      background: #edf6ef;
      border: 1px solid rgba(27,127,90,.12);
      box-shadow: 0 10px 18px rgba(27,127,90,.06);
    }
    .legend-dot { width: 18px; height: 10px; border-radius: 3px; }
    .leaflet-container { border-radius: 14px; }
    .soft-divider { border-top: 1px dashed rgba(0,0,0,.10); }

    /* dropdown */
    .dd { position: relative; }
    .dd-menu {
      position:absolute; top: 46px; left:0;
      background:#fff; border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 14px 40px rgba(13,59,102,.12);
      border-radius: 14px; padding: 10px;
      min-width: 230px;
      z-index: 50;
      display:none;
    }
    .dd.open .dd-menu { display:block; }
    .dd-item { padding:10px 10px; border-radius: 12px; cursor:pointer; font-size: 13px; }
    .dd-item:hover { background: rgba(0,0,0,.04); }
    .dd-label { font-size: 11px; color: rgba(46,46,46,.65); margin-bottom: 6px; }
    .input {
      width: 100%;
      border:1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      outline:none;
    }
    .input:focus{ box-shadow: 0 0 0 4px rgba(27,127,90,.12); border-color: rgba(27,127,90,.35); }
    .btn-clear{
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
    }
    .btn-clear:hover{ background: rgba(0,0,0,.03); }
  </style>
</head>

<body class="bg-grayClean text-graphite">
  <!-- TOP BAR -->
  <header class="bg-white border-b border-black/5">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center gap-3">
      <!-- Brand -->
      <div class="flex items-center gap-3 min-w-[260px]">
        <div class="h-10 w-10 rounded-xl bg-regen/10 flex items-center justify-center border border-regen/15">
          <span class="text-regen font-extrabold">RB</span>
        </div>
        <div class="leading-tight">
          <div class="text-xs text-graphite/70">vila do futuro</div>
          <div class="font-extrabold tracking-tight">RECICLA BONJA</div>
          <div class="text-[11px] text-graphite/55">Sustentabilidade na Quebrada</div>
        </div>
      </div>

      <!-- Pills (Filtros) -->
      <div class="flex-1 flex items-center justify-center gap-3 flex-wrap">
        <!-- DATA -->
        <div class="dd" id="ddData">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            DATA <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">Per√≠odo (opDate)</div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="text-[11px] text-graphite/60 mb-1">De</div>
                <input id="fStart" class="input" type="date">
              </div>
              <div>
                <div class="text-[11px] text-graphite/60 mb-1">At√©</div>
                <input id="fEnd" class="input" type="date">
              </div>
            </div>
            <div class="mt-2 flex gap-2">
              <button class="btn-clear w-full" id="btnApplyDate">Aplicar</button>
              <button class="btn-clear w-full" id="btnClearDate">Limpar</button>
            </div>
          </div>
        </div>

        <!-- M√äS -->
        <div class="dd" id="ddMes">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            M√äS <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">Selecione um m√™s</div>
            <div class="grid grid-cols-2 gap-2">
              <input id="fMonth" class="input" type="month">
              <button class="btn-clear" id="btnApplyMonth">Aplicar</button>
            </div>
            <button class="btn-clear w-full mt-2" id="btnClearMonth">Limpar</button>
          </div>
        </div>

        <!-- CICLO -->
        <div class="dd" id="ddCiclo">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            CICLO <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">Campo: cycle (se existir)</div>
            <input id="fCycle" class="input" placeholder="Ex.: C1, C2, 2026-01...">
            <button class="btn-clear w-full mt-2" id="btnApplyCycle">Aplicar</button>
            <button class="btn-clear w-full mt-2" id="btnClearCycle">Limpar</button>
          </div>
        </div>

        <!-- TIPO -->
        <div class="dd" id="ddTipo">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            TIPO DE COLETA <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">deliveryType</div>
            <div class="dd-item" data-type="">Todos</div>
            <div class="dd-item" data-type="Coleta domiciliar pelo triciclo">Coleta domiciliar pelo triciclo</div>
            <div class="dd-item" data-type="Coleta condom√≠nio">Coleta condom√≠nio</div>
            <div class="dd-item" data-type="Entrega volunt√°ria">Entrega volunt√°ria</div>
            <div class="dd-item" data-type="Coleta Com√©rcio">Coleta Com√©rcio</div>
          </div>
        </div>

        <!-- C√ìDIGO -->
        <div class="dd" id="ddCodigo">
          <button class="pill text-white font-semibold text-sm px-6 py-2 rounded-xl shadow-soft inline-flex items-center gap-2" data-dd-btn>
            C√ìDIGO <span class="text-white/90">‚ñæ</span>
          </button>
          <div class="dd-menu">
            <div class="dd-label">linkedId (RB-xxxxxx / COND-xxxxxx)</div>
            <input id="fCodigo" class="input" placeholder="Ex.: RB-000123">
            <button class="btn-clear w-full mt-2" id="btnApplyCodigo">Aplicar</button>
            <button class="btn-clear w-full mt-2" id="btnClearCodigo">Limpar</button>
          </div>
        </div>

        <!-- limpar tudo -->
        <button class="btn-clear" id="btnClearAll">Limpar filtros</button>
      </div>

      <!-- Right -->
      <div class="min-w-[260px] flex justify-end">
        <div class="text-right">
          <div class="text-xs text-graphite/55">Dashboard ‚Ä¢ Coletas</div>
          <div class="text-[11px] text-graphite/50">Banco: <span id="dbStatus">conectando‚Ä¶</span></div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-[1400px] mx-auto px-4 py-4">
    <div class="grid dash-grid gap-4">
      <!-- LEFT SIDEBAR -->
      <aside class="space-y-4">
        <!-- KPIs -->
        <div class="panel rounded-2xl overflow-hidden">
          <div class="grid grid-cols-2">
            <div class="p-4 bg-regen/15 border-r border-black/5">
              <div class="text-3xl font-extrabold text-graphite" id="kpiDias">‚Äî</div>
              <div class="text-xs text-graphite/70">total de dias do projeto</div>
              <div class="text-[11px] text-graphite/60">In√≠cio: <span class="font-semibold" id="kpiInicio">‚Äî</span></div>
            </div>
            <div class="p-4 bg-regen/10">
              <div class="text-3xl font-extrabold text-graphite" id="kpiOps">‚Äî</div>
              <div class="text-xs text-graphite/70">opera√ß√µes realizadas</div>
              <div class="text-[11px] text-graphite/60">No filtro: <span class="font-semibold" id="kpiOpsFiltro">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Families / Condo -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="font-extrabold text-center">FAM√çLIAS</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">cadastradas</span>
                  <span class="font-bold" id="famCadastradas">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes</span>
                  <span class="font-bold" id="famParticipantes">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="famColetas">‚Äî</span>
                </div>
              </div>
            </div>

            <div class="border-l border-black/10 pl-3">
              <div class="font-extrabold text-center">CONDOM√çNIO</div>
              <div class="mt-3 space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">cadastrados</span>
                  <span class="font-bold" id="condCadastrados">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">participantes</span>
                  <span class="font-bold" id="condParticipantes">‚Äî</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-graphite/70">coletas realizadas</span>
                  <span class="font-bold" id="condColetas">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3 text-[11px] text-graphite/55">
            * Fam√≠lias/Condom√≠nios = baseado no prefixo do linkedId (RB-/COND-) nas coletas.
          </div>
        </div>

        <!-- Map -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">LOCALIZA√á√ÉO</div>
          <div class="mt-3">
            <div id="map" class="w-full h-[360px]"></div>
          </div>
          <div class="mt-2 text-[11px] text-center text-graphite/55">
            * Marcadores = coletas com latitude/longitude (se existirem no doc)
          </div>
        </div>

        <!-- Quality donut -->
        <div class="panel rounded-2xl p-4">
          <div class="font-extrabold text-center text-lg">QUALIDADE DO RES√çDUO</div>
          <div class="mt-4">
            <canvas id="chartQualidade" height="220"></canvas>
            <div class="mt-3 flex items-center justify-center gap-5 text-xs">
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#1B7F5A"></span> LIMPO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#F2C94C"></span> M√âDIO
              </div>
              <div class="flex items-center gap-2">
                <span class="legend-dot" style="background:#EF4444"></span> RUIM
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT CONTENT -->
      <section class="space-y-4">
        <!-- Summary row -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-4 items-stretch">
            <div class="col-span-12 md:col-span-2 flex items-center justify-center font-extrabold text-lg">
              GERAL
            </div>

            <div class="col-span-12 md:col-span-7 border-l border-black/10 pl-4">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-regen/10 border border-regen/15 flex items-center justify-center">
                    ‚ôªÔ∏è
                  </div>
                  <div>
                    <div class="text-xl font-extrabold">
                      <span id="sumRecKg">‚Äî</span> kg <span class="ml-2">RECICL√ÅVEL</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-regen font-extrabold" id="sumRecPct">‚Äî</span> do total
                    </div>
                    <div class="text-sm text-graphite/70">
                      Receita total = <span class="font-extrabold">R$</span> <span class="font-extrabold" id="sumReceita">‚Äî</span>
                    </div>
                  </div>
                </div>

                <div class="hidden md:block w-px bg-black/10"></div>

                <div class="flex items-center gap-3">
                  <div class="h-12 w-12 rounded-2xl bg-red-50 border border-red-100 flex items-center justify-center">
                    üóëÔ∏è
                  </div>
                  <div class="text-right">
                    <div class="text-xl font-extrabold">
                      <span id="sumRejKg">‚Äî</span> kg <span class="ml-2 text-red-600">REJEITO</span>
                    </div>
                    <div class="text-sm text-graphite/70">
                      <span class="text-red-600 font-extrabold" id="sumRejPct">‚Äî</span> do total
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-span-12 md:col-span-3">
              <div class="rounded-2xl bg-grayClean border border-black/10 p-4 h-full">
                <div class="text-xs font-extrabold text-graphite/70">RESUMO</div>
                <div class="mt-2 space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Total (kg)</span>
                    <span class="font-extrabold" id="sumTotalKg">‚Äî</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Opera√ß√µes</span>
                    <span class="font-extrabold" id="sumOps">‚Äî</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-graphite/70">Dias (no filtro)</span>
                    <span class="font-extrabold" id="sumDiasFiltro">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-3 text-[11px] text-center text-graphite/55">
            Dica: preencha filtros acima para ver recortes. Sem filtros, mostra os √∫ltimos 500 registros.
          </div>
        </div>

        <!-- Middle -->
        <div class="grid grid-cols-12 gap-4">
          <!-- Bubbles materials -->
          <div class="col-span-12 lg:col-span-8 panel rounded-2xl p-4">
            <div class="text-center font-extrabold text-lg">TIPO DE MATERIAL RECICL√ÅVEL</div>
            <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total de recicl√°veis)</div>

            <div id="bubblesGrid" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
              <!-- JS preenche bolhas -->
            </div>
          </div>

          <!-- Right reject types -->
          <div class="col-span-12 lg:col-span-4 space-y-4">
            <div class="panel rounded-2xl p-4">
              <div class="text-center font-extrabold text-lg">TIPO DE REJEITO</div>
              <div class="text-center text-xs text-graphite/60 mt-1">(% sobre o total do rejeito)</div>

              <div class="mt-4 space-y-4">
                <div class="rounded-2xl bg-red-50 border border-red-100 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üêÄ</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoRecPct">‚Äî</div>
                  <div class="text-sm font-extrabold">N√ÉO RECICL√ÅVEL</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoRecKg">‚Äî</span> kg</div>
                </div>

                <div class="rounded-2xl bg-white border border-black/10 p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-3xl">üö´üí∞</div>
                  <div class="text-3xl font-extrabold text-red-600" id="rejNaoComPct">‚Äî</div>
                  <div class="text-sm font-extrabold">N√ÉO COMERCIALIZADO</div>
                  <div class="text-sm text-graphite/70"><span id="rejNaoComKg">‚Äî</span> kg</div>
                </div>
              </div>
            </div>

            <div class="panel rounded-2xl p-4 dashed">
              <div class="text-center font-extrabold">OUTRO</div>
              <div class="mt-3 flex items-center justify-center text-5xl">üß¥</div>
              <div class="mt-2 text-center">
                <div class="text-3xl font-extrabold" id="outroKg">‚Äî</div>
                <div class="text-xs text-graphite/70">kg</div>
                <div class="mt-2 text-sm font-extrabold" id="outroLabel">√ìLEO DE COZINHA</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom chart -->
        <div class="panel rounded-2xl p-4">
          <div class="flex items-center gap-6 text-sm justify-center">
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#EF4444"></span> Peso do rejeito
            </div>
            <div class="flex items-center gap-2">
              <span class="legend-dot" style="background:#22C55E"></span> Peso do Recicl√°vel
            </div>
          </div>

          <div class="mt-3">
            <canvas id="chartBar" height="120"></canvas>
          </div>
          <div class="soft-divider mt-3 pt-2 text-xs text-center text-graphite/60">
            Participantes √∫nicos (no per√≠odo): <span id="uniqParticipants">‚Äî</span>
          </div>
        </div>

        <!-- Table -->
        <div class="panel rounded-2xl p-4">
          <div class="grid grid-cols-12 gap-3 text-xs font-extrabold text-graphite/70 pb-2 border-b border-black/10">
            <div class="col-span-1">C√≥digo</div>
            <div class="col-span-2">Tipo de material recicl√°vel</div>
            <div class="col-span-2">Data de coleta</div>
            <div class="col-span-2">Qualidade</div>
            <div class="col-span-3">Observa√ß√£o</div>
            <div class="col-span-1 text-right">N√£o recicl√°vel (kg)</div>
            <div class="col-span-1 text-right">N√£o comercializado (kg)</div>
          </div>

          <div id="rows" class="divide-y divide-black/5 text-sm">
            <!-- JS preenche -->
          </div>

          <div class="mt-3 text-[11px] text-right text-graphite/50">
            Desenvolvido por voc√™ ‚Ä¢ Hub Resili√™ncia Clim√°tica
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===========================
       FIREBASE + DASHBOARD LOGIC
       =========================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===========================
    // CONFIG
    // ===========================
     const firebaseConfig = {
  apiKey: "AIzaSyAe5E7M8Jednj1xGRjNrV0oD4wQwv6b-WM",
  authDomain: "reciclabonja-3dee7.firebaseapp.com",
  projectId: "reciclabonja-3dee7",
  storageBucket: "reciclabonja-3dee7.firebasestorage.app",
  messagingSenderId: "590941010829",
  appId: "1:590941010829:web:9b8e4703df54cc8b0a9bc4"
};

    const PROJECT_START = "2026-01-01"; // ajuste quando quiser (YYYY-MM-DD)

    // Mapeamento de materiais (do seu formul√°rio "final do turno")
    const MATERIAL_FIELDS = [
      { key:"PL√ÅSTICO", field:"plasticoKg", icon:"üß¥", receitaField:"plasticoReceita" },
      { key:"VIDRO", field:"vidroKg", icon:"üçæ", receitaField:"vidroReceita" },
      { key:"ALUM√çNIO/METAL", field:"aluminioMetalKg", icon:"ü•´", receitaField:"metalReceita" },
      { key:"SACARIA/SACOLINHA", field:"sacariaKg", icon:"üõçÔ∏è", receitaField:"sacariaReceita" },
      { key:"PAPEL MISTO", field:"papelMistoKg", icon:"üìÑ", receitaField:"papelMistoReceita" },
      { key:"PAPEL√ÉO", field:"papelaoKg", icon:"üì¶", receitaField:"papelaoReceita" },
      { key:"ISOPOR", field:"isoporKg", icon:"üç±", receitaField:"isoporReceita" },
      { key:"√ìLEO", field:"oleoKg", icon:"üß¥", receitaField:"oleoReceita" },
    ];

    // ===========================
    // INIT FIREBASE
    // ===========================
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const fmtPt = (n, dec=1) => (Number(n)||0).toLocaleString("pt-BR", {minimumFractionDigits: dec, maximumFractionDigits: dec});

    function setDbStatus(txt, ok=true){
      const el = $("dbStatus");
      el.textContent = txt;
      el.className = ok ? "text-regen font-semibold" : "text-red-600 font-semibold";
    }

    function toDateKey(d){
      // Date -> YYYY-MM-DD local
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function parseYYYYMMDD(s){
      // assume "YYYY-MM-DD"
      if(!s || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
      const [y,m,d] = s.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function daysBetween(aStr, bStr){
      const a = parseYYYYMMDD(aStr);
      const b = parseYYYYMMDD(bStr);
      if(!a || !b) return 0;
      const ms = (b.getTime() - a.getTime());
      return Math.max(0, Math.floor(ms / (1000*60*60*24)) + 1);
    }

    // ===========================
    // DROPDOWNS
    // ===========================
    function initDropdowns(){
      document.querySelectorAll("[data-dd-btn]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const parent = btn.closest(".dd");
          document.querySelectorAll(".dd").forEach(d => { if(d !== parent) d.classList.remove("open"); });
          parent.classList.toggle("open");
        });
      });
      document.addEventListener("click", ()=> document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open")));
    }

    // ===========================
    // FILTER STATE
    // ===========================
    const filterState = {
      start: "",    // YYYY-MM-DD
      end: "",      // YYYY-MM-DD
      month: "",    // YYYY-MM
      cycle: "",    // string
      type: "",     // deliveryType
      codigo: ""    // linkedId
    };

    function syncFilterInputs(){
      $("fStart").value = filterState.start || "";
      $("fEnd").value = filterState.end || "";
      $("fMonth").value = filterState.month || "";
      $("fCycle").value = filterState.cycle || "";
      $("fCodigo").value = filterState.codigo || "";
    }

    function clearDate(){
      filterState.start = "";
      filterState.end = "";
    }
    function clearMonth(){ filterState.month = ""; }
    function clearCycle(){ filterState.cycle = ""; }
    function clearType(){ filterState.type = ""; }
    function clearCodigo(){ filterState.codigo = ""; }

    // ===========================
    // FETCH COLETAS (Firestore)
    // ===========================
    async function fetchColetas(){
      // Estrat√©gia:
      // - Sempre limitamos para n√£o travar: 500 docs.
      // - Se tiver filtro de data: usa opDate >= start e <= end (string YYYY-MM-DD)
      // - Se tiver month: define start/end do m√™s
      // - Se tiver type/codigo/cycle: adiciona where
      // Obs: Firestore pode exigir √≠ndices compostos dependendo dos filtros.
      let start = filterState.start;
      let end = filterState.end;

      if(filterState.month){
        const [y,m] = filterState.month.split("-").map(Number);
        const first = new Date(y, m-1, 1);
        const last = new Date(y, m, 0);
        start = toDateKey(first);
        end = toDateKey(last);
      }

      const ref = collection(db, "coletasSeletivas");
      const clauses = [];

      // where date
      if(start) clauses.push(where("opDate", ">=", start));
      if(end) clauses.push(where("opDate", "<=", end));

      // other filters
      if(filterState.type) clauses.push(where("deliveryType", "==", filterState.type));
      if(filterState.codigo) clauses.push(where("linkedId", "==", filterState.codigo));
      if(filterState.cycle) clauses.push(where("cycle", "==", filterState.cycle)); // se voc√™ n√£o usa "cycle", pode remover

      // orderBy (necess√°rio se usar range)
      // opDate √© string YYYY-MM-DD => ordena bem
      clauses.push(orderBy("opDate", "desc"));

      // limit
      clauses.push(limit(500));

      const q = query(ref, ...clauses);
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // ===========================
    // AGGREGATION
    // ===========================
    function sumNum(v){ return (typeof v === "number" && isFinite(v)) ? v : 0; }

    function qualityBucket(v){
      // seu form: "1 2 3" (sujo -> limpo). Tamb√©m pode vir "SUJO/LIMPO".
      if(v == null) return "medio";
      if(typeof v === "number"){
        if(v >= 3) return "limpo";
        if(v <= 1) return "ruim";
        return "medio";
      }
      const s = String(v).toLowerCase();
      if(s.includes("limpo") || s === "3") return "limpo";
      if(s.includes("sujo") || s === "1") return "ruim";
      if(s === "2") return "medio";
      return "medio";
    }

    function buildDashboardFromColetas(coletas){
      // Considera dois tipos:
      // - flowType == "recebimento": usa pesoResiduoSecoKg / pesoRejeitoKg / pesoNaoComercializadoKg + qualidade + observa√ß√£o
      // - flowType == "final_turno": usa materiais (plasticoKg, papelMistoKg, etc) + pesoRejeitoGeralKg + oleoKg
      // Materiais:
      //  - Para "recicl√°vel" usaremos soma de MATERIAL_FIELDS (exceto oleo? aqui inclui, mas tamb√©m exibimos em "OUTRO")
      // Rejeitos:
      //  - n√£o recicl√°vel = pesoRejeitoKg (recebimento) + pesoRejeitoGeralKg (final_turno)
      //  - n√£o comercializado = pesoNaoComercializadoKg (recebimento)
      // OUTRO:
      //  - √≥leo = oleoKg (final_turno) ou outro campo que voc√™ colocar

      const today = toDateKey(new Date());
      const diasProjeto = daysBetween(PROJECT_START, today);

      // KPIs baseados em coletas + linkedId
      const ops = coletas.length;

      const uniqRB = new Set();
      const uniqCOND = new Set();
      const uniqAll = new Set();

      let recKg = 0;
      let rejKg = 0;
      let naoRecKg = 0;
      let naoComKg = 0;
      let outroKg = 0; // √≥leo

      const quality = { limpo:0, medio:0, ruim:0 };

      // por dia (para o gr√°fico)
      const byDay = new Map(); // day -> {rec, rej}

      // materiais (bolhas): soma kg por material
      const matSum = new Map(); // key -> kg

      // tabela: vamos listar as √∫ltimas 30 coletas "recebimento" (faz mais sentido)
      const tableRows = [];

      // map points: coletas com lat/lng (se existirem)
      const mapPoints = [];

      for(const c of coletas){
        const linkedId = (c.linkedId || "").trim();
        if(linkedId){
          uniqAll.add(linkedId);
          if(linkedId.startsWith("RB-")) uniqRB.add(linkedId);
          if(linkedId.startsWith("COND-")) uniqCOND.add(linkedId);
        }

        const dateKey = (c.opDate && /^\d{4}-\d{2}-\d{2}$/.test(c.opDate)) ? c.opDate : null;
        if(dateKey && !byDay.has(dateKey)) byDay.set(dateKey, { rec:0, rej:0 });

        // mapa
        if(typeof c.lat === "number" && typeof c.lng === "number"){
          mapPoints.push({ lat:c.lat, lng:c.lng, label: linkedId ? `Coleta ${linkedId}` : "Coleta" });
        } else if(c.location && typeof c.location.lat === "number" && typeof c.location.lng === "number"){
          mapPoints.push({ lat:c.location.lat, lng:c.location.lng, label: linkedId ? `Coleta ${linkedId}` : "Coleta" });
        }

        if(c.flowType === "recebimento"){
          const r = sumNum(c.pesoResiduoSecoKg);
          const rej = sumNum(c.pesoRejeitoKg);
          const nc = sumNum(c.pesoNaoComercializadoKg);

          recKg += r;
          rejKg += (rej + nc);

          naoRecKg += rej;
          naoComKg += nc;

          // qualidade
          const qb = qualityBucket(c.qualidadeNota ?? c.qualidade ?? c.qualidadeResiduo);
          quality[qb]++;

          // series by day
          if(dateKey){
            const d = byDay.get(dateKey);
            d.rec += r;
            d.rej += (rej + nc);
          }

          // tabela (√∫ltimas)
          tableRows.push({
            codigo: linkedId || "",
            tipo: c.deliveryType || "‚Äî",
            data: dateKey ? dateKey.split("-").reverse().join("/") : "‚Äî",
            qualidade: qb.toUpperCase(),
            obs: (c.observacao || c.obs || "").toString().slice(0, 80) || "‚Äî",
            naoRec: fmtPt(rej,1),
            naoCom: fmtPt(nc,1)
          });

        } else if(c.flowType === "final_turno"){
          // soma materiais
          let recTurno = 0;
          for(const m of MATERIAL_FIELDS){
            const kg = sumNum(c[m.field]);
            if(kg > 0){
              matSum.set(m.key, (matSum.get(m.key)||0) + kg);
              recTurno += kg;
            }
          }

          // √≥leo como OUTRO (al√©m de entrar no recTurno se voc√™ quiser)
          const oleo = sumNum(c.oleoKg);
          outroKg += oleo;

          const rejGeral = sumNum(c.pesoRejeitoGeralKg);
          naoRecKg += rejGeral;
          rejKg += rejGeral;
          recKg += recTurno;

          if(dateKey){
            const d = byDay.get(dateKey);
            d.rec += recTurno;
            d.rej += rejGeral;
          }
        }
      }

      // materiais: completar com zero para todos
      const materials = MATERIAL_FIELDS
        .filter(m => m.key !== "√ìLEO") // √≥leo fica no card OUTRO
        .map(m => ({ ...m, kg: matSum.get(m.key)||0 }))
        .filter(m => m.kg > 0);

      const total = recKg + rejKg;
      const recPct = total ? (recKg/total)*100 : 0;
      const rejPct = total ? (rejKg/total)*100 : 0;

      const rejTotal = (naoRecKg + naoComKg);
      const naoRecPct = rejTotal ? (naoRecKg/rejTotal)*100 : 0;
      const naoComPct = rejTotal ? (naoComKg/rejTotal)*100 : 0;

      // bolhas: percentual do total recicl√°vel (sem √≥leo)
      const totalMat = materials.reduce((a,m)=>a+m.kg,0) || 1;
      const bubbles = materials
        .sort((a,b)=>b.kg - a.kg)
        .slice(0, 9)
        .map(m => ({
          key: m.key,
          icon: m.icon,
          kg: m.kg,
          pct: (m.kg/totalMat)*100,
          receita: 0 // se voc√™ tiver receita por material, preenche aqui
        }));

      // series: ordenar dias asc
      const days = Array.from(byDay.keys()).sort();
      const labels = days.map((d, i)=> String(i+1));
      const reciclavel = days.map(d => +(byDay.get(d).rec.toFixed(2)));
      const rejeito = days.map(d => +(byDay.get(d).rej.toFixed(2)));

      return {
        kpis: {
          diasProjeto,
          inicio: PROJECT_START,
          opsTotal: ops,
          famCadastradas: uniqRB.size, // aproximado pelo que apareceu em coletas
          famParticipantes: uniqRB.size,
          famColetas: coletas.filter(c => (c.linkedId||"").startsWith("RB-")).length,
          condCadastrados: uniqCOND.size,
          condParticipantes: uniqCOND.size,
          condColetas: coletas.filter(c => (c.linkedId||"").startsWith("COND-")).length
        },
        summary: { recKg, rejKg, receita: 0, totalKg: total, recPct, rejPct, ops, diasFiltro: days.length },
        rejectBreakdown: { naoRecKg, naoRecPct, naoComKg, naoComPct, outroKg },
        qualidade: {
          limpo: quality.limpo,
          medio: quality.medio,
          ruim: quality.ruim
        },
        bubbles,
        series: { labels, reciclavel, rejeito },
        table: tableRows.slice(0, 40),
        uniqParticipants: uniqAll.size,
        mapPoints
      };
    }

    // ===========================
    // RENDERERS
    // ===========================
    function setText(id, v){ const el = $(id); if(el) el.textContent = v; }

    function renderKpis(d){
      setText("kpiDias", d.kpis.diasProjeto);
      setText("kpiInicio", d.kpis.inicio.split("-").reverse().join("/"));
      setText("kpiOps", d.kpis.opsTotal);
      setText("kpiOpsFiltro", d.summary.ops);

      setText("famCadastradas", d.kpis.famCadastradas);
      setText("famParticipantes", d.kpis.famParticipantes);
      setText("famColetas", d.kpis.famColetas);

      setText("condCadastrados", d.kpis.condCadastrados);
      setText("condParticipantes", d.kpis.condParticipantes);
      setText("condColetas", d.kpis.condColetas);
    }

    function renderSummary(d){
      setText("sumRecKg", fmtPt(d.summary.recKg, 1));
      setText("sumRejKg", fmtPt(d.summary.rejKg, 1));
      setText("sumReceita", fmtPt(d.summary.receita, 1));
      setText("sumTotalKg", fmtPt(d.summary.totalKg, 1));
      setText("sumOps", d.summary.ops);
      setText("sumDiasFiltro", d.summary.diasFiltro || 0);

      setText("sumRecPct", d.summary.recPct.toFixed(1).replace(".", ",") + "%");
      setText("sumRejPct", d.summary.rejPct.toFixed(1).replace(".", ",") + "%");

      setText("rejNaoRecPct", d.rejectBreakdown.naoRecPct.toFixed(1).replace(".", ",") + "%");
      setText("rejNaoRecKg", fmtPt(d.rejectBreakdown.naoRecKg, 1));
      setText("rejNaoComPct", d.rejectBreakdown.naoComPct.toFixed(1).replace(".", ",") + "%");
      setText("rejNaoComKg", fmtPt(d.rejectBreakdown.naoComKg, 1));

      setText("outroKg", fmtPt(d.rejectBreakdown.outroKg, 1));
      setText("outroLabel", "√ìLEO DE COZINHA");
      setText("uniqParticipants", d.uniqParticipants);
    }

    function renderBubbles(d){
      const grid = $("bubblesGrid");
      grid.innerHTML = "";

      if(!d.bubbles.length){
        const empty = document.createElement("div");
        empty.className = "col-span-2 md:col-span-3 rounded-2xl border border-black/10 bg-grayClean p-6 text-center text-sm text-graphite/70";
        empty.innerHTML = "Sem materiais (final do turno) no per√≠odo selecionado.";
        grid.appendChild(empty);
        return;
      }

      d.bubbles.forEach(m=>{
        const el = document.createElement("div");
        el.className = "bubble rounded-full p-4 md:p-5 flex flex-col items-center justify-center text-center min-h-[150px]";
        el.innerHTML = `
          <div class="text-3xl">${m.icon}</div>
          <div class="mt-1 text-2xl font-extrabold">${m.pct.toFixed(1).replace(".", ",")}%</div>
          <div class="text-sm text-graphite/70">${fmtPt(m.kg,1)} kg</div>
          <div class="text-[11px] text-graphite/60 mt-1">Receita = <span class="font-bold">R$ ${fmtPt(m.receita,1)}</span></div>
          <div class="mt-2 text-xs font-extrabold">${m.key}</div>
        `;
        grid.appendChild(el);
      });
    }

    function renderTable(d){
      const wrap = $("rows");
      wrap.innerHTML = "";

      if(!d.table.length){
        const row = document.createElement("div");
        row.className = "py-6 text-center text-sm text-graphite/60";
        row.textContent = "Nenhuma coleta encontrada para os filtros selecionados.";
        wrap.appendChild(row);
        return;
      }

      d.table.forEach(r=>{
        const row = document.createElement("div");
        row.className = "grid grid-cols-12 gap-3 py-2 text-xs";
        row.innerHTML = `
          <div class="col-span-1 font-semibold">${r.codigo || ""}</div>
          <div class="col-span-2">${r.tipo}</div>
          <div class="col-span-2">${r.data}</div>
          <div class="col-span-2 font-semibold">${r.qualidade}</div>
          <div class="col-span-3 text-graphite/70">${r.obs}</div>
          <div class="col-span-1 text-right">${r.naoRec}</div>
          <div class="col-span-1 text-right">${r.naoCom}</div>
        `;
        wrap.appendChild(row);
      });
    }

    // ===========================
    // CHARTS
    // ===========================
    let chartQualidade, chartBar;

    function drawQualidade(d){
      if(chartQualidade) chartQualidade.destroy();
      const ctx = $("chartQualidade");
      chartQualidade = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["LIMPO", "M√âDIO", "RUIM"],
          datasets: [{
            data: [d.qualidade.limpo, d.qualidade.medio, d.qualidade.ruim],
            backgroundColor: ["#1B7F5A", "#F2C94C", "#EF4444"],
            borderWidth: 0
          }]
        },
        options: {
          cutout: "70%",
          plugins: { legend: { display:false }, tooltip: { enabled:true } }
        }
      });
    }

    function drawBar(d){
      if(chartBar) chartBar.destroy();
      const ctx = $("chartBar");
      chartBar = new Chart(ctx, {
        type: "bar",
        data: {
          labels: d.series.labels,
          datasets: [
            { label: "Peso do rejeito", data: d.series.rejeito, backgroundColor: "#EF4444", stack: "stack1", borderWidth: 0 },
            { label: "Peso do recicl√°vel", data: d.series.reciclavel, backgroundColor: "#22C55E", stack: "stack1", borderWidth: 0 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: {
            x: { stacked:true, grid: { display:false }, ticks: { maxRotation:0, autoSkip:true, maxTicksLimit:18, font:{size:10} } },
            y: { stacked:true, grid: { color: "rgba(0,0,0,.06)" }, ticks: { font:{size:10} } }
          }
        }
      });
    }

    // ===========================
    // MAP
    // ===========================
    let map, layer;
    function initMap(){
      map = L.map('map', { zoomControl: true }).setView([-30.0346, -51.2177], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      layer = L.layerGroup().addTo(map);
    }

    function renderMap(points){
      if(!layer) return;
      layer.clearLayers();

      if(!points.length){
        // sem pontos: mant√©m view default
        return;
      }

      const bounds = [];
      points.slice(0, 200).forEach(p=>{
        const marker = L.circleMarker([p.lat, p.lng], {
          radius: 7,
          color: "#1B7F5A",
          fillColor: "#4CAF8F",
          fillOpacity: 0.9,
          weight: 2
        }).addTo(layer).bindPopup(p.label || "Coleta");
        bounds.push([p.lat, p.lng]);
      });

      if(bounds.length){
        map.fitBounds(bounds, { padding: [18,18] });
      }
    }

    // ===========================
    // MAIN LOAD
    // ===========================
    async function reload(){
      setDbStatus("carregando‚Ä¶", true);

      try{
        const coletas = await fetchColetas();
        setDbStatus(`ok ‚Ä¢ ${coletas.length} registros`, true);

        const dash = buildDashboardFromColetas(coletas);
        renderKpis(dash);
        renderSummary(dash);
        renderBubbles(dash);
        renderTable(dash);
        drawQualidade(dash);
        drawBar(dash);
        renderMap(dash.mapPoints);

      }catch(err){
        console.error(err);
        setDbStatus("erro (rules / √≠ndice)", false);

        // fallback UI
        renderBubbles({ bubbles: [] });
        renderTable({ table: [] });
      }
    }

    // ===========================
    // FILTER EVENTS
    // ===========================
    function wireFilters(){
      // date
      $("btnApplyDate").addEventListener("click", ()=>{
        filterState.start = $("fStart").value || "";
        filterState.end = $("fEnd").value || "";
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });
      $("btnClearDate").addEventListener("click", ()=>{
        clearDate(); syncFilterInputs();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });

      // month
      $("btnApplyMonth").addEventListener("click", ()=>{
        filterState.month = $("fMonth").value || "";
        // se usar month, zera date range manual para evitar conflito visual
        clearDate(); syncFilterInputs();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });
      $("btnClearMonth").addEventListener("click", ()=>{
        clearMonth(); syncFilterInputs();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });

      // cycle
      $("btnApplyCycle").addEventListener("click", ()=>{
        filterState.cycle = ($("fCycle").value || "").trim();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });
      $("btnClearCycle").addEventListener("click", ()=>{
        clearCycle(); syncFilterInputs();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });

      // type items
      document.querySelectorAll("#ddTipo .dd-item").forEach(item=>{
        item.addEventListener("click", ()=>{
          filterState.type = item.getAttribute("data-type") || "";
          document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
          reload();
        });
      });

      // codigo
      $("btnApplyCodigo").addEventListener("click", ()=>{
        filterState.codigo = ($("fCodigo").value || "").trim().toUpperCase();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });
      $("btnClearCodigo").addEventListener("click", ()=>{
        clearCodigo(); syncFilterInputs();
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
        reload();
      });

      // clear all
      $("btnClearAll").addEventListener("click", ()=>{
        clearDate(); clearMonth(); clearCycle(); clearType(); clearCodigo();
        syncFilterInputs();
        reload();
      });
    }

    // ===========================
    // Boot
    // ===========================
    setDbStatus("conectado ‚úÖ", true);
    initDropdowns();
    initMap();
    wireFilters();
    syncFilterInputs();

    // inicial: sem filtros, pega √∫ltimos 500
    reload();

  </script>
</body>
</html>